"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["5949"],{984321:function(e,t,r){e.exports=r.p+"static/assets/algorithmConfig.7ecf986e.json"},322568:function(e,t,r){e.exports=r.p+"static/area_locked.4523e7fe.zip"},848094:function(e,t,r){e.exports=r.p+"static/audio_metrics_v1.4.f662d155.model"},984337:function(e,t,r){e.exports=r.p+"static/default_font.93fbb512.zip"},182982:function(e,t,r){e.exports=r.p+"static/en.ttf.2c3ec87c.zip"},816762:function(e,t,r){e.exports=r.p+"static/ja.ttf.afc83ac8.zip"},500492:function(e,t,r){e.exports=r.p+"static/ko.ttf.a5d04d2c.zip"},994800:function(e,t,r){e.exports=r.p+"static/makeup-root.7816b40a.zip"},980329:function(e,t,r){e.exports=r.p+"static/matting_blend.e67c6f14.zip"},140059:function(e,t,r){e.exports=r.p+"static/minority_languages.66c53edf.zip"},491466:function(e,t,r){e.exports=r.p+"static/rnnoise_v2.0.ba4e9143.model"},172053:function(e,t,r){e.exports=r.p+"static/th.ttf.e02e31eb.zip"},882398:function(e,t,r){e.exports=r.p+"static/zh-hans.ttf.0768bf3a.zip"},517295:function(e,t,r){e.exports=r.p+"static/zh-hant.ttf.440eba7c.zip"},307926:function(e,t,r){e.exports=r.p+"static/font/NotoColorEmoji-git.4b3a1492.ttf"},419608:function(e,t,r){r.d(t,{j:function(){return l}});var a=r(876826),i=r(218571),n=r(233307),s=r(426473),o=r(816258),d=r(66003);function l(e){var{tokenKey:t,srcKey:r,src:l,decryptUrl:u,allowToLoaded:c=!0,needResDecrypt:h=!1}=e,p=(0,d.G)(n.tx),[_,f]=(0,i.useState)(c),[v,g]=(0,i.useState)(!1),[m,y]=(0,i.useState)(!1),[S,M]=(0,i.useState)(u),[T,k]=(0,i.useState)(0),I=()=>{if(!!l)return new Promise((e,i)=>{var d=(0,s.Y)({tokenKey:t,decryptKey:r}),u=p.download({key:d,decryptHash:null!=r?r:"",uniqueId:d,url:l},{downloadType:n._5.Eager});u.onSuccess((0,a._)(function*(){var{buffer:t,contentType:a}=u.value,i=new Blob([r?yield(0,o.Z)(t,r):t],{type:a||"image/*"});k(i.size),M(window.URL.createObjectURL(i)),g(!1),e()})),u.onFail(e=>{g(!1),y(!0),i(Error("decode cover url failure:".concat(e.code,"-").concat(e.msg)))})})};return((0,i.useEffect)(()=>{if(!!h)I()},[l]),(0,i.useEffect)(()=>{if(!!_&&!S)r&&!v&&(g(!0),I())},[_,S,l]),(0,i.useEffect)(()=>{if(!!c&&!_)c&&f(!0)},[c]),r)?{imgSrc:S,isLoadFailure:m,isLoading:v,imageSize:T}:{imgSrc:u||l,isLoadFailure:!1,isLoading:!1,imageSize:T}}},910911:function(e,t,r){r.d(t,{c:()=>g});var a=r("876826"),i=r("85728"),n=r("789786"),s=r("584072"),o=r("836413"),d=r("56935"),l=r("157515"),u=r("165991"),c=r("936226"),h="324442",p="".concat("b").concat("y").concat("t","ed"),_="".concat("c").concat("a").concat("p").concat("c").concat("u").concat("t","api"),f="".concat("b").concat("y").concat("t","evcloudapi"),v=()=>{var e,t,r,a,i,n,s,o;return(null===(t=window.__locationInfo)||void 0===t?void 0:null===(e=t.domain)||void 0===e?void 0:e.web_domain).includes("commercepro.capcut.com")||(null===(a=window.__locationInfo)||void 0===a?void 0:null===(r=a.domain)||void 0===r?void 0:r.web_domain).includes("pippit.capcut.com")?(null===(o=window.__locationInfo)||void 0===o?void 0:o.web_idc)==="maliva":null===(s=window.__locationInfo)||void 0===s?void 0:null===(n=s.domain)||void 0===n?void 0:null===(i=n.web_domain)||void 0===i?void 0:i.includes("https://edit-api-va.capcut.com")};class g{uploadPhoto(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.W.BrandPhoto,r=this;return(0,a._)(function*(){var a=yield r._getOrCreateUploader(t);if(!a.ok)return a;var i=a.value,n=r._convertSTSToken(r._uploadMap.get(t).uploadToken),s=i.addFile({file:e,stsToken:n,type:"image"});return i.start(s),new Promise((e,a)=>{i.on("complete",t=>{var r,a,i,n,d,{key:l,uploadResult:u}=t;if(l===s)e((0,o.oW)({uri:null!==(r=u.Uri)&&void 0!==r?r:"",width:null!==(a=u.ImageWidth)&&void 0!==a?a:0,height:null!==(i=u.ImageHeight)&&void 0!==i?i:0,md5:null!==(n=u.ImageMd5)&&void 0!==n?n:"",fileName:null!==(d=u.FileName)&&void 0!==d?d:""}))});var n=0;null==i||i.on("error",i=>{if(i.extra&&(100026===i.extra.errorCode||100028===i.extra.errorCode)){if(n<1)n++,r._refreshUploadToken(t);else{var s;n=0,e((0,o.wf)(null!==(s=i.extra.errorCode)&&void 0!==s?s:-1,i.extra.message))}}a(i)})})})()}uploadVideo(e){var t=this;return(0,a._)(function*(){var r=yield t._getOrCreateUploader(l.W.Video);if(!r.ok)return r;var a=r.value,i=t._convertSTSToken(t._uploadMap.get(l.W.Video).uploadToken),n=a.addFile({file:e,stsToken:i,type:"video"});return a.start(n),new Promise(e=>{a.on("complete",t=>{var r,a,i,s,d,l,u,c,h,p,_,{key:f,uploadResult:v}=t;if(f===n)e((0,o.oW)({vid:null!==(l=v.Vid)&&void 0!==l?l:"",uri:null!==(u=null===(r=v.VideoMeta)||void 0===r?void 0:r.Uri)&&void 0!==u?u:"",width:null!==(c=null===(a=v.VideoMeta)||void 0===a?void 0:a.Width)&&void 0!==c?c:0,height:null!==(h=null===(i=v.VideoMeta)||void 0===i?void 0:i.Height)&&void 0!==h?h:0,duration:null!==(p=null===(s=v.VideoMeta)||void 0===s?void 0:s.Duration)&&void 0!==p?p:0,md5:null!==(_=null===(d=v.VideoMeta)||void 0===d?void 0:d.Md5)&&void 0!==_?_:""}))});var r=0;null==a||a.on("error",a=>{if(a.extra&&100026===a.extra.errorCode){if(r<1)r++,t._refreshUploadToken(l.W.Video);else{var i;r=0,e((0,o.wf)(null!==(i=a.extra.errorCode)&&void 0!==i?i:-1,a.extra.message))}}})})})()}uploadNormalFile(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.W.BrandFile,r=this;return(0,a._)(function*(){var a=yield r._getOrCreateUploader(t);if(!a.ok)return a;var i=a.value,n=r._convertSTSToken(r._uploadMap.get(t).uploadToken),s=i.addFile({file:e,stsToken:n,type:"object"});return i.start(s),new Promise(e=>{i.on("complete",t=>{var r,a,{key:i,uploadResult:n}=t;if(i===s)e((0,o.oW)({uri:null!==(a=n.Uri)&&void 0!==a?a:"",md5:null===(r=n.ObjectMeta)||void 0===r?void 0:r.Md5}))});var a=0;null==i||i.on("error",i=>{if(i.key===s){if(i.extra&&100026===i.extra.errorCode){if(a<1)a++,r._refreshUploadToken(t);else{var n;a=0,e((0,o.wf)(null!==(n=i.extra.errorCode)&&void 0!==n?n:-1,i.extra.message))}}}})})})()}_getOrCreateUploader(e){var t=this;return(0,a._)(function*(){var a,n=t._uploadMap.get(e);if(null==n?void 0:n.defer)return n.defer.promise;n={defer:(0,s.PQ)()},t._uploadMap.set(e,n);var d=yield t._heycanUploadDataService.getUploadToken({scene:e});if(!d.ok)return null==n||n.defer.resolve(d),t._uploadMap.delete(e),d;a=(yield r.e("7163").then(r.t.bind(r,594631,23))).default;var l=(0,o.oW)(new a((0,i._)({userId:t._capcutAccountService.uniqueId,appId:Number(h),region:d.value.region,imageConfig:{serviceId:d.value.spaceName},logDomain:void 0,videoConfig:{spaceName:d.value.spaceName}},function(e){var{region:t}=e,r={imageHost:"",videoHost:"",videoFallbackHost:"",imageFallbackHost:""};return"boei18n"===t?(r.videoHost="https://vas-".concat("b","oei18n.").concat(p,"ance.net"),r.imageHost="https://vas-".concat("b","oei18n.").concat(p,"ance.net"),r):v()?(r.videoHost="https://vod-us-east-1.".concat(f,".com"),r.imageHost="https://imagex-va.".concat(_,".com"),r.videoFallbackHost="https://open-us-east-1.".concat(f,".com"),r.imageFallbackHost="https://open-us-east-1.".concat(f,".com"),r):["us","us-east-1","gcp","ap-singapore-1","sg","US-TTP"].includes(t)?(r.videoHost="https://vod-normal-sg.capcutapi.com",r.imageHost="https://imagex-normal-sg.capcutapi.com",r.videoFallbackHost="https://vod-normal-sg.capcutapi.com",r.imageFallbackHost="https://imagex-normal-sg.capcutapi.com",r):(r.videoHost="https://vod.".concat(p,"anceapi.com"),r.imageHost="https://imagex.".concat(p,"anceapi.com"),r.videoFallbackHost="https://vas-lf-x.".concat("s","ns").concat("s","dk.com"),r.imageFallbackHost="https://open.".concat(p,"anceapi.com"),r)}({region:d.value.region}))));return t._uploadMap.set(e,{defer:n.defer,uploadToken:d.value}),null==n||n.defer.resolve(l),l})()}_refreshUploadToken(e){var t=this;return(0,a._)(function*(){var r=t._uploadMap.get(e),a=yield r.defer.promise;(0,d.Y2)(a.ok);var i=yield t._heycanUploadDataService.getUploadToken({scene:e});if(!!i.ok){r.uploadToken=i.value;var n=t._convertSTSToken(r.uploadToken);t._uploadMap.set(e,r),a.value.refreshSTSToken(n),a.value.start()}})()}_convertSTSToken(e){return{AccessKeyId:e.accessKeyId,SecretAccessKey:e.secretAccessKey,SessionToken:e.sessionToken,ExpiredTime:e.expiredTime,CurrentTime:e.currentTime}}constructor(e,t){this._capcutAccountService=e,this._heycanUploadDataService=t,this._uploadMap=new Map}}g=(0,n.gn)([(0,n.fM)(0,c.Gw),(0,n.fM)(1,u.x),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",[void 0===c.Gw?Object:c.Gw,void 0===u.x?Object:u.x])],g)},22664:function(e,t,r){r.d(t,{K:()=>F});var a,i=r("876826"),n=r("85728"),s=r("929753"),o=r("789786"),d=r("671381"),l=r("894412"),u=r("836413"),c=r("184046"),h=r("529227"),p=r("930838"),_=r("702095"),f=r("474956"),v=r("150615"),g=r("158316"),m=r("839702"),y=r("138503");function S(){return(S=(0,i._)(function*(e){var{addToUserGenerated:t=!0}=e,r=(0,y.O)(e.containerService,e.notificationGenerator);try{var[a,i]=e.containerService.invokeFunction(e=>[e.get(d.ec),e.get(l.b)]),o=Promise.all(e.files.map((o,d)=>{var l,y,S,M,T,k,I=".".concat(o.name.split(".").reverse()[0]);if(e.acceptTypes&&!(0,h.J5)({file:o,accepts:e.acceptTypes})&&!e.acceptTypes.includes("file")||(null===(l=e.disableTypes)||void 0===l?void 0:l.includes(o.type))||(null===(y=e.disableTypes)||void 0===y?void 0:y.includes(I))||o.size<=0)return!e.acceptTypesErrorTipDisabled&&(null==r||r.error(v.ZP.t("current_import_format_not_supported",{},"Current import format is not supported"))),(0,u.wf)(-1,"un support file type",{name:o.name});if(o.size<=0)return null==r||r.error(v.ZP.t("web_file_upload_toast_empty_file",{},"Can\u2019t upload empty file")),(0,u.wf)(-1,"invalid file size");var w=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0x40000000,r=arguments.length>2?arguments[2]:void 0;return e>t?(null==r||r.error(v.ZP.t("web_storage_desc_file_size_limit",{number0:(0,g.W)(t)},"This item cannot be uploaded because it is larger than the {number0} GB file size limit.")),(0,u.wf)(-1,"over size")):(0,u.ly)()}(o.size,null===(S=e.checkUploadLimit)||void 0===S?void 0:S.singleSize,(null===(M=e.checkUploadLimit)||void 0===M?void 0:M.isNoNeedSingleSizeLimitToast)?void 0:r);if(!w.ok)return w;var P=null===(T=e.dataDelta)||void 0===T?void 0:T[d];return(0,u.oW)(e.containerService.createInstance(c.p,{fromWorkspaceId:e.fromWorkspaceId,toWorkspaceId:e.toWorkspaceId,fromFolderId:e.fromFolderId,toFolderId:e.toFolderId,data:(0,s._)((0,n._)({key:"",owner:"",md5:""},P),{filename:o.name,sourceType:_.ov.EverCloud,assetType:f.pS.Material,fileType:(null===(k=e.uploadParams)||void 0===k?void 0:k.skipTranscode)?_.YB.File:(0,h.eF)({file:o}),mime:o.type,size:o.size,createdAt:Date.now().valueOf(),updatedAt:Date.now().valueOf()}),autoUpload:e.autoUpload,packageDelta:e.packageDelta,addModelToDraft:(0,m.s)(e.containerService,{addToUserGenerated:t,notificationService:r}),payinPayoutHelper:e.payinPayoutHelper,uploadMaterialLifecycleHelper:new p.x({file:o,uploadSizeChecker:e.uploadSizeChecker,fromWorkspaceId:e.fromWorkspaceId,fromFolderId:e.fromFolderId,uploadParams:e.uploadParams,fastImportAnalyzeHelper:e.fastImportAnalyzeHelper,captureCoverAndThumbHelper:e.captureCoverAndThumbHelper,userMaterialUploadService:a,userMaterialService:i,payinPayoutHelper:e.payinPayoutHelper,checkUploadFlag:e.checkUploadFlag,notificationService:r}),notificationService:r}))})),S=yield o;return S}catch(e){return[(0,u.wf)(-1,null==e?void 0:e.message)]}})).apply(this,arguments)}var M=r("434712"),T=r("333007"),k=r("669622"),I=r("668786"),w=r("2910"),P=r("56935"),b=r("264546"),R=r("831593");class E{getCover(e){var t=this;return(0,i._)(function*(){var{fileType:r,blobUrl:a}=e;if(![_.YB.Video,_.YB.Image].includes(r))return(0,u.wf)(-1,"only support type");switch(r){case _.YB.Video:var i=yield t._getVideoSize(a);if(!i.ok)return i;var n=t._sizeFormat(i.value),s=yield t._videoCaptureService.createCapturer(a,n);if(!s.ok)return s;var o=yield s.value.captureSingleFrame(1,b.l.ArrayBuffer);return(0,u.oW)({url:URL.createObjectURL(new Blob([o.data]))});case _.YB.Image:return yield new Promise(e=>{var t=new Image;t.src=(0,w.C)(a,null,{logType:"js.href/src",reportOnly:"false",blackConfig:"{}",configMode:"merge",isCloseSSRReport:!1,bid:"cc_dreamina",region:"cn",urlLimit:"-1",htmlLimit:"-1",isSaveValidUrl:!1,isRuntimeLog:!1,isDOMParser:!1,escapeRule:"escape-report"}),t.onload=()=>{e((0,u.oW)({url:a}))},t.onerror=t=>{e((0,u.wf)(-1,"img not loaded"))}});case _.YB.Audio:case _.YB.File:(0,P.ss)("CaptureCoverAndThumbHelper::getCover ".concat(r));default:(0,P.bP)(r)}})()}getThumb(e){var t=this;return(0,i._)(function*(){var{blobUrl:r}=e;if(e.fileType!==_.YB.Video)return(0,u.wf)(-1,"only support for video");var a=t._getSpriteInterval(1e3*e.duration),i=t._sizeFormat(e.size),n=yield t._videoCaptureService.createCapturer(r,i);if(!n.ok)return n;var s=n.value.captureByInterval(a,b.l.ArrayBuffer),o=(yield(0,R.uC)(s)).map(e=>({frameCount:1,imageWidth:i.width,imageHeight:i.height,url:URL.createObjectURL(new Blob([e.data]))}));return(0,u.oW)({common:{singleFrameWidth:i.width,singleFrameHeight:i.height,totalSetNum:o.length},details:o})})()}_getVideoSize(e){return new Promise(t=>{var r=document.createElement("video"),a=()=>{r.remove(),r=null};r.src=(0,w.C)(e,null,{logType:"js.href/src",reportOnly:"false",blackConfig:"{}",configMode:"merge",isCloseSSRReport:!1,bid:"cc_dreamina",region:"cn",urlLimit:"-1",htmlLimit:"-1",isSaveValidUrl:!1,isRuntimeLog:!1,isDOMParser:!1,escapeRule:"escape-report"}),r.onloadedmetadata=()=>{var{videoWidth:e,videoHeight:i}=r;t((0,u.oW)({width:e,height:i})),a()},r.onerror=()=>{a(),t((0,u.wf)(-1,"load error"))}})}_sizeFormat(e){var t=e.width,r=e.height;if(e.height>100){var a=100/e.height;t=e.width*a,r=100}return{width:Math.round(t),height:Math.round(r)}}_getSpriteInterval(e){var t;return t=e>=72e6?e/36e5:e>=36e6?2e4:e>=18e6?1e4:e>=36e5?5e3:e>=18e5?3e3:e>=6e5?2e3:e>=6e4?1e3:e>=1e4?500:e>=5e3?125:100}constructor(e){this._videoCaptureService=e}}E=(0,o.gn)([(0,o.fM)(0,b.T),(0,o.w6)("design:type",Function),(0,o.w6)("design:paramtypes",[void 0===b.T?Object:b.T])],E);var D=r("528976");var A=((a={}).File="file",a.Folder="folder",a);class F{get accepts(){return this.getAcceptsByType(this._options.acceptTypes)}get acceptTypes(){return this._options.acceptTypes}getAcceptsByType(e){var t,r=e=>[...e.acceptType.filter(e=>{var t;return!((null===(t=this._options)||void 0===t?void 0:t.disableTypes)||[]).includes(e)}),...e.acceptSuffix.filter(e=>{var t;return!((null===(t=this._options)||void 0===t?void 0:t.disableTypes)||[]).includes(e)})].join(",");return null!==(t=null==e?void 0:e.reduce((e,t)=>"".concat(e?",":"").concat(e).concat(r(h.NF[t]),","),""))&&void 0!==t?t:"*/*"}selectToUpload(e){var t=this;return(0,i._)(function*(){var r,a=yield(0,I.IL)(e.acceptTypes?t.getAcceptsByType(e.acceptTypes):t.accepts,e.multiple);if(!!(null==a?void 0:a.length))null==e||null===(r=e.onFilesSelected)||void 0===r||r.call(e,{files:a,acceptedFiles:a}),t.upload((0,s._)((0,n._)({},e),{files:a}))})()}upload(e){var t=this;return(0,i._)(function*(){var r,a,i,o,l,u,c,h=!1;if((null==e?void 0:null===(r=e.uploadParams)||void 0===r?void 0:r.uploadFlag)!==d.m5.InvisibleNoOccupation&&(null==e?void 0:null===(a=e.uploadParams)||void 0===a?void 0:a.uploadFlag)!==d.m5.NoOccupation){;h=(yield t._showExpandWhenNoSpace({files:e.files,fromWorkspaceId:e.fromWorkspaceId,checkUploadFlag:e.checkUploadFlag,uploadFlag:null===(u=e.uploadParams)||void 0===u?void 0:u.uploadFlag})).hasLargeFile}var p=yield function(e){return S.apply(this,arguments)}((0,s._)((0,n._)({},e),{checkUploadLimit:{singleSize:t._singleFileSizeLimit,isNoNeedSingleSizeLimitToast:h},autoUpload:e.autoUpload,acceptTypes:null!==(c=e.acceptTypes)&&void 0!==c?c:t._options.acceptTypes,disableTypes:null===(i=t._options)||void 0===i?void 0:i.disableTypes,uploadSizeChecker:t._uploadSizeChecker,payinPayoutHelper:t._options.payinPayoutHelper,fastImportAnalyzeHelper:t._options.fastImportHelper,captureCoverAndThumbHelper:t._captureCoverAndThumbHelper,containerService:t._containerService,checkUploadFlag:e.checkUploadFlag,acceptTypesErrorTipDisabled:t._options.acceptTypesErrorTipDisabled,notificationGenerator:t._options.notificationGenerator}));return null===(o=(l=t._options).onBeforeCreated)||void 0===o||o.call(l,{tasks:p,files:e.files}),p.forEach(r=>{var a,i;if(!!r.ok)null===(a=(i=t._options).onCreated)||void 0===a||a.call(i,(0,n._)({directoryNodeType:A.File,material:r.value,isFromLocal:!0,fromFolderId:e.fromFolderId},e))}),p})()}_showExpandWhenNoSpace(e){var t=this;return(0,i._)(function*(){var r=!1,a=e.files.reduce((e,a)=>(a.size>t._singleFileSizeLimit&&(r=!0),e+a.size),0),i=e.checkUploadFlag&&e.uploadFlag===d.m5.InvisibleNoOccupation,n=e.fromWorkspaceId?yield t._uploadSizeChecker.getSize(e.fromWorkspaceId):(0,u.wf)(-1,"no space"),s=!i&&n.ok&&a>n.value;return(n.ok&&s||r)&&t._options.payinPayoutHelper&&(0,T.i)({payinPayoutHelper:t._options.payinPayoutHelper,payScene:k.Mm.UPLOAD,workspaceId:e.fromWorkspaceId,uploadFileList:e.files}),{hasLargeFile:r}})()}constructor(e,t,r){var a;this._options=e,this._userMaterialsService=t,this._containerService=r,this._singleFileSizeLimit=0x500000000,this._captureCoverAndThumbHelper=null!==(a=this._options.captureCoverAndThumbHelper)&&void 0!==a?a:this._containerService.createInstance(E),this._uploadSizeChecker=new D.A({userMaterialsService:this._userMaterialsService})}}F=(0,o.gn)([(0,o.fM)(1,l.b),(0,o.fM)(2,M.t),(0,o.w6)("design:type",Function),(0,o.w6)("design:paramtypes",["undefined"==typeof IUploadMaterialFromLocalParams?Object:IUploadMaterialFromLocalParams,void 0===l.b?Object:l.b,void 0===M.t?Object:M.t])],F)},207326:function(e,t,r){r.d(t,{c:function(){return i}});var a=r(85728),i=(e,t)=>{var r,i=(0,a._)({max:.9},t||{}),n=Date.now(),s=!1,o=()=>{if(!s){var t=Math.min(Math.floor((Date.now()-n)/e*100)/100,i.max);r!==t&&(r=t,i.onprogress(t)),t>=i.max?s=!0:window.requestAnimationFrame(o)}};return window.requestAnimationFrame(o),()=>{s=!0}}},327119:function(e,t,r){r.d(t,{G:function(){return h}});var a=r(789786),i=r(82615),n=r(843698),s=r(806663),o=r(874800),d=r(56935),l=r(280166),u=r(490165),c=r(326915);class h extends o.JT{get dirty(){return this._dirty}setMeta(e){(0,d.Y2)(this._sharedMutex.tryLock(),"meta manager should setMeta only once."),this._meta=e,this._initMetaHook(),this._dirty=!0,this._onDidChangeMeta.fire()}getMeta(){return this._dirty&&this._updateMeta(),this._meta}_consumeDirtySignal(){this._dirty=!1}_recordDirtyAndNotify(){this._dirty=!0,this._onDidChangeMeta.fire()}_makeSource(){return{owner:this._accountService.userProfile.uid,platform:c.fz.Browser,systemVersion:window.navigator.userAgent,appVersion:this._environmentService.appVersion,createTime:Date.now(),commitId:this.uuid}}constructor(e,t,r){var a;super(),this._accountService=t,this._environmentService=r,this._onDidChangeMeta=new n.Q,this._sharedMutex=new i.L,this._meta={uploadSource:this._makeSource(),createSource:this._makeSource(),draft:{id:"",type:0,duration:0,updateTime:0,size:0,version:"",platformSupport:"browser",isMainTrackEmpty:!1,isScriptTemplate:!1,isBusiness:!1,itemType:0,renderIndexTrackMode:!1,createScenario:null!==(a=new URL(window.location.href).searchParams.get("scenario"))&&void 0!==a?a:"",transferedFrom:0}},this._dirty=!0,this.onDidChangeMeta=this._onDidChangeMeta.event,this._register(e.draftChangeEvent(()=>{this._dirty=!0})),!this._accountService.hasLogin&&(0,s.V)(this._accountService.onDidLogin)(()=>{this._dirty=!0})}}h=(0,a.gn)([(0,a.fM)(1,u.D),(0,a.fM)(2,l.Y),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",[Object,void 0===u.D?Object:u.D,void 0===l.Y?Object:l.Y])],h)},326915:function(e,t,r){r.d(t,{ZZ:function(){return u},fz:function(){return o},hB:function(){return l},t5:function(){return d}});var a,i,n,s,o=((a={}).Android="android",a.Ios="ios",a.Browser="browser",a.Mac="mac",a.Windows="windows",a);var d=((i={}).EmptyCutsame="empty_cutsame",i.DreaminaStory="dreamina_story",i.AiCreator="storyboard",i);var l=((n={})[n.VideoCut=0]="VideoCut",n[n.VideoTemplate=1]="VideoTemplate",n[n.Script=3]="Script",n[n.SmartTool=4]="SmartTool",n[n.Graphic=5]="Graphic",n[n.DreaminaAIEditor=6]="DreaminaAIEditor",n[n.CC4BDigitalHumanEditor=7]="CC4BDigitalHumanEditor",n);var u=((s={})[s.default=0]="default",s[s.remove_background=5]="remove_background",s[s.resize_video=6]="resize_video",s[s.ad_script=7]="ad_script",s[s.text_to_image=8]="text_to_image",s[s.image_to_image=9]="image_to_image",s[s.portrait_generator=10]="portrait_generator",s[s.image_style_transfer=11]="image_style_transfer",s[s.video_style_transfer=12]="video_style_transfer",s[s.image_upscaler=13]="image_upscaler",s[s.ai_color_correction=14]="ai_color_correction",s[s.photo_colorizer=15]="photo_colorizer",s[s.old_photo_restoration=16]="old_photo_restoration",s[s.low_light_image_enhancement=17]="low_light_image_enhancement",s[s.video_upscaler=18]="video_upscaler",s[s.super_slow_motion=19]="super_slow_motion",s[s.video_stabilization=20]="video_stabilization",s[s.chatgpt=21]="chatgpt",s[s.autocut=22]="autocut",s[s.text_to_video=23]="text_to_video",s[s.url_to_video=24]="url_to_video",s[s.template=25]="template",s[s.chatgpt_search=26]="chatgpt_search",s[s.long_to_short=27]="long_to_short",s[s.ai_video=28]="ai_video",s[s.text_to_speech=29]="text_to_speech",s[s.av_translator=30]="av_translator",s[s.voice_changer=31]="voice_changer",s[s.dreamina_story=33]="dreamina_story",s[s.storyboard=38]="storyboard",s[s.festival_marketing_editor=39]="festival_marketing_editor",s[s.smart_ad_edit=40]="smart_ad_edit",s[s.smart_derivation=41]="smart_derivation",s[s.ai_character=42]="ai_character",s[s.business_script_edit=43]="business_script_edit",s[s.video_template_edit=44]="video_template_edit",s[s.smart_ad_edit_for_tts=45]="smart_ad_edit_for_tts",s[s.quick_cut=46]="quick_cut",s)},99532:function(e,t,r){r.d(t,{Z:function(){return i}});var a,i=((a={})[a.SUCCESS=0]="SUCCESS",a[a.FAIL=1]="FAIL",a[a.PREPARE=2]="PREPARE",a[a.SAVING=3]="SAVING",a[a.IDLE=4]="IDLE",a)},738138:function(e,t,r){r.d(t,{l:()=>v,J:()=>f});var a=r("876826"),i=r("789786"),n=r("843698"),s=r("874800"),o=r("273142"),d=r("836413"),l=r("947259"),u=r("99532"),c=r("639746"),h=r("945873"),p=r("638106");class _ extends s.JT{getCommittingTask(){return this.committingTask}getWaitingQueue(){return this.waitingQueue}isEmpty(){return!this.committingTask&&!this.waitingQueue.length}add(e){if(this.waitingQueue.push(e),!this.committingTask){this.moveWaitingDraftToCommitting();return}this.draftQueueChange()}clear(){this.committingTask=null,this.waitingQueue=[],this.draftQueueChange()}moveWaitingDraftToCommitting(){var e,t=null!==(e=this.waitingQueue.shift())&&void 0!==e?e:null;this.committingTask=t,this.draftQueueChange()}initListeners(){var{onError:e,onSuccess:t}=this.options.saveManagerEvent;e(this.handleSaveError),t(this.handleSaveSuccess)}draftQueueChange(){this._onDraftQueueChange.fire(this.committingTask,this.waitingQueue)}updatePackageId(e){var t;null===(t=this.committingTask)||void 0===t||t.setPackageId(e),this.waitingQueue.forEach(t=>{null==t||t.setPackageId(e)}),this.draftQueueChange()}constructor(e){super(),this.options=e,this.committingTask=null,this.waitingQueue=[],this._onDraftQueueChange=this._store.add(new n.Q),this.onDraftQueueChange=this._onDraftQueueChange.event,this.handleSaveError=e=>{var t,r,a;(null===(t=e.cause)||void 0===t?void 0:t.code)!=="ERR_NETWORK"&&(null===(r=e.cause)||void 0===r?void 0:r.code)!=="ECONNABORTED"&&(null===(a=e.cause)||void 0===a?void 0:a.ret)!=="2006"&&e.code!==p.pY.TimedOut&&this.clear()},this.handleSaveSuccess=e=>{var[,t]=e.pair();this.updatePackageId(t),this.moveWaitingDraftToCommitting()},this.initListeners()}}var f="0";class v extends s.JT{get saveState(){return this._saveState}get packageId(){return this.getPackageId()}set packageId(e){this.setPackageId(e)}get isEmptyPackage(){return this.getPackageId()===f}isSaving(){return this._saveState===u.Z.SAVING}needSave(){return!this.draftSaveTaskQueue.isEmpty()||this._needSaveAgain||this._saveState===u.Z.PREPARE||this._saveState===u.Z.SAVING||this._saveState===u.Z.FAIL}setPackageId(e){this._setPackageId(e),this.draftSaveTaskQueue.updatePackageId(e)}generateSaveTask(){for(var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length,i=Array(r>1?r-1:0),n=1;n<r;n++)i[n-1]=arguments[n];var s=this._latestSaveTask,o=this;return this._latestSaveTask=new Promise((e=(0,a._)(function*(e){yield s,o.startSaveTimestamp=Date.now();var r=o._check();if(!r.ok){0===r.code&&o._onBeforeTrySave.fire(),e((0,d.wf)(u.Z.FAIL,r.msg));return}o._onBeforeTrySave.fire(),t&&o.draftSaveTaskQueue.clear();var a=yield o._generateDraftSaveTask(...i);a.ok&&(a.value.setPackageId(o.getPackageId()),o.draftSaveTaskQueue.add(a.value)),o.saveDraft(),e(a)}),function(t){return e.apply(this,arguments)})),this._latestSaveTask}saveDraft(){var e=this;return(0,a._)(function*(){if(e._saveState===u.Z.SAVING||e.draftSaveTaskQueue.isEmpty())return(0,d.ly)();var t,r=e.draftSaveTaskQueue.getCommittingTask();if(!r&&(e.draftSaveTaskQueue.moveWaitingDraftToCommitting(),r=e.draftSaveTaskQueue.getCommittingTask()),r.getIsNeedCheck()){var a=e._check();if(!a.ok)return(0,d.wf)(u.Z.FAIL,a.msg)}e._needSaveAgain=!1,e._saveState=u.Z.SAVING,e._onSaving.fire();var i=yield e._doSave(r);if(!i.ok&&e._checkNeedRetry(i)){if(yield(0,l._)(2*e._nextSaveTimeout),e._store.isDisposed)return i;i=yield e._doSave(r)}return e._store.isDisposed?i:(i.ok?(e._saveState=u.Z.SUCCESS,e._onSuccess.fire(i),!e.draftSaveTaskQueue.isEmpty()&&e._register((0,o.r)(()=>{e.saveDraft()},e._nextSaveTimeout))):(e._saveState=u.Z.FAIL,e._onError.fire(i)),null===(t=r.notifyComplete)||void 0===t||t.call(r,i),i)})()}saveAsNewDraft(e){var t=this;return(0,a._)(function*(){var r=yield t._doSaveAsNew(e);return r.ok?t._onSuccess.fire(r):t._onError.fire(r),r})()}_checkNeedRetry(e){return!1}_check(){return this._permissionService.getDraftPermission()===c.O.readonly?(0,d.wf)(u.Z.FAIL,"draft is readonly"):this._canDraftSave()}constructor(e){super(),this._permissionService=e,this._saveState=u.Z.IDLE,this._needSaveAgain=!1,this._onBeforeTrySave=this._store.add(new n.Q),this.onBeforeTrySave=this._onBeforeTrySave.event,this._onSaving=this._store.add(new n.Q),this.onSaving=this._onSaving.event,this._onError=this._store.add(new n.Q),this.onError=this._onError.event,this._onSuccess=this._store.add(new n.Q),this.onSuccess=this._onSuccess.event,this.draftSaveTaskQueue=new _({saveManagerEvent:{onError:this.onError.bind(this),onSuccess:this.onSuccess.bind(this)}}),this._nextSaveTimeout=1500,this._maxSaveRetryTime=5,this.startSaveTimestamp=0}}v=(0,i.gn)([(0,i.fM)(0,h.H),(0,i.w6)("design:type",Function),(0,i.w6)("design:paramtypes",[void 0===h.H?Object:h.H])],v)},605843:function(e,t,r){r.d(t,{KL:function(){return o},Po:function(){return s},wW:function(){return n}});var a=r(926838),i=r(702095);function n(e){return e.find(e=>e.status===a.a.Sync2UserMaterialFailure?e:null)}function s(e){for(var t of e)if(t.status===a.a.Syncing2UserMaterial)return!0;return!1}function o(e){return e.sourceType===i.ov.EverCloud&&(e.status===a.a.Success||e.status===a.a.Transcoding||e.status===a.a.TranscodeFailure||e.status===a.a.Transcoded)||!1}},700585:function(e,t,r){r.d(t,{I:function(){return f}});var a=r(876826),i=r(789786);r(395248);var n=r(423342),s=r(82615),o=r(843698),d=r(874800),l=r(56935),u=r(693895),c=r(70529),h=r(463922),p=r(894412),_=r(150615);class f extends d.JT{get workspaceId(){return(0,l.ZB)(this._workspaceId,"draft workspaceId shouldn't empty."),this._workspaceId}updateWorkspaceId(e){var t=this;return(0,a._)(function*(){if((0,l.ZB)(t._workspaceId,"draft workspaceId shouldn't empty."),t._workspaceId!==e)yield t._mutex.lock(),t._updateWorkspaceId(e),yield t._changeBaseEvercloud(e),t._onDidWorkspaceChange.fire(),t._mutex.unLock()})()}getWorkspaceName(e){var t=this;return(0,a._)(function*(){if(t._externalInfo.workspaceName)return t._externalInfo.workspaceName;var{workspaceName:r}=yield t._updateWorkspaceExternalInfo(e);return r})()}getIsApplyAllowed(e){var t=this;return(0,a._)(function*(){if(t._externalInfo.applyAllowed)return t._externalInfo.applyAllowed;var{applyAllowed:r}=yield t._updateWorkspaceExternalInfo(e);return r})()}getIsWorkspaceMember(e){var t=this;return(0,a._)(function*(){if(t._externalInfo.isWorkspaceMember)return t._externalInfo.isWorkspaceMember;var{isWorkspaceMember:r}=yield t._updateWorkspaceExternalInfo(e);return r})()}_updateWorkspaceExternalInfo(e){var t=this;return(0,a._)(function*(){var r=t._workspaceId,[a,i]=(yield t._permissionDataService.getWorkspaceInfoExternal({packageKey:e,workspaceId:r,sourceType:4})).pair();return!a&&(t._externalInfo={workspaceName:i.workspace_name,applyAllowed:i.apply_allowed,isWorkspaceMember:i.is_workspace_member}),t._externalInfo})()}_changeBaseEvercloud(e){var t=this;return(0,a._)(function*(){if(!e)return;var r=Date.now(),a=t._workspaceService.getWorkspace(e);if(!!a&&t._baseEvercloud.spaceId!==a.space_id)try{yield t._baseEvercloud.changeSpace({spaceId:a.space_id,dcName:a.space_idc,netconf:{base:a.space_host,media:a.space_res_host}})}catch(i){throw t._reportService.reportDevError("draftWorkspaceManager",i,{workspaceId:e,spaceId:a.space_id,timeout:(Date.now()-r).toString()}),n.Z.error({title:_.ZP.t("service_wrong",{},"Service error"),content:_.ZP.t("some_mistakes_retry",{},"An error occurred. Refresh and try again."),okText:_.ZP.t("REFRESH",{},"Refresh"),okButtonProps:{style:{backgroundColor:"var(--lvv-color-main-default)"}},onOk:()=>{window.location.reload()},escToExit:!1,maskClosable:!1,closable:!1}),i}})()}_updateWorkspaceId(e){this._externalInfo={},this._workspaceId=e}constructor(e,t,r,a,i){super(),this._workspaceId=e,this._userMaterialsService=t,this._workspaceService=r,this._reportService=a,this._permissionDataService=i,this._onDidWorkspaceChange=this._store.add(new o.Q),this._externalInfo={},this._mutex=new s.L,this._baseEvercloud=this._userMaterialsService.getBaseEvercloud(),this.onDidWorkspaceChange=this._onDidWorkspaceChange.event,this._mutex.tryLock(),this._changeBaseEvercloud(this._workspaceId).then(()=>{this._mutex.unLock()})}}f=(0,i.gn)([(0,i.fM)(1,p.b),(0,i.fM)(2,u.W),(0,i.fM)(3,c.m),(0,i.fM)(4,h.q),(0,i.w6)("design:type",Function),(0,i.w6)("design:paramtypes",[String,void 0===p.b?Object:p.b,void 0===u.W?Object:u.W,void 0===c.m?Object:c.m,void 0===h.q?Object:h.q])],f)},989375:function(e,t,r){r.d(t,{f:()=>_});var a=r("249651"),i=r("702095"),n=r("836413"),s=r("836316"),o=r("85728"),d=r("929753"),l=r("33586"),u=r("474956"),c=r("203180"),h=r("562092"),p=r("567559");function _(e){var t=e.preloadMaterialFromEvercloud.reduce((e,t)=>(e[t.md5]=t,e),{}),r=[];for(var _ of e.packageAssets){var f=function(a){var _,f,v,g,m,y,S,M,T,k,I,{md5:w,source_path:P,meta:b}=a,R=e.containerService.invokeFunction(e=>e.get(p.D));if(R.isMaterialExistByKey(w))return R.getMaterialsByMd5(w).forEach(e=>{var{id:t}=e;R.invokeFunctionWithLifeCycleById(t,e=>{r.push(e)})}),"continue";if(!t[w])return{v:(0,n.wf)(-1,"not found target material")};var E=(_=t[w],(0,c.M)((1===(f=_).transcode_status&&!f.tags.includes(7001)&&!(0,l.JI)((0,h.D)(_.meta))&&!(f.preview_url&&Object.values(f.preview_url).filter(e=>!!e).length>0)&&(f.file_type="file"),(0,d._)((0,o._)({},f),{assetType:u.pS.Material,file_type:f.file_type,image_async_resize:!1,asset_id:f.asset_id.toString(),owner:f.owner.toString()}))));E.key=(v=E,-1===(g={sourcePath:P}).sourcePath.indexOf("/")?g.sourcePath||v.md5||"":v.md5);var D={sourcePath:P,meta:b?JSON.parse(b):void 0};!D.meta&&!(null===(I=t[w].tags)||void 0===I?void 0:null===(k=I.includes)||void 0===k?void 0:k.call(I,7001))&&(D.meta={visible:!1}),m=E,y=D,P.startsWith("text_to_audio")&&(m.fileType=i.YB.File,y.meta||(y.meta={visible:!1})),S=E,M=D,!["attachment_video_algorithm.json"].includes(P)||(null===(T=M.meta)||void 0===T?void 0:T.id)||(M.meta={visible:!1,id:"Algorithm"}),r.push((0,s.Q)(E,{fromWorkspaceId:e.workspaceId,toWorkspaceId:e.workspaceId,payinPayoutHelper:e.payinPayoutHelper,packageDelta:D,containerService:e.containerService}))}(_);if("object"===(0,a._)(f))return f.v}return(0,n.oW)(r)}},74027:function(e,t,r){r.d(t,{u:()=>m});var a=r("876826"),i=r("836413"),n=r("842118"),s=r("671381"),o=r("894412"),d=r("930838"),l=r("529227"),u=r("806663"),c=r("184046"),h=r("926838");class p extends c.p{bindListenerWithLifecycle(){(0,u.V)(this.onDidUpload)(()=>{Promise.resolve().then(()=>{if(!this.hasBeenRemoved){if(void 0===this.toWorkspaceId||this.fromWorkspaceId===this.toWorkspaceId){this._updateStatus(h.a.Success);return}this._triggerSyncMaterialFromWorkspaceHelper()}})}),this.onDidSync2UserMaterial(()=>{Promise.resolve().then(()=>{if(!this.hasBeenRemoved)this._updateStatus(h.a.Success)})})}}var _=r("702095"),f=r("474956"),v=r("839702"),g=r("138503");function m(e){return y.apply(this,arguments)}function y(){return(y=(0,a._)(function*(e){var t=(0,g.O)(e.containerService,e.notificationGenerator),[r,u,c]=e.containerService.invokeFunction(e=>[e.get(n.w),e.get(s.ec),e.get(o.b)]);try{var h,m=Promise.all(e.files.map((h=(0,a._)(function*(a){var n=yield(yield r.getInstance()).calcFileMd5(a);return n.ok?(0,i.oW)(e.containerService.createInstance(p,{fromWorkspaceId:e.fromWorkspaceId,toWorkspaceId:e.toWorkspaceId,data:{sourceType:_.ov.EverCloud,assetType:f.pS.Material,key:n.value,filename:a.name,fileType:(0,l.eF)({file:a})||_.YB.File,owner:"",md5:n.value,mime:a.type,size:a.size,createdAt:Date.now().valueOf(),updatedAt:Date.now().valueOf()},addModelToDraft:(0,v.s)(e.containerService),packageDelta:e.packageDelta,uploadMaterialLifecycleHelper:new d.x({file:a,fromWorkspaceId:e.fromWorkspaceId,userMaterialUploadService:u,userMaterialService:c,uploadParams:e.uploadParams,payinPayoutHelper:e.payinPayoutHelper,notificationService:t}),notificationService:t})):n}),function(e){return h.apply(this,arguments)})));return yield m}catch(e){return[(0,i.wf)(-1,null==e?void 0:e.message)]}})).apply(this,arguments)}},803812:function(e,t,r){r.d(t,{Y:function(){return d}});var a=r(876826),i=r(836413),n=r(894412),s=r(589543),o=r(836316);function d(e){return l.apply(this,arguments)}function l(){return(l=(0,a._)(function*(e){var{itemId:t,workspaceId:r,containerService:a}=e;try{var{userMaterialsService:d,dreaminaTransferAiMaterialsService:l}=a.invokeFunction(e=>({userMaterialsService:e.get(n.b),dreaminaTransferAiMaterialsService:e.get(s.X)})),u=yield l.transferAiPhoto({itemId:t,workspaceId:r});if(!u.ok)return(0,i.wf)(u.code,u.msg);var{assetId:c}=u.value,h=yield d.getMaterialsByIds({assetIds:[c],workspaceId:r});if(!h.ok)return(0,i.wf)(h.code,h.msg);var p=(0,o.Q)(h.value[0],{fromWorkspaceId:u.value.workspaceId,toWorkspaceId:u.value.workspaceId,containerService:a,forceTranscode:!0});return(0,i.oW)(p)}catch(e){return(0,i.wf)(-1,null==e?void 0:e.message)}})).apply(this,arguments)}},836316:function(e,t,r){r.d(t,{Q:()=>w});var a=r("702095"),i=r("85728"),n=r("929753"),s=r("789786"),o=r("56935"),d=r("926838"),l=r("70529"),u=r("876826"),c=r("295834"),h=r("836413"),p=r("894412"),_=r("150615"),f=r("208093"),v=r("333007"),g=r("669622");class m extends f.I{get md5(){return this._data.md5}getModel(){return(0,n._)((0,i._)({},this._data),{id:this.id,status:this.status,draftDelta:this._draftDelta,addModelToDraft:this._addModelToDraftBinder,onModelUpdate:this.onModelUpdate,onResourceReady:this.onResourceReady,onDidDone:this.onDidDone,onDidRemove:this.onDidRemove,syncingUserMaterial:this.syncingUserMaterial})}canRetryPrepare(){return!1}prepare(){(0,o.ss)("should not be called when canRetryUpload is false")}canRetryUpload(){return!1}upload(){(0,o.ss)("should not be called when canRetryUpload is false")}canCancelUpload(){return!1}cancelUpload(){(0,o.ss)("should not be called when canCancelUpload is false")}canRetryTranscode(){return!1}canSync2UserMaterial(){return void 0!==this.toWorkspaceId&&this.fromWorkspaceId!==this.toWorkspaceId}cancelSync2UserMaterial(){this.status===d.a.Syncing2UserMaterial&&this._updateToWorkspaceId(this.fromWorkspaceId)}sync2UserMaterial(){var e=this;return(0,u._)(function*(){(0,o.Y2)(e.status!==d.a.Syncing2UserMaterial,"could not call this function before it change to final status");var t=e._genSyncResultChecker();e.syncingUserMaterial={progress:0};try{e._updateStatus(d.a.Syncing2UserMaterial);var{fromWorkspaceId:r,toWorkspaceId:i}=e;if((0,o.Y2)(e._data.sourceType===a.ov.EverCloud),(0,o.ZB)(r),(0,o.ZB)(i),e.toWorkspaceId!==e.fromWorkspaceId){var n=yield e._userMaterialService.copyMaterialToWorkspace({fromWorkspaceId:r,toWorkspaceId:i,assetId:e._data.assetId,meta:""});if(!n.ok){e._updateStatus(d.a.Sync2UserMaterialFailure,{errInfo:n}),e.syncingUserMaterial.error=n,e._handleSyncError(n.code),e._reportService.reportDevError("sync-material-from-workspace",e.syncingUserMaterial.error);return}}t()&&(e._updateStatus(d.a.Synced2UserMaterial),e._afterSync2UserMaterial())}catch(r){if(t()){var s=(0,h.wf)(-1,null==r?void 0:r.message);e._updateStatus(d.a.Sync2UserMaterialFailure,{errInfo:s}),e.syncingUserMaterial.error=s}}})()}transcode(){(0,o.ss)("should not be called when transcode is false")}delete(e){var t=this,r=()=>super.delete;return(0,u._)(function*(){try{if((0,o.Y2)(t._data.sourceType===a.ov.EverCloud),(0,o.ZB)(t.fromWorkspaceId),!(null==e?void 0:e.onlyDeleteInCache)){var i,n=yield t._userMaterialService.deleteMaterials({workspaceId:t.fromWorkspaceId,assetIds:[t._data.assetId]});if(!n.ok)return n}return yield r().call(t),(0,h.ly)()}catch(e){return(0,h.wf)(-1,null!==(i=null==e?void 0:e.message)&&void 0!==i?i:"unexpected error")}})()}_afterSync2UserMaterial(){this._updateStatus(d.a.Success)}_handleSyncError(e){var t,r=Number(e);if(!this._option.payinPayoutHelper){null===(t=this._notificationService)||void 0===t||t.error(_.ZP.t("web_personal_invite_copy_wrong",{},"Couldn\u2019t copy"));return}if(r===p.F.Insufficient)(0,v.i)({payinPayoutHelper:this._option.payinPayoutHelper,payScene:g.Mm.SYNC,workspaceId:this.toWorkspaceId,onPaySuccess:()=>{this.sync2UserMaterial()}})}updateVideoTranscodeInfo(e){this._data.fileType===a.YB.Video&&(this._data.videoTranscodeInfo=e,this._fireModelUpdate())}constructor(e,t,r){var{data:a,toWorkspaceId:i,fromWorkspaceId:n,fromFolderId:s,toFolderId:o}=e,l=(0,c._)(e,["data","toWorkspaceId","fromWorkspaceId","fromFolderId","toFolderId"]);super({toWorkspaceId:i,fromWorkspaceId:n,fromFolderId:s,toFolderId:o,addModelToDraft:e.addModelToDraft,notificationService:e.notificationService}),this._userMaterialService=t,this._reportService=r,this._addModelToDraftBinder=()=>this.addModelToDraft(this),this._option=l,this._data=a,this._updateFromWorkspaceId(e.fromWorkspaceId),this._updateToWorkspaceId(e.toWorkspaceId),this._draftDelta=e.packageDelta,this.canSync2UserMaterial()?this._updateStatus(d.a.WaitForSync2UserMaterial):this._updateStatus(d.a.Success)}}m=(0,s.gn)([(0,s.fM)(1,p.b),(0,s.fM)(2,l.m),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof FileMaterialLifecycleParams?Object:FileMaterialLifecycleParams,void 0===p.b?Object:p.b,void 0===l.m?Object:l.m])],m);var y=r("254544"),S=r("623503"),M=r("973792");class T extends m{getModel(){var e,t=super.getModel();return(0,n._)((0,i._)({},t),{addModelToDraft:this.__addModelToDraftBinder,transcoding:null===(e=this._transcodeMaterialHelper)||void 0===e?void 0:e.transcoding})}canRetryTranscode(){var e,t;return null!==(t=null===(e=this._transcodeMaterialHelper)||void 0===e?void 0:e.canRetryTranscode())&&void 0!==t&&t}transcode(){return(0,o.Y2)(this._transcodeMaterialHelper,"helper not found"),this._transcodeMaterialHelper.transcode()}_initMaterialStatus(e){var{forceTranscode:t}=e,r=this._data,i=!1,n=!1;if(r.fileType===a.YB.Image&&(i=r.isImgTranscoding,n=(0,M.o)(r.imgTranscodeInfo,{keyFormatter:e=>"origin"!==e?"".concat(e,"p"):"origin",originSize:r.width&&r.height?{width:r.width,height:r.height}:void 0})),r.fileType===a.YB.Video&&(i=!(n=!!r.videoTranscodeInfo)),r.fileType===a.YB.Audio&&(i=!(n=!!r.audioTranscodeInfo)),i||t){this._updateStatus(d.a.Transcoding),this._transcodeMaterialHelper.listenTranscodeResult();return}n?this.canSync2UserMaterial()?(this._updateStatus(d.a.WaitForSync2UserMaterial),this.sync2UserMaterial()):this._updateStatus(d.a.Success):this._updateStatus(d.a.TranscodeFailure)}_partialUpdateModel(e){this._data.key&&delete e.key,Object.assign(this._data,e)}constructor(e,t,r){super(e,t,r),this.__addModelToDraftBinder=()=>this.addModelToDraft(this),this._data=e.data,(0,o.Y2)(this._data.sourceType===a.ov.EverCloud),this._data.fileType===a.YB.Image?this._transcodeMaterialHelper=new y.Y({assetId:this._data.assetId,fromWorkspaceId:e.fromWorkspaceId,userMaterialService:t,handler:{status:()=>this.status,onProgress:()=>this._onModelUpdate.fire(this.getModel()),onDidTranscode:this.onDidTranscode,onTranscodeFailure:this.onTranscodeFailure,updateStatus:this._updateStatus.bind(this),updateModel:e=>{this._data=e}}}):[a.YB.Audio,a.YB.Video].includes(this._data.fileType)?this._transcodeMaterialHelper=new S.D({assetId:this._data.assetId,fileType:this._data.fileType,fromWorkspaceId:e.fromWorkspaceId,userMaterialService:t,handler:{status:()=>this.status,onProgress:()=>this._onModelUpdate.fire(this.getModel()),onDidTranscode:this.onDidTranscode,onTranscodeFailure:this.onTranscodeFailure,updateStatus:this._updateStatus.bind(this),updateModel:e=>this._partialUpdateModel(e)}}):(0,o.ss)("unexpected logic"),this._initMaterialStatus({forceTranscode:e.forceTranscode})}}T=(0,s.gn)([(0,s.fM)(1,p.b),(0,s.fM)(2,l.m),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof IMediaMaterialLifecycle?Object:IMediaMaterialLifecycle,void 0===p.b?Object:p.b,void 0===l.m?Object:l.m])],T);var k=r("839702"),I=r("138503");function w(e,t){var r=(0,I.O)(t.containerService,t.notificationGenerator);switch(e.fileType){case a.YB.Video:case a.YB.Audio:case a.YB.Image:return t.containerService.createInstance(T,{data:e,forceTranscode:t.forceTranscode,packageDelta:t.packageDelta,fromWorkspaceId:t.fromWorkspaceId,toWorkspaceId:t.toWorkspaceId,payinPayoutHelper:t.payinPayoutHelper,fromFolderId:t.fromFolderId,toFolderId:t.toFolderId,addModelToDraft:(0,k.s)(t.containerService,{addToUserGenerated:t.addToUserGenerated,notificationService:r}),notificationService:r});default:return t.containerService.createInstance(m,{data:e,packageDelta:t.packageDelta,fromWorkspaceId:t.fromWorkspaceId,toWorkspaceId:t.toWorkspaceId,fromFolderId:t.fromFolderId,toFolderId:t.toFolderId,payinPayoutHelper:t.payinPayoutHelper,addModelToDraft:(0,k.s)(t.containerService,{addToUserGenerated:t.addToUserGenerated,notificationService:r}),notificationService:r})}}},762743:function(e,t,r){r.d(t,{x:function(){return d}});var a=r(876826),i=r(894412),n=r(836413),s=r(947259),o=r(836316);function d(e){return l.apply(this,arguments)}function l(){return(l=(0,a._)(function*(e){var t,r,d=Object.assign({},{waitForFirstRequest:!1,delay:0,retryTimes:0},e.fetchRetryOptions);var l=(t=(0,a._)(function*(){var t=yield e.containerService.invokeFunction(t=>t.get(i.b).getMaterialsByIds({workspaceId:e.fromWorkspaceId,assetIds:e.assetIds}));return t.ok?t.value.length!==e.assetIds.length?(0,n.wf)(-1,"found target assets failure"):t:t}),function(){return t.apply(this,arguments)});var u=(r=(0,a._)(function*(e){!(0===e&&!d.waitForFirstRequest)&&(yield(0,s._)(d.delay));var t=yield l();if(!t.ok)return e>=d.retryTimes?t:u(e+1);return t}),function(e){return r.apply(this,arguments)});try{var c=yield u(0);if(!c.ok)return c;var h=c.value.map(t=>(0,o.Q)(t,{fromWorkspaceId:e.fromWorkspaceId,toWorkspaceId:e.toWorkspaceId,payinPayoutHelper:e.payinPayoutHelper,containerService:e.containerService,packageDelta:e.packageDelta}));return(0,n.oW)(h)}catch(e){return(0,n.wf)(-1,null==e?void 0:e.message)}})).apply(this,arguments)}},233157:function(e,t,r){r.d(t,{J:()=>u});var a=r("876826"),i=r("836413"),n=r("836316"),s=r("947259"),o=r("776834");function d(){return(d=(0,a._)(function*(e){try{var t,r,n=Object.assign({},{waitForFirstRequest:!1,delay:0,retryTimes:0},e.fetchRetryOptions),d=yield e.userMaterialService.getEvercloudInstance(e.workspaceId);var l=(t=(0,a._)(function*(){try{var t=yield d.getAssets({md5s:e.md5s,material:!1});if(!t)return(0,i.wf)(-1,"not found target assets");if(t.length!==e.md5s.length)return(0,i.wf)(-1,"found target assets failure");var r=new Map(t.map(e=>[e.md5,e])),a=[];for(var n of e.md5s){if(!r.has(n))return(0,i.wf)(-1,"can not find md5: ".concat(n));a.push(r.get(n))}return(0,i.oW)(a.map(e=>(0,o.V)(e)))}catch(e){return(0,i.wf)(-1,null==e?void 0:e.message)}}),function(){return t.apply(this,arguments)});var u=(r=(0,a._)(function*(e){!(0===e&&!n.waitForFirstRequest)&&(yield(0,s._)(n.delay));var t=yield l();if(!t.ok)return e>=n.retryTimes?t:u(e+1);return t}),function(e){return r.apply(this,arguments)});return yield u(0)}catch(e){return(0,i.wf)(-1,null==e?void 0:e.message)}})).apply(this,arguments)}var l=r("894412");function u(e){return c.apply(this,arguments)}function c(){return(c=(0,a._)(function*(e){var t=yield e.containerService.invokeFunction(t=>{var r=t.get(l.b);return function(e){return d.apply(this,arguments)}({fetchRetryOptions:e.fetchRetryOptions,workspaceId:e.fromWorkspaceId,md5s:e.md5s,userMaterialService:r})});if(!t.ok)return t;var r=t.value.map(t=>(0,n.Q)(t,{packageDelta:e.packageDelta,fromWorkspaceId:e.fromWorkspaceId,toWorkspaceId:e.toWorkspaceId,payinPayoutHelper:e.payinPayoutHelper,containerService:e.containerService,addToUserGenerated:e.addToUserGenerated}));return(0,i.oW)(r)})).apply(this,arguments)}},208093:function(e,t,r){r.d(t,{I:function(){return c}});var a=r(523197),i=r(843698),n=r(874800),s=r(836413),o=r(56935),d=r(926838),l=r(904989),u=r(434487);class c extends n.JT{get id(){return this._id}get _notificationService(){return this._options.notificationService}get fromWorkspaceId(){return this._fromWorkspaceId}get toWorkspaceId(){return this._toWorkspaceId}get fromFolderId(){return this._fromFolderId}get toFolderId(){return this._toFolderId}get hasBeenRemoved(){return this._hasBeenRemoved}_updateFromWorkspaceId(e){this._fromWorkspaceId=e}_updateToWorkspaceId(e){this._toWorkspaceId=e}_updateFromFolderId(e){this._fromWorkspaceId=e}_updateToFolderId(e){this._toFolderId=e}cancelUpload(){this.dispose()}delete(){return this._onDidDelete.fire(),this.dispose(),Promise.resolve((0,s.ly)())}get status(){return this._status}updateToWorkspaceId(e){var t;if(!this.hasBeenRemoved&&this.toWorkspaceId!==e){if(this._updateToWorkspaceId(e),null===(t=this.onAfterUpdateToWorkspaceId)||void 0===t||t.call(this),this.fromWorkspaceId!==this.toWorkspaceId)switch(this.status){case d.a.Success:case d.a.WaitForSync2UserMaterial:this._updateStatus(d.a.WaitForSync2UserMaterial),this.sync2UserMaterial();break;case d.a.Syncing2UserMaterial:case d.a.Sync2UserMaterialFailure:this.cancelSync2UserMaterial(),this._updateStatus(d.a.WaitForSync2UserMaterial),this.sync2UserMaterial()}}}updateToWorkspaceIdAndFolderId(e){var{workspaceId:t,folderId:r}=e;if(this.hasBeenRemoved||this.toFolderId===r)return;if(this._updateToFolderId(r),this.fromFolderId!==this.toFolderId)this.updateToWorkspaceId(t)}onAfterUpdateToWorkspaceId(){}_fireModelUpdate(){!this._hasBeenMd5Setted&&this.md5&&(this._hasBeenMd5Setted=!0,this._onDidMd5Set.fire()),this._onModelUpdate.fire(this.getModel())}addModelToDraft(e){return this._options.addModelToDraft(e)}dispose(){this._hasBeenRemoved=!0,this._onDidRemove.fire(),super.dispose()}_genSyncResultChecker(){var e=this.fromWorkspaceId,t=this.toWorkspaceId;return()=>e===this.fromWorkspaceId&&t===this.toWorkspaceId}_fireResourceReady(){this._onResourceReady.fire()}constructor(e){super(),this._options=e,this._hasBeenFireResourceReady=!1,this._hasBeenMd5Setted=!1,this._hasBeenRemoved=!1,this._status=d.a.Unknown,this._onDidMd5Set=this._store.add(new i.Q),this.onDidMd5Set=e=>{if(!this.md5)return this._onDidMd5Set.event(e);var t=!1;return setTimeout(()=>{if(!t)e()}),{dispose:()=>{t=!0}}},this._onPrepareStart=this._store.add(new i.Q),this.onPrepareStart=this._onPrepareStart.event,this._onDidPrepare=this._store.add(new i.Q),this.onDidPrepare=this._onDidPrepare.event,this._onPrepareFailure=this._store.add(new i.Q),this.onPrepareFailure=e=>{var t=!1;this.status===d.a.PrepareFailure&&setTimeout(()=>{var r;if(!t)e(null===(r=this.getModel().preparing)||void 0===r?void 0:r.error)});var r=this._onPrepareFailure.event(e);return{dispose:()=>{t=!0,r.dispose()}}},this._onUploadStart=this._store.add(new i.Q),this.onUploadStart=this._onUploadStart.event,this._onDidCancelUpload=this._store.add(new i.Q),this.onDidCancelUpload=this._onDidCancelUpload.event,this._onUploadFailure=this._store.add(new i.Q),this.onUploadFailure=e=>{var t=!1;this.status===d.a.UploadFailure&&setTimeout(()=>{var r;if(!t)e(null===(r=this.getModel().uploading)||void 0===r?void 0:r.error)});var r=this._onUploadFailure.event(e);return{dispose:()=>{t=!0,r.dispose()}}},this._onDidUpload=this._store.add(new i.Q),this.onDidUpload=e=>{if(!(0,l.p)(this))return this._onDidUpload.event(e);var t=!1;return setTimeout(()=>{if(!t)e()}),{dispose:()=>{t=!0}}},this._onTranscoding=this._store.add(new i.Q),this.onTranscoding=this._onTranscoding.event,this._onDidTranscode=this._store.add(new i.Q),this.onDidTranscode=this._onDidTranscode.event,this._onTranscodeFailure=this._store.add(new i.Q),this.onTranscodeFailure=e=>{var t=!1;this.status===d.a.TranscodeFailure&&setTimeout(()=>{var r;if(!t)e(null===(r=this.getModel().transcoding)||void 0===r?void 0:r.error)});var r=this._onTranscodeFailure.event(e);return{dispose:()=>{t=!0,r.dispose()}}},this._onSyncing2UserMaterial=this._store.add(new i.Q),this.onSyncing2UserMaterial=this._onSyncing2UserMaterial.event,this._onDidSync2UserMaterial=this._store.add(new i.Q),this.onDidSync2UserMaterial=this._onDidSync2UserMaterial.event,this._onSync2UserMaterialFailure=this._store.add(new i.Q),this.onSync2UserMaterialFailure=e=>{var t=!1;this.status===d.a.Sync2UserMaterialFailure&&setTimeout(()=>{var r;if(!t)e(null===(r=this.getModel().syncingUserMaterial)||void 0===r?void 0:r.error)});var r=this._onSync2UserMaterialFailure.event(e);return{dispose:()=>{t=!0,r.dispose()}}},this._onModelUpdate=this._store.add(new i.Q),this.onModelUpdate=this._onModelUpdate.event,this._onDidUnDone=this._store.add(new i.Q),this.onDidUnDone=this._onDidUnDone.event,this._onResourceReady=this._store.add(new i.Q),this.onResourceReady=e=>{if(!(0,u.fA)(this.getModel()))return this._onResourceReady.event(e);var t=!1;return setTimeout(()=>{if(!t)e()}),{dispose:()=>{t=!0}}},this._onDidDone=this._store.add(new i.Q),this.onDidDone=e=>{var t=this._onDidDone.event(e);if(this.status!==d.a.Success)return t;var r=!1;return setTimeout(()=>{if(!r)e()}),{dispose:()=>{r=!0,t.dispose()}}},this._onDidDelete=this._store.add(new i.Q),this.onDidDelete=this._onDidDelete.event,this._onDidRemove=this._store.add(new i.Q),this.onDidRemove=this._onDidRemove.event,this._updateStatus=(e,t)=>{if(!this.hasBeenRemoved&&this._status!==e){var r=this._status;switch(this._status=e,r===d.a.Success&&this._onDidUnDone.fire(),this._fireModelUpdate(),e){case d.a.Preparing:this._onPrepareStart.fire();break;case d.a.Prepared:this._onDidPrepare.fire();break;case d.a.PrepareFailure:this._onPrepareFailure.fire(null==t?void 0:t.errInfo);break;case d.a.Uploading:this._onUploadStart.fire();break;case d.a.Uploaded:this._onDidUpload.fire();break;case d.a.UploadFailure:this._onUploadFailure.fire(null==t?void 0:t.errInfo);break;case d.a.Transcoding:this._onTranscoding.fire();break;case d.a.Transcoded:this._onDidTranscode.fire();break;case d.a.TranscodeFailure:this._onTranscodeFailure.fire(null==t?void 0:t.errInfo);break;case d.a.Syncing2UserMaterial:this._onSyncing2UserMaterial.fire();break;case d.a.Synced2UserMaterial:this._onDidSync2UserMaterial.fire();break;case d.a.Sync2UserMaterialFailure:this._onSync2UserMaterialFailure.fire(null==t?void 0:t.errInfo);break;case d.a.Success:this._fireResourceReady(),this._onDidDone.fire();break;case d.a.WaitForSync2UserMaterial:this._fireResourceReady();break;case d.a.WaitingUpload:break;case d.a.Unknown:(0,o.ss)("AbstractMaterialLifecycle::_updateStatus UserMaterialStatus.Unknown");default:(0,o.bP)(e,"impossible way, not found status")}}},this._id=(0,a.Rl)(),this._fromWorkspaceId=this._options.fromWorkspaceId,this._toWorkspaceId=this._options.toWorkspaceId,this._fromFolderId=this._options.fromFolderId,this._toFolderId=this._options.toFolderId}}},138503:function(e,t,r){r.d(t,{O:function(){return i}});var a=r(91781);function i(e,t){return t?t():e.invokeFunction(e=>e.get(a.lT))}},254544:function(e,t,r){r.d(t,{Y:()=>_});var a=r("876826"),i=r("82615"),n=r("806663"),s=r("836413"),o=r("926838"),d=r("702095"),l=r("776834"),u=r("584072"),c=r("973792"),h=r("207326"),p=r("158217");class _{get _assetId(){return this._params.assetId}get _fromWorkspaceId(){return this._params.fromWorkspaceId}get _handler(){return this._params.handler}get onDidTranscode(){return this._params.handler.onDidTranscode}get onTranscodeFailure(){return this._params.handler.onTranscodeFailure}get _updateStatus(){return this._params.handler.updateStatus}get _updateModel(){return this._params.handler.updateModel}get transcoding(){return this._transcoding}canRetryTranscode(){return this._handler.status()===o.a.TranscodeFailure}transcode(){var e,t=this;return new Promise((e=(0,a._)(function*(e){if(t._handler.status()===o.a.Transcoding)return e((0,s.wf)(-1,"current material is not transcoding"));try{var r=yield t._params.userMaterialService.getEvercloudInstance(t._fromWorkspaceId);yield r.triggerImageResize({ids:[t._assetId]}),t.listenTranscodeResult()}catch(t){e((0,s.wf)(-1,null==t?void 0:t.message))}return(0,n.V)(t.onDidTranscode)(()=>e((0,s.ly)())),(0,n.V)(t.onTranscodeFailure)(t=>e(null!=t?t:(0,s.wf)(-1,"unknown"))),(0,s.ly)()}),function(t){return e.apply(this,arguments)}))}listenTranscodeResult(){var e=this;return(0,a._)(function*(){if(!!e._mutex.tryLock()){e._transcoding={progress:0,onSuccess:e._params.handler.onDidTranscode,error:void 0,onError:e._params.handler.onTranscodeFailure};var t=(0,h.c)(3,{onprogress:t=>{e._transcoding&&(e._transcoding.progress=t,e._params.handler.onProgress(t))}});try{var r=e._assetId,i=yield e._params.userMaterialService.getEvercloudInstance(e._fromWorkspaceId),n=yield function(e,t){var r,{userMaterialInstance:i}=t,{resolve:n,promise:o}=(0,u.PQ)();var d=(r=(0,a._)(function*(){var t=yield i.getAssetByFileId(e);if((0,c.o)(t.imageTranscodeInfo,{originSize:t.width&&t.height?{width:t.width,height:t.height}:void 0})){n((0,s.ly)());return}if(!t.imageAsyncResize){n((0,s.wf)(-1,"transcode failure with old data"));return}setTimeout(d,2e3)}),function(){return r.apply(this,arguments)});return d(),o}(r,{userMaterialInstance:i});if((0,p.tF)()&&(yield(0,p.wO)()),n.ok){var _=yield i.getAssets({ids:[e._assetId],material:!1});if(!_||1!==_.length){e._updateStatus(o.a.TranscodeFailure);return}var f=(0,l.V)(null==_?void 0:_[0]);(null==f?void 0:f.fileType)===d.YB.Image?(e._updateModel(f),e._updateStatus(o.a.Transcoded),e._updateStatus(o.a.Success)):e._updateStatus(o.a.TranscodeFailure)}else e._updateStatus(o.a.TranscodeFailure)}finally{e._mutex.unLock(),t()}}})()}constructor(e){this._params=e,this._mutex=new i.L}}},623503:function(e,t,r){r.d(t,{D:function(){return v}});var a=r(876826),i=r(85728),n=r(929753),s=r(295834),o=r(82615),d=r(836413),l=r(947259),u=r(56935),c=r(702095),h=r(926838),p=r(953994),_=r(207326),f=r(158217);class v{get _assetId(){return this._params.assetId}get _fromWorkspaceId(){return this._params.fromWorkspaceId}get _updateStatus(){return this._params.handler.updateStatus}get _updateModel(){return this._params.handler.updateModel}get transcoding(){return this._transcoding}canRetryTranscode(){return!1}transcode(){return(0,u.Y2)("unSupport retry transcode for video"),Promise.resolve((0,d.wf)(-1,"unSupport retry transcode for video"))}listenTranscodeResult(){var e=this;return(0,a._)(function*(){if(!!e._mutex.tryLock()){var t=(0,_.c)(1e4,{onprogress:t=>{e._transcoding&&(e._transcoding.progress=t,e._params.handler.onProgress(t))}});try{var r,o,v=e._assetId;e._transcoding={progress:0,onSuccess:e._params.handler.onDidTranscode,error:void 0,onError:e._params.handler.onTranscodeFailure};var g=yield e._params.userMaterialService.getEvercloudInstance(e._fromWorkspaceId),m=yield g.getVideoAssetTranscodeStatus({id:v}),y=yield m.done();if("success"===y.status){var S,M,T,k=(0,p.J)(y.data);!(null===(S=y.data)||void 0===S?void 0:S.audio)&&(yield Promise.race([Promise.all([(0,a._)(function*(){var e=yield g.getAssetSpirtInfo({id:v});yield e.done()})(),(0,a._)(function*(){var e=yield g.getAssetPreviewInfo({id:v});yield e.done()})()]),(0,l._)(3e3)]));var I=yield e._params.userMaterialService.getMaterialsByIds({workspaceId:e._params.fromWorkspaceId,assetIds:[v]});(0,u.Y2)(I.ok&&(null===(M=I.value)||void 0===M?void 0:M[0]));var w=null===(T=I.value)||void 0===T?void 0:T[0],{key:P}=w,b=(0,s._)(w,["key"]);e._updateModel(b.fileType===c.YB.Video?(0,n._)((0,i._)({},b),{videoTranscodeInfo:k}):(0,n._)((0,i._)({},b),{audioTranscodeInfo:k})),(0,f.tF)()&&(yield(0,f.wO)()),e._updateStatus(h.a.Transcoded),e._updateStatus(h.a.Success)}"error"===y.status&&(e._transcoding.error=(0,d.wf)(null===(r=y.errInfo)||void 0===r?void 0:r.code,null===(o=y.errInfo)||void 0===o?void 0:o.msg),e._updateStatus(h.a.TranscodeFailure)),!(null==y?void 0:y.status)&&(e._transcoding.error=(0,d.wf)(-1,"un expect transcode failure"),e._updateStatus(h.a.TranscodeFailure))}catch(t){e._updateStatus(h.a.TranscodeFailure)}finally{t(),e._mutex.unLock()}}})()}constructor(e){this._params=e,this._mutex=new o.L}}},930838:function(e,t,r){r.d(t,{x:()=>M});var a,i=r("876826"),n=r("85728"),s=r("929753"),o=r("295834"),d=r("82615"),l=r("584072"),u=r("836413"),c=r("671381"),h=r("793724"),p=r("702095"),_=r("926838"),f=r("150615"),v=r("608800");var g=((a={})[a.Insufficient=-2]="Insufficient",a[a.GetDataError=-3]="GetDataError",a[a.FileExtendNotMatch=-4]="FileExtendNotMatch",a),m=r("333007"),y=r("669622"),S=r("158217");class M{get _updateStatus(){return this._handler.updateStatus}get _updateModel(){return this._handler.updateModel}get _delete(){return this._handler.delete}get uploading(){return this._uploading}get _notificationService(){return this._params.notificationService}bootstrap(e){var t,r;Object.entries(e.events).forEach(e=>{var[t,r]=e;this._uploading[t]=r}),this._handler=e.handler,!(null===(t=this._params.uploadParams)||void 0===t?void 0:t.skipTranscode)&&(this._analyzeFileInfo(this._params.file),this._getFileBlobUrl(this._params.file,this._handler.model().mime),this._generateCoverTrigger()),((null===(r=this._params.uploadParams)||void 0===r?void 0:r.skipTranscode)||this._handler.model().fileType===p.YB.File)&&this._handler.updateModel({url:(0,v.S)(this._params.file)})}updateFromWorkspaceId(e){if(this._fromWorkspaceId!==e)(()=>{this._uploadTaskId&&this._params.userMaterialUploadService.cancel(this._uploadTaskId),this._uploadTaskId=void 0,this._updatedAssetId=void 0,this._mutex=new d.L,this._handler.updateStatus(_.a.WaitingUpload)})(),this._fromWorkspaceId=e,this.upload()}canRetryUpload(){return!!(this._handler.status()===_.a.UploadFailure&&this._params.file)}upload(e){var t=this;return(0,i._)(function*(){if(!!t._mutex.tryLock()){if(t._handler.status()===_.a.Uploading){t._mutex.unLock();return}if(t._params.uploadSizeChecker){var r,a,i,o=yield null===(r=t._params.uploadSizeChecker)||void 0===r?void 0:r.getSize(t._fromWorkspaceId),d=t._params.checkUploadFlag&&(null===(a=t._params.uploadParams)||void 0===a?void 0:a.uploadFlag)===c.m5.InvisibleNoOccupation;if(o.ok&&!d&&t._params.file.size>o.value){t._uploading.error=(0,u.wf)(c.H9.Insufficient,"over size from locale"),e?null===(i=t._notificationService)||void 0===i||i.error(f.ZP.t("web_project_toast_not_enough_space",{},"This space doesn\u2019t have enough storage. Try another one.")):t._doWithNotInsufficientSpaceUpload(t._fromWorkspaceId),t._updateStatus(_.a.UploadFailure,{errInfo:t._uploading.error}),t._mutex.unLock();return}t._params.uploadSizeChecker.decrease({workspaceId:t._fromWorkspaceId,size:t._params.file.size})}if(t._uploading.error=void 0,t._updateStatus(_.a.Uploading),t._updatedAssetId){yield t._tryFetchUserMaterialAndUpdate(t._updatedAssetId),t._mutex.unLock();return}try{var{file:l}=t._params;(0,S.MI)()&&(yield(0,S.wO)());var h=yield t._params.userMaterialUploadService.upload((0,s._)((0,n._)({},t._params.uploadParams),{folderId:t._fromFolderId,file:l,workspaceId:t._fromWorkspaceId,onUploadMetaReady:e=>{e.uploadId&&(t.uploading.uploadId=e.uploadId)},onProgress:e=>{t.uploading.progress=e,t._handler.onProgress(e)},onFinish:e=>{if(!(0,S.qk)()){if(e.ok)t._updatedAssetId=e.value.assetId,t._updateModel({assetId:e.value.assetId}),t._tryFetchUserMaterialAndUpdate(t._updatedAssetId);else{var r,a,i,n,s,o;switch(e.code){case c.H9.Insufficient:t._doWithNotInsufficientSpaceUpload(t._fromWorkspaceId);break;case c.H9.Cancel:console.warn("should be only call when uploading when change space");return;case c.H9.InvalidMaterialName:null===(r=t._notificationService)||void 0===r||r.error(f.ZP.t("web_space_file_name_error",{},"Inappropriate name, please try again"));break;case c.H9.InvalidFormat:null===(a=t._notificationService)||void 0===a||a.error(e.msg);break;case c.H9.NotMatchExtFormat:null===(i=t._notificationService)||void 0===i||i.warning(f.ZP.t("web_alert_toast_not_match",{placeholder0:l.name},"Couldn\u2019t upload {placeholder0}. File extension is inconsistent with the file format."));break;case c.H9.InvalidMaterialInformation:case c.H9.EncodingNotSupport:null===(n=t._notificationService)||void 0===n||n.warning(f.ZP.t("web_alert_toast_not_support",{placeholder0:l.name},"Couldn\u2019t upload {placeholder0}. File encoding is not supported."));break;case c.H9.FolderNotExist:null===(s=t._notificationService)||void 0===s||s.error(f.ZP.t("web_folder_toast_folder_deleted",{},"This folder was deleted"));break;case c.H9.Unknown:default:null===(o=t._notificationService)||void 0===o||o.warning(f.ZP.t("{placeholder0}_upload_failed",{placeholder0:l.name},"upload failed"))}t._uploading.error=e,t._updateStatus(_.a.UploadFailure,{errInfo:e})}t._mutex.unLock()}}}));if(!h.ok){t._mutex.unLock(),t._uploading.error=h,t._updateStatus(_.a.UploadFailure,{errInfo:h});return}t._uploading.requestId=h.value.requestId,t._uploadTaskId=h.value.taskId}catch(e){t._mutex.unLock();var p,v=(0,u.wf)(-1,null!==(p=null==e?void 0:e.message)&&void 0!==p?p:"unexpected failure by calling upload");throw t._uploading.error=v,t._updateStatus(_.a.UploadFailure,{errInfo:v}),e}}})()}canCancelUpload(){return!!this._uploadTaskId}cancelUpload(){var e,t;this._uploadTaskId&&this._params.userMaterialUploadService.cancel(this._uploadTaskId),null===(e=(t=this._handler).onCancelUpload)||void 0===e||e.call(t),this.dispose()}dispose(){var e;this._uploadTaskId=void 0,this._params=null,null===(e=this._quickImportAnalyzeTask)||void 0===e||e.cancel(),this._quickImportAnalyzeTask=void 0}_waitBlobUrlReady(){return this._waitBlobUrlReadyDefer.promise}_generateThumbTrigger(){var e=this;return(0,i._)(function*(){if(!e._params)return;var{captureCoverAndThumbHelper:t}=e._params;if(!!t&&!e._hadGeneratedThumb){e._hadGeneratedThumb=!0;var{uploading:r}=e,a=e._handler.model();if(a.fileType===p.YB.Video&&(null==r?void 0:r.isSupportFastImport)&&(null==r?void 0:r.blobUrl)){var i,n=yield null==t?void 0:t.getThumb({blobUrl:r.blobUrl,fileType:a.fileType,duration:a.duration,size:{width:a.width,height:a.height}});if(i=e._handler.model(),(p.YB.Video!==i.fileType||!i.thumb)&&n.ok)e._updateModel({thumb:n.value})}}})()}_generateCoverTrigger(){var e=this;return(0,i._)(function*(){var{captureCoverAndThumbHelper:t,fastImportAnalyzeHelper:r}=e._params;if(!t||e._hadGeneratedCover){e._uploading.supportPreview=!1;return}e._hadGeneratedCover=!0;var{uploading:a}=e,i=e._handler.model();if([p.YB.Video,p.YB.Image].includes(i.fileType)&&(null==a?void 0:a.originalBlobUrl)){var n,s,o,d=yield null==t?void 0:t.getCover({blobUrl:a.originalBlobUrl,fileType:i.fileType,mime:null!==(n=i.mime)&&void 0!==n?n:"",filename:i.filename});if(!d.ok){e._uploading.supportPreview=!1,e._waitBlobUrlReadyDefer.reject("Get blobUrl fail.");return}!function(e){if(p.YB.Image===e.fileType||p.YB.Video===e.fileType){var t;return!!(null===(t=e.cover)||void 0===t?void 0:t.url)}return!1}(e._handler.model())&&d.ok&&(e._uploading.coverBlob=null===(s=d.value)||void 0===s?void 0:s.url,e._uploading.supportPreview=!0,e._updateModel({cover:d.value})),(null==r?void 0:r.isImageNeedCapture(i.mime))&&(d.ok?(e._uploading.blobUrl=null===(o=d.value)||void 0===o?void 0:o.url,e._waitBlobUrlReadyDefer.resolve()):e._waitBlobUrlReadyDefer.reject("Get blobUrl fail."))}else e._uploading.supportPreview=!1})()}_tryFetchUserMaterialAndUpdate(e){var t=this;return(0,i._)(function*(){var r=yield t._params.userMaterialService.getMaterialsByIds({workspaceId:t._fromWorkspaceId,assetIds:[e],fetchMode:h.$d.WaitForSync});if(!r.ok){var a=(0,u.wf)(g.GetDataError,"fetch user material failure");t.uploading.error=a,t._updateStatus(_.a.UploadFailure,{errInfo:a});return}var i=r.value[0],{duration:n,videoTranscodeInfo:s,audioTranscodeInfo:d,imgTranscodeInfo:l}=i,c=(0,o._)(i,["duration","videoTranscodeInfo","audioTranscodeInfo","imgTranscodeInfo"]);t._updateModel(c),t._updateStatus(_.a.Uploaded)})()}_getFileBlobUrl(e,t){if(this._uploading){var r;this._uploading.originalBlobUrl=(0,v.S)(e),(null===(r=this._params.fastImportAnalyzeHelper)||void 0===r?void 0:r.isImageNeedCapture(t))||(this._uploading.blobUrl=this._uploading.originalBlobUrl,this._waitBlobUrlReadyDefer.resolve())}}_doWithNotInsufficientSpaceUpload(e){(0,m.i)({payinPayoutHelper:this._params.payinPayoutHelper,payScene:y.Mm.UPLOAD,workspaceId:e,uploadFileList:this.uploading.file?[this.uploading.file]:[],onPaySuccess:()=>{var t,r;this.upload(),null===(r=this._params)||void 0===r||null===(t=r.uploadSizeChecker)||void 0===t||t.refresh(e)},onCancel:()=>{var t,r;null===(r=this._params)||void 0===r||null===(t=r.uploadSizeChecker)||void 0===t||t.refresh(e)}})}_analyzeFileInfo(e){var t=this;return(0,i._)(function*(){var r=t._params.fastImportAnalyzeHelper;if(!r){t._uploading.isSupportFastImport=!1;return}var a=r.getTask(e);t._quickImportAnalyzeTask=a;var i=yield a.done();if(!i.ok){t._uploading.isSupportFastImport=!1;return}t._uploading.isSupportFastImport=!0,i.value.data&&t._updateModel(i.value.data),t._generateThumbTriggerBinder()})()}constructor(e){var t,r;this._params=e,this._mutex=new d.L,this._hadGeneratedThumb=!1,this._hadGeneratedCover=!1,this._generateThumbTriggerBinder=this._generateThumbTrigger.bind(this),this._generateCoverTriggerBinder=this._generateCoverTrigger.bind(this),this._waitBlobUrlReadyBinder=this._waitBlobUrlReady.bind(this),this._quickImportAnalyzeTask=void 0,this._fromWorkspaceId=this._params.fromWorkspaceId,this._fromFolderId=null!==(r=null===(t=e.uploadParams)||void 0===t?void 0:t.folderId)&&void 0!==r?r:this._params.fromFolderId,this._uploading={generateThumbTrigger:this._generateThumbTriggerBinder,generateCoverTrigger:this._generateCoverTriggerBinder,waitBlobUrlReady:this._waitBlobUrlReadyBinder,isSupportFastImport:!!this._params.fastImportAnalyzeHelper&&void 0,blobUrl:void 0,coverBlob:void 0,progress:0,file:this._params.file},this._waitBlobUrlReadyDefer=(0,l.PQ)()}}},528976:function(e,t,r){r.d(t,{A:function(){return s}});var a=r(876826),i=r(82615),n=r(836413);class s{increase(e){var t=this._spaceResetStorage.get(e.workspaceId);if(!!t)t.space+=e.size}decrease(e){var t=this._spaceResetStorage.get(e.workspaceId);if(!!t)t.space-=e.size}getSize(e){var t=this;return(0,a._)(function*(){yield t._requestSpaceStorageLocker.lock();var r=t._spaceResetStorage.get(e);try{if(r&&Date.now()-r.updateTime<=6e4)return(0,n.oW)(r.space);var a={space:yield t._params.userMaterialsService.getBaseEvercloud().resetSpaceStorage(e),updateTime:Date.now()};return t._spaceResetStorage.set(e,a),(0,n.oW)(a.space)}catch(e){return(0,n.wf)(-1,null==e?void 0:e.message)}finally{t._requestSpaceStorageLocker.unLock()}})()}refresh(e){this._spaceResetStorage.delete(e),this.getSize(e)}constructor(e){this._params=e,this._spaceResetStorage=new Map,this._requestSpaceStorageLocker=new i.L}}},158217:function(e,t,r){r.d(t,{MI:function(){return n},qk:function(){return s},tF:function(){return o},wO:function(){return d}});var a=r(876826);function i(){var{searchParams:e}=new URL(window.location.href);return!!e.get("debug")}function n(){var{searchParams:e}=new URL(window.location.href),t=e.get("__keep_uploading__");return i()&&"1"===t}function s(){var{searchParams:e}=new URL(window.location.href),t=e.get("__keep_uploading__");return i()&&"2"===t}function o(){var{searchParams:e}=new URL(window.location.href),t=e.get("__keep_uploading__");return i()&&"3"===t}function d(){return l.apply(this,arguments)}function l(){return(l=(0,a._)(function*(){yield new Promise(()=>{})})).apply(this,arguments)}},184046:function(e,t,r){r.d(t,{p:()=>I});var a=r("876826"),i=r("85728"),n=r("929753"),s=r("789786"),o=r("926838"),d=r("702095"),l=r("434712"),u=r("208093"),c=r("806663"),h=r("836413"),p=r("56935"),_=r("254544"),f=r("623503"),v=r("82615"),g=r("70529"),m=r("894412"),y=r("333007"),S=r("669622"),M=r("150615");class T{get _assetId(){return this._params.assetId}get _fromWorkspaceId(){return this._params.fromWorkspaceId}get _toWorkspaceId(){return this._params.toWorkspaceId}get _updateStatus(){return this._params.handler.updateStatus}get _notificationService(){return this._params.notificationService}canSync2UserMaterial(){return!0}sync2UserMaterial(){var e=this;return(0,a._)(function*(){if(!e._mutex.tryLock())return(0,h.wf)(-1,"do not call this function before it done");e._updateStatus(o.a.Syncing2UserMaterial),e.syncingUserMaterial.error=void 0;try{var t=yield e._params.userMaterialService.copyMaterialToWorkspace({assetId:e._assetId,fromWorkspaceId:e._fromWorkspaceId,toWorkspaceId:e._toWorkspaceId,meta:""});if(!t.ok)return e._updateStatus(o.a.Sync2UserMaterialFailure,{errInfo:t}),e.syncingUserMaterial.error=t,e._reportService.reportDevError("sync-material-from-workspace",e.syncingUserMaterial.error),e._handleError(t.code),t;return e._updateStatus(o.a.Synced2UserMaterial),(0,h.ly)()}catch(t){throw e.syncingUserMaterial.error=(0,h.wf)(-1,null==t?void 0:t.message),e._reportService.reportDevError("sync-material-from-workspace",e.syncingUserMaterial.error),e._updateStatus(o.a.Sync2UserMaterialFailure,{errInfo:e.syncingUserMaterial.error}),t}finally{e._mutex.unLock()}})()}_handleError(e){var t,r=Number(e);if(!this._params.payinPayoutHelper){null===(t=this._notificationService)||void 0===t||t.error(M.ZP.t("web_personal_invite_copy_wrong",{},"Couldn\u2019t copy"));return}if(r===m.F.Insufficient)(0,y.i)({payinPayoutHelper:this._params.payinPayoutHelper,payScene:S.Mm.SYNC,workspaceId:this._params.toWorkspaceId,onPaySuccess:()=>{this.sync2UserMaterial()}})}constructor(e,t){this._params=e,this._reportService=t,this.syncingUserMaterial={progress:0},this._mutex=new v.L}}T=(0,s.gn)([(0,s.fM)(1,g.m),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof ISyncFromWorkspaceHelper?Object:ISyncFromWorkspaceHelper,void 0===g.m?Object:g.m])],T);var k=r("904989");class I extends u.I{get md5(){return this._data.md5}canRetryPrepare(){return!1}prepare(){(0,p.ss)("Do not need prepare in upload-material-lifecycle.")}getModel(){var e;return(0,n._)((0,i._)({},void 0,this._data),{id:this.id,addModelToDraft:this._addModelToDraftBinder,onModelUpdate:this.onModelUpdate,onResourceReady:this.onResourceReady,onDidDone:this.onDidDone,onDidRemove:this.onDidRemove,status:this.status,uploading:this._uploadMaterialLifecycleHelper.uploading,transcoding:null===(e=this._transcodeMaterialHelper)||void 0===e?void 0:e.transcoding})}canRetryUpload(){return this._uploadBootstrap(),this._uploadMaterialLifecycleHelper.canRetryUpload()}upload(e){if(!!this.fromWorkspaceId)this._uploadBootstrap(),this._uploadMaterialLifecycleHelper.upload(e)}changeUploadWorkspace(e){if(this._uploadBootstrap(),!(0,k.p)(this))this._updateFromWorkspaceId(e),this._uploadMaterialLifecycleHelper.updateFromWorkspaceId(e)}canCancelUpload(){var e,t;return this._uploadBootstrap(),null!==(t=null===(e=this._uploadMaterialLifecycleHelper)||void 0===e?void 0:e.canCancelUpload())&&void 0!==t&&t}cancelUpload(){this._uploadBootstrap(),this._uploadMaterialLifecycleHelper.cancelUpload(),super.cancelUpload()}canRetryTranscode(){var e,t;return null!==(t=null===(e=this._transcodeMaterialHelper)||void 0===e?void 0:e.canRetryTranscode())&&void 0!==t&&t}transcode(){return(0,p.Y2)(this._transcodeMaterialHelper,"helper not found"),this._transcodeMaterialHelper.transcode()}cancelSync2UserMaterial(){this.status===o.a.Syncing2UserMaterial&&this._updateToWorkspaceId(this.fromWorkspaceId)}canSync2UserMaterial(){var e,t;return null!==(t=null===(e=this._syncFromWorkspaceHelper)||void 0===e?void 0:e.canSync2UserMaterial())&&void 0!==t&&t}sync2UserMaterial(){this._triggerSyncMaterialFromWorkspaceHelper(),(0,p.Y2)(this._syncFromWorkspaceHelper,"helper not found"),this._syncFromWorkspaceHelper.sync2UserMaterial()}delete(e){var t=this,r=()=>super.delete;return(0,a._)(function*(){try{return!(null==e?void 0:e.onlyDeleteInCache)&&(yield t._userMaterialsService.deleteMaterials({workspaceId:t.fromWorkspaceId,assetIds:[t._data.assetId]})),yield r().call(t),(0,h.ly)()}catch(e){var a;return(0,h.wf)(-1,null!==(a=null==e?void 0:e.message)&&void 0!==a?a:"unexpected error")}})()}bindListenerWithLifecycle(){(0,c.V)(this.onDidUpload)(()=>{Promise.resolve().then(()=>{if(this._uploadMaterialLifecycleHelper.dispose(),!this.hasBeenRemoved){if(this._data.fileType===d.YB.Image)this._transcodeMaterialHelper=new _.Y({assetId:this._data.assetId,fromWorkspaceId:this.fromWorkspaceId,userMaterialService:this._userMaterialsService,handler:{status:()=>this.status,onProgress:()=>this._onModelUpdate.fire(this.getModel()),onDidTranscode:this.onDidTranscode,onTranscodeFailure:this.onTranscodeFailure,updateStatus:this._updateStatus.bind(this),updateModel:e=>this._partialUpdateModel(e)}});else if([d.YB.Audio,d.YB.Video].includes(this._data.fileType))this._transcodeMaterialHelper=new f.D({assetId:this._data.assetId,fileType:this._data.fileType,fromWorkspaceId:this.fromWorkspaceId,userMaterialService:this._userMaterialsService,handler:{status:()=>this.status,onProgress:()=>this._onModelUpdate.fire(this.getModel()),onDidTranscode:this.onDidTranscode,onTranscodeFailure:this.onTranscodeFailure,updateStatus:this._updateStatus.bind(this),updateModel:e=>this._partialUpdateModel(e)}});else{this._updateStatus(o.a.Transcoded);return}this._updateStatus(o.a.Transcoding),this._transcodeMaterialHelper.listenTranscodeResult()}})}),(0,c.V)(this.onDidTranscode)(()=>{Promise.resolve().then(()=>{if(!this.hasBeenRemoved){if(void 0===this.toWorkspaceId||this.fromWorkspaceId===this.toWorkspaceId){this._updateStatus(o.a.Success);return}this.sync2UserMaterial()}})}),this.onDidSync2UserMaterial(()=>{Promise.resolve().then(()=>{if(!this.hasBeenRemoved)this._updateStatus(o.a.Success)})})}_triggerSyncMaterialFromWorkspaceHelper(){(0,p.ZB)(this.toWorkspaceId),this._syncFromWorkspaceHelper=this._containerService.createInstance(T,{assetId:this._data.assetId,fromWorkspaceId:this.fromWorkspaceId,toWorkspaceId:this.toWorkspaceId,userMaterialService:this._userMaterialsService,payinPayoutHelper:this._option.payinPayoutHelper,handler:{status:()=>this.status,updateStatus:this._updateStatus.bind(this)},notificationService:this._notificationService})}_partialUpdateModel(e){this._data.key&&delete e.key,Object.assign(this._data,e),this._fireModelUpdate()}_uploadBootstrap(){if(!this._hadUploadBootstrap)this._hadUploadBootstrap=!0,this._uploadMaterialLifecycleHelper.bootstrap({handler:{model:()=>this.getModel(),status:()=>this.status,delete:()=>{this.delete()},onProgress:()=>{this._fireModelUpdate()},onCancelUpload:()=>{this._onDidCancelUpload.fire()},updateStatus:this._updateStatus.bind(this),updateModel:e=>{this._partialUpdateModel(e)}},events:{onSuccess:this.onDidUpload,onError:this.onUploadFailure}})}constructor(e,t,r){super({fromWorkspaceId:e.fromWorkspaceId,toWorkspaceId:e.toWorkspaceId,addModelToDraft:e.addModelToDraft,fromFolderId:e.fromFolderId,toFolderId:e.toFolderId,notificationService:e.notificationService}),this._option=e,this._userMaterialsService=t,this._containerService=r,this._hadUploadBootstrap=!1,this._addModelToDraftBinder=()=>this.addModelToDraft(this);var{data:a,uploadMaterialLifecycleHelper:i,autoUpload:n=!0}=this._option;this._data=a,this._uploadMaterialLifecycleHelper=i,this._updateStatus(o.a.WaitingUpload),n&&this.upload(),this.bindListenerWithLifecycle()}}I=(0,s.gn)([(0,s.fM)(1,m.b),(0,s.fM)(2,l.t),(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof IUploadMaterialLifecycle?Object:IUploadMaterialLifecycle,void 0===m.b?Object:m.b,void 0===l.t?Object:l.t])],I)},839702:function(e,t,r){r.d(t,{s:()=>function e(t,r){var{addToUserGenerated:c,notificationService:h}=(0,v.Z)({},{addToUserGenerated:!0,notificationService:(0,f.O)(t)},r);return r=>{var p;return t.invokeFunction((p=(0,a._)(function*(a){var p=a.get(i.D),f=a.get(g.v),v=a.get(o.b);(0,s.ZB)(r.md5);var m=r.getModel();if(f.draftWorkspaceManager.workspaceId&&r.fromWorkspaceId&&m.status===d.a.Success&&m.sourceType===l.ov.EverCloud){var y,S=yield v.getMaterialsByIds({workspaceId:r.fromWorkspaceId,assetIds:[m.assetId]});if(!S.ok)return"not found all assets"===S.msg&&(null==h||null===(y=h.error)||void 0===y||y.call(h,u.ZP.t("web_editor_addmaterial_deleted",{},"The material has been deleted."))),S}return!p.isMaterialExistInUserGeneratedByMd5(r.md5)&&f.draftWorkspaceManager.workspaceId&&(r.updateToWorkspaceId(f.draftWorkspaceManager.workspaceId),c?p.addToUserGenerated(t.createInstance(_,{lifecycle:r,isListenOriginDeleted:!1,addModelToDraft:e(t,{addToUserGenerated:c,notificationService:h}),notificationService:h})):p.addToAutoGenerated(t.createInstance(_,{lifecycle:r,isListenOriginDeleted:!1,addModelToDraft:e(t,{addToUserGenerated:c,notificationService:h}),notificationService:h}))),(0,n.ly)()}),function(e){return p.apply(this,arguments)}))}}});var a=r("876826"),i=r("567559"),n=r("836413"),s=r("56935"),o=r("894412"),d=r("926838"),l=r("702095"),u=r("150615"),c=r("85728"),h=r("929753"),p=r("208093");class _ extends p.I{get _cloneTarget(){return this._params.lifecycle}get md5(){return this._cloneTarget.md5}get status(){return this._cloneTarget.status}getModel(){return(0,h._)((0,c._)({},this._cloneTarget.getModel()),{id:this.id,addModelToDraft:this._addModelToDraftBinder})}updateToWorkspaceId(e){this._cloneTarget.updateToWorkspaceId(e)}updateToWorkspaceIdAndFolderId(e){this._cloneTarget.updateToWorkspaceIdAndFolderId(e)}canRetryPrepare(){return this._cloneTarget.canRetryPrepare()}prepare(){return this._cloneTarget.prepare()}canRetryUpload(){return this._cloneTarget.canRetryUpload()}upload(){return this._cloneTarget.upload()}canCancelUpload(){return this._cloneTarget.canCancelUpload()}cancelUpload(){return this._cloneTarget.cancelUpload()}canRetryTranscode(){return this._cloneTarget.canRetryTranscode()}transcode(){return this._cloneTarget.transcode()}cancelSync2UserMaterial(){return this._cloneTarget.cancelSync2UserMaterial()}canSync2UserMaterial(){return this._cloneTarget.canSync2UserMaterial()}sync2UserMaterial(){return this._cloneTarget.sync2UserMaterial()}delete(){return super.delete()}_listenOriginEventAndReFire(){var e,t=function(t){var r=e;e._cloneTarget[t](function(){for(var e=arguments.length,a=Array(e),i=0;i<e;i++)a[i]=arguments[i];r["_".concat(t)].fire(...a)})},r=["onDidMd5Set","onPrepareStart","onDidPrepare","onPrepareFailure","onUploadStart","onDidUpload","onUploadFailure","onDidCancelUpload","onTranscoding","onDidTranscode","onTranscodeFailure","onSyncing2UserMaterial","onDidSync2UserMaterial","onSync2UserMaterialFailure","onModelUpdate","onResourceReady","onDidUnDone","onDidDone"];for(var a of(this._params.isListenOriginDeleted&&r.push("onDidDelete"),r))e=this,t(a)}constructor(e){super({fromWorkspaceId:e.lifecycle.fromWorkspaceId,toWorkspaceId:e.lifecycle.toWorkspaceId,fromFolderId:e.lifecycle.fromFolderId,toFolderId:e.lifecycle.toFolderId,addModelToDraft:e.addModelToDraft,notificationService:e.notificationService}),this._params=e,this._addModelToDraftBinder=()=>this.addModelToDraft(this),this._listenOriginEventAndReFire()}}var f=r("138503"),v=r("824547"),g=r("110850")},904989:function(e,t,r){r.d(t,{p:function(){return i}});var a=r(926838);function i(e){return![a.a.Unknown,a.a.Preparing,a.a.Prepared,a.a.PrepareFailure,a.a.WaitingUpload,a.a.Uploading,a.a.UploadFailure].includes(e.status)&&!!e.fromWorkspaceId&&!0}},129625:function(e,t,r){r.d(t,{M:function(){return n}});var a=r(85728),i=r(56935);function n(e){return e.uploading&&(e.uploading=(0,a._)({},e.uploading),Object.defineProperty(e.uploading,"file",{get(){(0,i.ss)("this structure has been transfer to observable data, do not support this value, please try it in origin data")},set(){(0,i.ss)("this structure has been transfer to observable data, do not support this value, please try it in origin data")}})),e}},973792:function(e,t,r){r.d(t,{o:function(){return s}});var a=r(700056),i=r(824547),n=[{targets:["360","480","720"]},{targets:["720","1080","origin"]}];function s(e,t){var r=(null==t?void 0:t.originSize)?Math.max(t.originSize.width,t.originSize.height):void 0,s=(0,a.Z)(n);return r&&r<=720&&s[0].targets.push("origin"),(0,i.Z)({},{strategy:s},t).strategy.map(a=>{var i=a.targets.filter(t=>{var a=parseInt(t,10);return!(e&&!("origin"in e)&&Number.isNaN(a)||r&&r<a)});return!i.length||i.reduce((r,a)=>{if(r)return r;var i,n,s=null!==(i=null==t?void 0:t.keyFormatter)&&void 0!==i?i:e=>"origin"!==e?"".concat(e):"origin",o=null==e?void 0:e[s(a)];return!!(null!==(n=null==o?void 0:o.url)&&void 0!==n?n:null==o?void 0:o.preview_url)},!1)}).reduce((e,t)=>e&&t,!0)}},570499:function(e,t,r){r.d(t,{CF:function(){return d},O9:function(){return o},V$:function(){return s}});var a,i,n,s=((a={}).VIDEO="video",a.IMAGE="image",a.AUDIO="audio",a.FILE="file",a);var o=((i={}).LOCAL="local",i.GOOGLE_DRIVE="google_drive",i.MY_SPACE="my_space",i.SHOPIFY="shopify",i.LINK="link",i.DROP_BOX="dropbox",i.STOCK_VIDEOS="stock_videos",i.EXTRA_AUDIO="extra_audio",i.TTLIVE="ttlive",i.MURF="murf",i.Assets="assets",i);var d=((n={}).SUCCESS="success",n.FAIL="fail",n.CANCEL="cancel",n)},567559:function(e,t,r){r.d(t,{D:function(){return a}});var a=(0,r(971245).yh)("draft-materials")},297196:function(e,t,r){r.d(t,{e:()=>_});var a=r("806663"),i=r("843698"),n=r("874800"),s=r("56935"),o=r("926838"),d=r("702095"),l=r("904989"),u=r("85728"),c=r("929753"),h="Default";class p{get namespace(){return this._options.namespace}get _handler(){return this._options.handler}getMaterials(){return[...this._materialSet].map(e=>{var t,r=this._handler.findById(e);return r.draftDelta=(0,c._)((0,u._)({},r.draftDelta),{meta:(0,c._)((0,u._)({},null===(t=r.draftDelta)||void 0===t?void 0:t.meta),{visible:!1,id:this.namespace===h?void 0:this.namespace})}),r})}addMaterials(e){var t=[];e.forEach(e=>{if(!this._materialSet.has(e.id))this._materialSet.add(e.id),t.push(e.id),this._handler.add(e)}),this._handler.onDidAdd(t)}removeMaterials(e){var t=[];if(e.forEach(e=>{if(!!this._materialSet.has(e))this._materialSet.delete(e),t.push(this._handler.findById(e)),this._handler.remove(e)}),!!t&&0!==t.length)this._handler.onDidRemove(t)}replaceMaterial(e,t){if(!(!this._materialSet.has(e)||this._materialSet.has(t.id))){var r=this._handler.findById(e);this._materialSet.delete(e),this._materialSet.add(t.id),this._handler.replace(e,t),this._handler.onDidReplace(r,t)}}replaceAllMaterials(e){this.clear(),this.addMaterials(e)}clear(){this.removeMaterials([...this._materialSet])}constructor(e){this._options=e,this._materialSet=new Set}}class _ extends n.JT{get isReady(){return this._isReady}bootstrap(e){var t=[];(null==e?void 0:e.autoMaterials)&&e.autoMaterials.forEach(e=>{var t,r,a,i=e.getModel();this._addAndBindMaterial(e,"auto"),this.getOrCreateAutoGeneratedMaterialNamespace(null!==(a=null===(r=i.draftDelta)||void 0===r?void 0:null===(t=r.meta)||void 0===t?void 0:t.id)&&void 0!==a?a:h).addMaterials([e])}),e.materials.forEach(e=>{var r,a,i,n,s,o,d=e.getModel();if(!(null===(r=d.draftDelta)||void 0===r?void 0:r.meta)||(null===(i=d.draftDelta)||void 0===i?void 0:null===(a=i.meta)||void 0===a?void 0:a.visible)){this._addAndBindMaterial(e,"user"),t.push(e);return}this._addAndBindMaterial(e,"auto"),this.getOrCreateAutoGeneratedMaterialNamespace(null!==(o=null===(s=d.draftDelta)||void 0===s?void 0:null===(n=s.meta)||void 0===n?void 0:n.id)&&void 0!==o?o:h).addMaterials([e])}),t.forEach(e=>{this._referenceData.userGeneratedMaterials.add(e.id)}),this._onDidMaterialAdd.fire(e.materials.map(e=>e.id)),this._isReady=!0,this._onDidReady.fire()}getMaterials(){var e=[],t=[];for(var r of(this._referenceData.userGeneratedMaterials.forEach(t=>{e.push(this._materials.get(t).getModel())}),this._namespaceMap.values()))t.push(...r.getMaterials());return{userGeneratedMaterials:e,autoGeneratedMaterials:t}}getUnUploadedMaterials(){var e=[];for(var t of this._materials.values())!(0,l.p)(t)&&e.push(t.getModel());return e}getMaterialById(e){var t=this._materials.get(e);return(0,s.ZB)(t),t.getModel()}invokeFunctionWithLifeCycleById(e,t){var r=this._materials.get(e);(0,s.ZB)(r),t(r)}invokeFunctionWithLifeCycle(e){for(var t of this._materials.values())e(t)}isMaterialAllDone(){if(!this._isReady)return!1;for(var e of this._getUsedMaterialIds())if(this._materials.get(e).status!==o.a.Success)return!1;return!0}hasMaterialSyncing(){if(!this._isReady)return!1;for(var e of this._getUsedMaterialIds()){var t=this._materials.get(e);if(t.status===o.a.Preparing||t.status===o.a.WaitingUpload||t.status===o.a.Uploading||t.status===o.a.Transcoding||t.status===o.a.WaitForSync2UserMaterial||t.status===o.a.Syncing2UserMaterial)return!0}return!1}getMaterialsByMd5(e){var t=[];for(var r of this._materials.values())r.md5===e&&t.push(r.getModel());return(0,s.Y2)(t.length,"material is not found by md5(".concat(e,"), please check")),t}getMaterialsByAssetId(e){for(var t of this._materials.values()){var r=t.getModel();if(r.sourceType===d.ov.EverCloud&&r.assetId===e)return r}(0,s.ss)("material is not found by assetId(".concat(e,"), please check"))}getMaterialByKey(e){for(var t of this._materials.values())if(t.getModel().key===e)return t.getModel();(0,s.ss)("not found resource key")}isMaterialExistByKey(e){for(var t of this._referenceData.userGeneratedMaterials){var r=this._materials.get(t);if((null==r?void 0:r.getModel().key)===e)return!0}for(var a of this._namespaceMap.values())if(a.getMaterials().find(t=>t.key===e))return!0;return!1}isMaterialExistInUserGeneratedByMd5(e){for(var t of this._referenceData.userGeneratedMaterials){var r=this._materials.get(t);if((null==r?void 0:r.md5)===e)return!0}return!1}isMaterialExistInUserGenerated(e){return this._referenceData.userGeneratedMaterials.has(e)}addToUserGenerated(e,t){this._addAndBindMaterial(e,"user"),this._referenceData.userGeneratedMaterials.add(e.id),this._onDidMaterialAdd.fire([e.id],t),e.onDidDelete(()=>{this.removeFromUserGenerated(e.id)}),this._removeWhenDuplicateMd5(e)}removeFromUserGenerated(e){var t=this._materials.get(e);(0,s.Y2)(t,"material not found, could not remove"),this._referenceData.userGeneratedMaterials.delete(e),this._onDidMaterialRemove.fire([t.getModel()]),this._checkAndNotifyMaterialDoneState()}addToAutoGenerated(e){this.getOrCreateAutoGeneratedMaterialNamespace(h).addMaterials([e])}batchAddToAutoGenerated(e){this.getOrCreateAutoGeneratedMaterialNamespace(h).addMaterials(e)}removeFromAutoGenerated(e){this.getOrCreateAutoGeneratedMaterialNamespace(h).removeMaterials([e])}getOrCreateAutoGeneratedMaterialNamespace(e){if(this._namespaceMap.has(e))return this._namespaceMap.get(e);var t=new p({namespace:e,handler:{findById:e=>this._materials.get(e).getModel(),add:e=>{this._addAndBindMaterial(e,"auto")},remove:e=>{this._checkAndNotifyMaterialDoneState()},replace:(e,t)=>{this._replaceAndBindMaterial(e,t,"auto")},onDidAdd:e=>{this._onDidMaterialAdd.fire(e)},onDidRemove:e=>{this._onDidMaterialRemove.fire(e)},onDidReplace:(e,t)=>{this._onDidMaterialReplace.fire(e,t)}}});return this._namespaceMap.set(e,t),t}_addAndBindMaterial(e,t){if(!this._materials.has(e.id)){var r=[e.onDidDone,e.onSyncing2UserMaterial].map(e=>e(()=>{this._checkAndNotifyMaterialDoneState()}));(0,a.V)(e.onDidRemove)(()=>{r.forEach(e=>null==e?void 0:e.dispose())}),this._materials.set(e.id,e),e.status===o.a.Success||(this._checkAndNotifyMaterialDoneState(!1),(0,a.V)(e.onDidCancelUpload)(()=>{"user"===t?this.removeFromUserGenerated(e.id):this.removeFromAutoGenerated(e.id)}))}}_replaceAndBindMaterial(e,t,r){this._addAndBindMaterial(t,r),this._checkAndNotifyMaterialDoneState()}_checkAndNotifyMaterialDoneState(e){void 0===e&&(e=this.isMaterialAllDone()),this._preNotifyMaterialIsDone!==e&&(this._preNotifyMaterialIsDone=e,this._onMaterialAllDoneChange.fire(this._preNotifyMaterialIsDone))}_getUsedMaterialIds(){var e=new Set;for(var t of(this._referenceData.userGeneratedMaterials.forEach(t=>{e.add(t)}),this._namespaceMap.values()))t.getMaterials().forEach(t=>{e.add(t.id)});return[...e]}_removeWhenDuplicateMd5(e){var t=()=>{var t=[];for(var r of[...this._referenceData.userGeneratedMaterials]){if(r!==e.id){var a=this._materials.get(r);(null==a?void 0:a.status)===o.a.Success&&(null==a?void 0:a.md5)===e.md5&&(this.removeFromUserGenerated(r),t.push(this._materials.get(r).getModel()))}}this._onMaterialDuplicate.fire(t)};e.status===o.a.Success?t():(0,a.V)(e.onDidDone)(()=>{t()})}constructor(){super(),this._isReady=!1,this._onDidReady=this._store.add(new i.Q),this.onDidReady=this._onDidReady.event,this._namespaceMap=new Map,this._preNotifyMaterialIsDone=!0,this._onMaterialAllDoneChange=this._store.add(new i.Q),this.onMaterialAllDoneChange=this._onMaterialAllDoneChange.event,this._onDidMaterialAdd=this._store.add(new i.Q),this.onDidMaterialAdd=this._onDidMaterialAdd.event,this._onDidMaterialRemove=this._store.add(new i.Q),this.onDidMaterialRemove=this._onDidMaterialRemove.event,this._onMaterialDuplicate=this._store.add(new i.Q),this.onMaterialDuplicate=this._onMaterialDuplicate.event,this._onDidMaterialReplace=this._store.add(new i.Q),this.onDidMaterialReplace=this._onDidMaterialReplace.event,this._materials=new Map,this._referenceData={userGeneratedMaterials:new Set},this.getOrCreateAutoGeneratedMaterialNamespace(h)}}},110850:function(e,t,r){r.d(t,{v:function(){return a}});var a=(0,r(971245).yh)("base-main-draft-service")},770886:function(e,t,r){r.d(t,{M:function(){return a}});function a(e){var{material:t,onUpdateModel:r,onDeleteLifecycle:a,onDidUploadLifecycleDone:i}=e,n=[t.onModelUpdate(()=>{r(t.getModel())}),t.onDidDone(()=>{null==i||i(t.id)})];return a&&n.push(t.onDidCancelUpload(()=>{n.forEach(e=>e.dispose()),a(t.id)}),t.onDidDelete(()=>{n.forEach(e=>e.dispose()),a(t.id)})),n}},111604:function(e,t,r){r.d(t,{B:function(){return s}}),r(246923);var a=r(25614),i=r(150615),n=r(926838);function s(e){if((null==e?void 0:e.status)===n.a.UploadFailure){if(!e.canRetryUpload()){a.Z.error(i.ZP.t("web_graphic_request_failure_tips",{},"Something went wrong. Try again later."));return}e.upload(!0);return}if((null==e?void 0:e.status)===n.a.TranscodeFailure){if(!e.canRetryTranscode()){a.Z.error(i.ZP.t("web_graphic_request_failure_tips",{},"Something went wrong. Try again later."));return}e.transcode();return}if((null==e?void 0:e.status)===n.a.Sync2UserMaterialFailure){if(!e.canSync2UserMaterial()){a.Z.error(i.ZP.t("web_graphic_request_failure_tips",{},"Something went wrong. Try again later."));return}e.sync2UserMaterial();return}}},460397:function(e,t,r){r.d(t,{Zw:function(){return i}}),r(998498);var a=()=>"".concat(Date.now().valueOf()).concat(Math.floor(1e5*Math.random())),i=()=>{var e=sessionStorage.getItem("device_id")?sessionStorage.getItem("device_id"):a();return sessionStorage.setItem("device_id",null!=e?e:""),e}},669622:function(e,t,r){r.d(t,{Mm:function(){return i}}),r(772322),r(150615);var a,i=((a={}).SYNC="SYNC",a.UPLOAD="UPLOAD",a.SYNC_TEMPLATE="SYNC_TEMPLATE",a.SELECTED_SPACE_UPLOAD="SELECTED_SPACE_UPLOAD",a.UPGRADE="UPGRADE",a.AUTO_SAVE="AUTO_SAVE",a.SAVE="SAVE",a.EXPORT="EXPORT",a.MOVE_SPACE_MODAL="MOVE_SPACE_MODAL",a)},333007:function(e,t,r){r.d(t,{i:function(){return s}});var a=r(669622),i=e=>{var{payinPayoutHelper:t,workspaceId:r,reporterParams:a,payScene:i,onOk:n,onCancel:s}=e;t.addListenNotEnoughModalOK(n),t.addListenNotEnoughModalCancel(s),t.showSpaceNotEnoughModal({workspaceId:r,payScene:i,reporterParams:a})},n=e=>{var{payinPayoutHelper:t,workspaceId:r,payScene:a,uploadFileList:i=[],onOk:n,onCancel:s}=e;t.addListenNotEnoughModalOK(n),t.addListenNotEnoughModalCancel(s),t.showPayUploadFullSpaceModal({workspaceId:r,payScene:a,uploadFileList:i})},s=e=>{var{payinPayoutHelper:t,workspaceId:r,payScene:s,uploadFileList:o,reporterParams:d,onOk:l,onCancel:u,onPaySuccess:c,onPayFailed:h}=e;if(t.addListenPaySuccess(c),t.addListenPayFailed(h),!0==!!(s===a.Mm.UPLOAD&&(null==o?void 0:o.length)))n({payinPayoutHelper:t,workspaceId:r,payScene:s,uploadFileList:o,reporterParams:d,onOk:()=>{null==l||l(),t.triggerOnNotEnoughModalOK({workspaceId:r,payScene:s})},onCancel:()=>{null==u||u(),t.triggerOnNotEnoughModalCancel({workspaceId:r,payScene:s})}});else i({payinPayoutHelper:t,workspaceId:r,payScene:s,reporterParams:d,onOk:()=>{null==l||l(),t.triggerOnNotEnoughModalOK({workspaceId:r,payScene:s})},onCancel:()=>{null==u||u(),t.triggerOnNotEnoughModalCancel({workspaceId:r,payScene:s})}})}},257055:function(e,t,r){r.d(t,{s:()=>l,p:()=>f});var a=r("874800"),i=r("448224"),n=r("589862"),s=r("225950"),o=r("8996"),d=r("940140");class l extends a.JT{switchPageIndex(e){if(this._pageIndex!==e)this._pageIndex=e,this._refreshRender(this._dataSdk.document.pages)}_bindEvent(){var e=e=>{this._refreshRender(e)};this._dataSdk.event.addListener(n.B.MODEL_INIT_FINISH,e=>{this._refreshRender(e)}),this._store.add((0,i.UQ)(()=>{this._dataSdk.event.removeListener(n.B.MODEL_INIT_FINISH,e)}));var t=[],r=e=>{for(var r of e.mutations)switch(r.type){case d.x1.ADD_LAYER:var a=r.getMutationSideEffect();t.push({type:"add",id:a.layerId,parentId:a.pageId});break;case d.x1.UPDATE_LAYER:var i=r.getMutationSideEffect();t.push({type:"mod",id:i.layerId,parentId:i.pageId});break;case d.x1.REMOVE_LAYER:var n=r.getMutationSideEffect();t.push({type:"del",id:n.layerId,parentId:n.pageId});break;case d.x1.UPDATE_PAGE:var s=r.getMutationSideEffect();t.push({type:"mod",id:s.pageId,parentId:s.pageId})}};this._dataSdk.event.addListener(n.B.AFTER_MUTATION_RUN,r),this._store.add((0,i.UQ)(()=>{this._dataSdk.event.removeListener(n.B.AFTER_MUTATION_RUN,r)}));var a=e=>{this._renderSdk.currentScene.modelData=e;var r=[];for(var a of t)if("del"===a.type)r.push(a);else if("mod"===a.type&&a.id===e.id){var i={width:e.dimension.width,height:e.dimension.height};e.background&&(i.bgColor=e.background.color),a.data={id:a.id,type:"scene",props:i},r.push(a)}else{var n=this._findLayerInfoById(a.id,e);if(n){var{index:s,parentId:d,layer:l}=n,u=(0,o.l8)(l);a.data=u,a.index=s,a.parentId=d,r.push(a)}}this._renderSdk.changeByDelta(r),t.length=0};this._dataSdk.event.addListener(n.B.AFTER_PAGE_CHANGE,a),this._store.add((0,i.UQ)(()=>{this._dataSdk.event.removeListener(n.B.AFTER_PAGE_CHANGE,a)}))}_findLayerInfoById(e,t){for(var r=(0,s.j)(t)?t.layers:t.children,a=0;a<r.length;a++){var i=r[a];if(e===i.id)return{index:a,parentId:t.id,layer:i};if(i.type===d.F5.GROUP_LAYER){var n=this._findLayerInfoById(e,i);if(n)return n}}}_refreshRender(e){this._renderSdk.editor.backLayer.visible=!1,null===(t=this._renderSdk.currentScene)||void 0===t||t.removeSelf();var t,r=(0,o.wP)(e[this._pageIndex]);this._renderSdk.loadScene(r),this._renderSdk.editor.backLayer.visible=!0}constructor(e,t,r=0){super(),this._dataSdk=e,this._renderSdk=t,this._pageIndex=r,this._refreshRender(this._dataSdk.document.pages),this._bindEvent()}}var u=r("85728"),c=r("56935"),h=r("54291"),p=r("373722"),_=r("688078");class f extends a.JT{_onEndTransform(){this._renderSdk.editor.transformer.targets.forEach(e=>{!(e instanceof h.xv)&&this._updateLayout(e.id,(0,o.G0)(e))})}_onSaveText(e){if(!e.id||""===e.text)return;var t,r,a=this._dataSdk.document.getLayerById(e.id);if(!a)return;if(e.isExit&&!e.text){this._dataSdk.api.text.remove(e.id);return}if(!e.text||e.richText!==a.richText)e.title=null!==(r=null!==(t=e.text)&&void 0!==t?t:a.text)&&void 0!==r?r:a.title,this._dataSdk.api.text.updateProperties(e.id,(0,p.Z)(e,"id"))}_updateLayout(e,t){var r,a=this._dataSdk.document.getLayerById(e);(0,c.ZB)(a);var{x:i,y:n,width:s,height:o,rotation:d,scale:{x:l,y:h},clipRect:p}=a.layout;l&&h&&(r={x:l,y:h}),this._dataSdk.api.common.updateLayout({layerId:e,layout:(0,u._)({x:i,y:n,width:s,height:o,rotation:d,scale:r,clipRect:p},t)})}constructor(e,t,r={}){if(super(),this._dataSdk=e,this._renderSdk=t,this._syncSlots=r,!this._syncSlots.disableTransform){var a=()=>{this._onEndTransform()};this._renderSdk.editor.transformer.on(o.rp.endTransform,a),this._store.add((0,i.UQ)(()=>{this._renderSdk.editor.transformer.off(o.rp.endTransform,a)}))}if(!this._syncSlots.disableTextValue){(0,c.ZB)(this._renderSdk.editor.stage,"stage must be added.");var n=(0,_.Z)(e=>{this._onSaveText(e)},30);this._renderSdk.editor.stage.on(o.rp.updateText,n),this._store.add((0,i.UQ)(()=>{this._renderSdk.editor.stage.off(o.rp.updateText,n)}))}}}},142630:function(e,t,r){r.d(t,{J:function(){return n}});var a=r(85728),i=r(342875);function n(e){var t,r,n,s,o,d,l,u={tracks:[],materials:{}};try{u=i.HHr.parse(e)}catch(e){return null}var{tracks:c,materials:h}=u,p={},_={},f={};for(var v of c){var g=null!==(y=v.type)&&void 0!==y?y:"";for(var m of null!==(S=v.segments)&&void 0!==S?S:[]){var y,S,M,T,k,I,w,P,b,R=m.id;if(!!R){var E=m.material_id;if(E)for(var D of(_[E]=R,null!==(k=m.extra_material_refs)&&void 0!==k?k:[]))_[D]=R;var A=BigInt(null!==(I=null===(M=m.target_timerange)||void 0===M?void 0:M.start)&&void 0!==I?I:0),F=BigInt(null!==(w=null===(T=m.target_timerange)||void 0===T?void 0:T.duration)&&void 0!==w?w:0),C=null!==(b=null!==(P=m.track_render_index)&&void 0!==P?P:m.render_index)&&void 0!==b?b:0;p[R]={id:R,start:A,duration:F,renderIndex:C,trackType:g}}}}for(var U of null!==(B=h.text_templates)&&void 0!==B?B:[]){var B,L,O,W=_[null!==(L=U.id)&&void 0!==L?L:""];if(!!W)for(var x of null!==(O=U.text_info_resources)&&void 0!==O?O:[])x.text_material_id&&(_[x.text_material_id]=W)}for(var V of null!==(t=h.texts)&&void 0!==t?t:[]){;if(!!_[null!==(r=V.id)&&void 0!==r?r:""])V.font_resource_id&&(!V.font_path||0>V.font_path.indexOf("."))&&(f[V.font_resource_id]=V.id)}return(0,a._)({materialId2SegmentId:_,segmentsMeta:p,invalidMaterialResources:f},(n=!1,s=!1,o=!1,d=!1,l=!1,!function e(t){var r,a,u,c,{effects:h,videos:p,drafts:_}=t;for(var f of(Array.isArray(h)&&h.some(e=>e.type===i.cVg.MetaTypeMakeupRoot)&&(l=!0),null!=p?p:[]))(null===(a=f.matting)||void 0===a?void 0:null===(r=a.strokes)||void 0===r?void 0:r.length)>0&&(d=!0),f.object_locked&&(s=!0),(null==f?void 0:null===(u=f.matting)||void 0===u?void 0:u.flag)&&(null==f?void 0:null===(c=f.matting)||void 0===c?void 0:c.flag)>1&&(o=!0),!n&&f.extra_type_option&&f.extra_type_option&i.BKu.IsCombinationVideo&&(n=!0);if(Array.isArray(_))for(var v of _){var{draft:g}=v;(null==g?void 0:g.materials)&&e(g.materials)}}(h),{hasSubDraft:n,hasObjectLocked:s,hasMattingBlend:o,hasMattingStroke:d,hasMakeup:l}))}},857373:function(e,t,r){r.d(t,{X:function(){return i}});var a,i=((a={})[a.None=0]="None",a[a.Local=1]="Local",a[a.Online=2]="Online",a[a.Transcoding=3]="Transcoding",a[a.Downloading=4]="Downloading",a[a.Preparing=5]="Preparing",a[a.Pending=6]="Pending",a[a.Uploading=7]="Uploading",a[a.TranscodeFailed=8]="TranscodeFailed",a[a.DownloadFailed=9]="DownloadFailed",a[a.UploadFailed=10]="UploadFailed",a[a.LoginSyncing=11]="LoginSyncing",a[a.LoginSyncFailed=12]="LoginSyncFailed",a[a.LoginSynced=13]="LoginSynced",a[a.NoTranscodeInformation=14]="NoTranscodeInformation",a[a.TranscodeNotSupported=15]="TranscodeNotSupported",a)},793656:function(e,t,r){r.d(t,{IM:function(){return n},_n:function(){return d},gG:function(){return o},rE:function(){return s}});var a=r(342875),i={video:!0,effect:!0,videoEffect:!0,audio:!0,filter:!0,text:!0,textTemplate:!0,sticker:!0,imageSticker:!0,pictureAdjust:!0,tailLeader:!0,mutable:!0,mutablePoly:!0,mutableAudio:!1,combination:!0};function n(e){return!!i[null==e?void 0:e.type]}function s(e){return!!e&&void 0!==e.children}function o(e){if(!e)return!1;var{locked:t,filled:r}=e;return!t&&void 0!==r}function d(e){if(!e)return!1;var{locked:t}=e;return t}a.pNd.TrackTypeVideo,a.pNd.TrackTypeSticker,a.pNd.TrackTypeText,a.pNd.TrackTypeVideoEffect,a.pNd.TrackTypeFilter,a.pNd.TrackTypeAdjust,a.pNd.TrackTypeSticker,a.pNd.TrackTypeText,a.pNd.TrackTypeVideoEffect,a.pNd.TrackTypeFilter,a.pNd.TrackTypeAdjust,a.pNd.TrackTypeVideo,a.pNd.TrackTypeAudio},988803:function(e,t,r){r.d(t,{uJ:function(){return i}});var a=r(342875);a.JFE.AttachmentAsyncTask,a.JFE.AttachmentVideoAlgorithm,a.JFE.AttachmentAiWriter;var i=a.JFE.AttachmentAiStory},457435:function(e,t,r){r.d(t,{cp:()=>T,H6:()=>w,rk:()=>R,B7:()=>b,u$:()=>D,fQ:()=>x,zx:()=>E,Ru:()=>P,zD:()=>S,CZ:()=>M,Fb:()=>k,HW:()=>I});var a,i,n,s,o=r("914028"),d=e=>{var{userAgent:t,platform:r,maxTouchPoints:a}=e;return void 0!==t&&"MacIntel"===r&&"number"==typeof a&&a>1},l=()=>{var e,t=(null===(e=navigator)||void 0===e?void 0:e.userAgent)||"",r=(0,o.Z)(t),{mobile:a}=r,{os:i=""}=r,n=t.toLowerCase(),s=/crios/.test(n),l="other";return/android/.test(n)&&(l="android",a=!0),(/ios/.test(i)||/ipad|iphone|ipod|mac os x/i.test(n))&&(l="apple"),{isMobile:!!a||d(navigator)||s,mobileType:l}},u=(0,o.Z)();function c(){return"chrome"===u.name}function h(){return c()?/Edg\/([\d.]+)/.test(navigator.userAgent)?"edge":"chrome":"other"}function p(){var e,t=null===(e=u.version)||void 0===e?void 0:e.split(".")[0];return t?parseInt(t,10):0}var _=()=>{var{cookieEnabled:e}=navigator;return{isEnable:e}},f=r(499845),v={checked:!1,res:{isCompatible:!0,cause:{}}},g=!1;function m(e){var t=window.ccWebSlardar;try{t&&!g&&t("sendEvent",{type:"event",name:"compatibility",metrics:{},categories:{reason:JSON.stringify(e)}}),t&&(g=!0)}catch(e){}}var y=r("342875"),S=30,M=y.pMA.div(1000000n,S,"bigint"),T=7,k=10,I=3,w=5e3,P=3e3,b=3e3,R=3e3,E=3e3,D=500,{searchParams:A}=new URL(window.location.href),F="480",C="_is_gpu_exist";try{var{isCompatible:U}=function(){if("node"!==f.env.JUPITER_TARGET&&void 0!==window._compatible)return console.log("checkCompatibility ===> compatibility no check",window._compatible),window._compatible;if(console.log("checkCompatibility ===> compatibility need check",window._compatible),v.checked)return g||m(v.res),v.res;var e,t,r,a={isCompatible:!0,cause:{}},{isMobile:i,mobileType:n}=l();if(i)return a.isCompatible=!1,a.cause={type:"device",details:{mobile_type:n}},v.checked=!0,v.res=a,m(a),a;var{unsupported:s,browserVersion:o,chromeOrEdge:d}=(e=p(),t=[],r=h(),c()||t.push("BrowserType"),function(){switch(h()){case"other":default:return!0;case"edge":return p()>=80;case"chrome":return p()>=86}}()||t.push("BrowserVersion"),function(){var e=!1;try{e=void 0!==window.WebAssembly}catch(e){}return e}()||t.push("WebAssembly"),function(){performance.mark("CHECK_WEBGL2_START");var e=!1,t=!1;try{var r=document.createElement("canvas");return e=!!window.WebGL2RenderingContext,t=!!r.getContext("webgl2"),e&&t}catch(e){return!1}finally{performance.mark("CHECK_WEBGL2_END",{detail:{supportType:e,supportContext:t}})}}()||t.push("WebGL2"),"undefined"!=typeof SharedArrayBuffer||t.push("SharedArrayBuffer"),{unsupported:t,chromeOrEdge:r,browserVersion:e}),{isEnable:u}=_();return u?(v.checked=!0,v.res=a,m(a),a):(a.isCompatible=!1,a.cause={type:"setting",details:{browser_unsupported_feature:["Cookies"]}},v.checked=!0,v.res=a,m(a),a)}();if(U){var B={cpu:8,gpu:1},L=navigator.hardwareConcurrency,O=localStorage.getItem(C);null===O&&(O=document.createElement("canvas").getContext("webgl") instanceof WebGLRenderingContext?"1":"0",localStorage.setItem(C,O)),B.cpu<=L&&B.gpu===Number(O)&&(F="720")}}catch(e){}window._canvas_resolution=F;var W={480:[864,864],720:[1296,1296],1080:[1944,1944]},x={width:null!==(n=null==W?void 0:null===(a=W[F])||void 0===a?void 0:a[0])&&void 0!==n?n:864,height:null!==(s=null==W?void 0:null===(i=W[F])||void 0===i?void 0:i[1])&&void 0!==s?s:864},V=A.get("mock_log_level");V&&Number.isFinite(parseInt(V,10))&&parseInt(V,10)},306452:function(e,t,r){r.d(t,{f:function(){return n}});var a=r(218571),i=r(186979);function n(e,t,r){var n=(0,a.useRef)(0),s=(0,a.useRef)([0,0]),o=(0,a.useCallback)(e=>{if((0,i.G3)(e))return n.current+=e.deltaY,Math.abs(n.current)>=r&&(t(n.current,"roller"),n.current=0),e.preventDefault(),e.stopPropagation(),!1;if((0,i.To)(e)){s.current[0]+=e.deltaX,s.current[1]+=e.deltaY;var a=1;s.current[0]*s.current[1]>0?a=1:s.current[0]*s.current[1]<0?a=-1:0===s.current[0]?a=s.current[1]<0?-1:1:0===s.current[1]&&(a=s.current[0]<0?-1:1);var o=a*Math.sqrt(Math.pow(s.current[0],2)+Math.pow(s.current[1],2))*5;return Math.abs(o)>=r&&(t(o,"touchpad"),s.current=[0,0]),e.preventDefault(),e.stopPropagation(),!1}},[t,r]);(0,a.useEffect)(()=>{var t;return null===(t=e.current)||void 0===t||t.addEventListener("wheel",o),()=>{var t;null===(t=e.current)||void 0===t||t.removeEventListener("wheel",o)}},[e.current,o])}},525177:function(e,t,r){r.d(t,{M9:function(){return d},WZ:function(){return s}});var a=r(876826),i=r(5564),n=r(614022);function s(e,t,r){return o.apply(this,arguments)}function o(){return(o=(0,a._)(function*(e,t,r){var a=URL.createObjectURL(e);return yield r.insertBlob(a,e),console.log("[resource] warmup quick import file",t,a),r.recordResource({segmentPath:t,resPath:a}),a})).apply(this,arguments)}function d(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{uniquePath:a,url:s,decryptKey:o,decryptType:d,type:l,fsPath:u,fetchOption:c}=t,{preloadBlockCount:h,withCredentials:p=!1,headers:_={}}=r,f="asset_id://".concat(a.replace(/^\//,"")).concat(o?(0,i.Cv)(o):""),v={url:s,headers:JSON.stringify(_),withCredentials:p,decryptType:d,type:l,fsPath:null!=u?u:"",fetchOption:c};e.recordResource({segmentPath:a,resPath:f,stream:v,decryptKey:o}),(0,n.Z)(h)&&h>0&&e.startPreload(f,h)}},997021:function(e,t,r){r.d(t,{G8:function(){return d},i1:function(){return o},vX:function(){return l},zD:function(){return s}});var a=r(342875),i=BigInt(1e6),n=BigInt(30),s=30;function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"round",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n;return a.pMA.div(e*r,i,"bigint",t)*i/r}var d=i/n;function l(e,t){var[r,a]=t;return r<e&&e<a}},284853:function(e,t,r){r.d(t,{wA:()=>f});var a=r("876826"),i=r("85728"),n=r("733730"),s=r("460029"),o=r("947259");function d(e){if(e&&e.status>=200&&e.status<300)return e;throw Error("Unexpected status code: ".concat(e.status))}function l(e){return u.apply(this,arguments)}function u(){return(u=(0,a._)(function*(e){var t,r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{onProgress:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=yield function e(t){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,{delayMs:s=500,numTry:l=2,checkResponse:u=d}=null!=n?n:{};return t.startsWith("http://")&&(t=t.replace(/^http:\/\//,"https://")),fetch(t,i).then(u).catch((r=(0,a._)(function*(r){if(r instanceof DOMException&&"AbortError"===r.name){console.warn("fetch ".concat(t," has been aborted"));return}var a=l-1;if(a<=0)throw console.warn("fetch-retry no more retry times, url:",t,", error:",r),r;return console.warn("fetch-retry url:",t,", will retry:",a,", error:",r),yield(0,o.D)(s),yield e(t,i,{delayMs:s,numTry:a})}),function(e){return r.apply(this,arguments)}))}(e,i);if(!(s.status>=200&&s.status<300)){var l=Error("Request status(".concat(s.status,"): ").concat(e));throw l.response=l,l}var{body:u,headers:c}=s,h=Number(null!==(r=null!==(t=c.get("Content-Length"))&&void 0!==t?t:c.get("Media-Length"))&&void 0!==r?r:0);if(!u||!h)return s;var p=0,_=new Response(new ReadableStream({start(e){var t=u.getReader();return function r(){return t.read().then(t=>{var{done:a,value:i}=t;if(a){e.close();return}return e.enqueue(i),p+=i.byteLength,null==n||n(p/h),r()})}()}}),{status:s.status,statusText:s.statusText});for(var[f,v]of s.headers.entries())_.headers.set(f,v);return _})).apply(this,arguments)}function c(e){var t,r=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=null===(t=performance.getEntriesByName(e))||void 0===t?void 0:t[0];if(!a&&r){var i=e.split("/").pop();i&&(a=performance.getEntries().find(e=>e.name.includes(i)))}return a&&void 0!==a.transferSize?0===a.transferSize?"browser":"none":"unknown"}var h="force_refresh",p=!1;"DedicatedWorkerGlobalScope"!==globalThis.constructor.name&&navigator.cookieEnabled&&(p=!!localStorage.getItem("disable_compatible_versions"));var _=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new URL(e);for(var a in t)r.searchParams.append(a,t[a]);return r.href},f=new class e{getCachedBuf(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this;return(0,a._)(function*(){var a=yield r.getCachedResponse(e,t);return yield null==a?void 0:a.arrayBuffer()})()}getCachedResponse(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this;return(0,a._)(function*(){yield r._cacheInitPromise;var a,i,n,s,o=(null===(a=t.versions)||void 0===a?void 0:a.length)&&(null===(i=t.marks)||void 0===i?void 0:i.group)&&(null===(n=t.marks)||void 0===n?void 0:n.name)&&!p,d=_(e,t.marks);"DedicatedWorkerGlobalScope"===globalThis.constructor.name&&(p=globalThis.disableCompatible);try{if(o){var l=yield r.getCachedKeysByGroup(t.marks.group,t.versions),u=null==l?void 0:l.find(e=>e.name===t.marks.name);u&&(console.info("found cached version:",u.version),s=yield r._cache.match(u.url,{ignoreSearch:!0}),u.version!==t.versions[0]&&r._cache.match(e,{ignoreSearch:!0}).then(e=>{void 0===e?r._cache.add(d):d!==e.url&&r._cache.put(d,e.clone())}))}return!s&&(s=yield r._cache.match(e,{ignoreSearch:!0}))&&d!==s.url&&r._cache.put(d,s.clone()),s}catch(e){return}})()}_perfSuccess(e,t,r){return(0,s.oe)(e,{categories:{hit_cache:t,status:"success"},metrics:{file_size:null==r?void 0:r.byteLength}}),r}_perfError(e){(0,s.oe)(e,{categories:{status:"fail"}})}_fetchArrayBuffer(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this;return(0,a._)(function*(){var{perfName:a,forceRefresh:i,marks:n={},priority:o,ignoreQueryInKey:d}=t;yield r._cacheInitPromise;var u=d?e.split("?")[0]:e;(0,s.Ie)(a);var p=i?void 0:yield r.getCachedBuf(u,t);if(p)return r._perfSuccess(a,"idb",p),p;try{var f,v=yield l(i?_(e,{[h]:"".concat(Date.now())}):e,{priority:o},{onProgress:t=>r._eventbus.emit("progress:".concat(e),t)});return p=yield v.arrayBuffer(),null===(f=r._cache)||void 0===f||f.put(_(u,n),new Response(p)),r._eventbus.removeAllListeners("progress:".concat(e)),r._perfSuccess(a,c(e),p),p}catch(t){throw r._perfError(a),r._eventbus.removeAllListeners("progress:".concat(e)),t}})()}_fetchResponse(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this;return(0,a._)(function*(){var a,{perfName:i,forceRefresh:n,marks:o,priority:d,ignoreQueryInKey:u}=t;yield r._cacheInitPromise;var p=u?e.split("?")[0]:e;(0,s.Ie)(i);var f=n?void 0:yield r.getCachedResponse(p,t);if(f)return r._perfSuccess(i,"idb"),f;try{return f=yield l(n?_(e,{[h]:"".concat(Date.now())}):e,{priority:d},{onProgress:t=>{r._eventbus.emit("progress:".concat(e),t),t>=1&&(r._eventbus.removeAllListeners("progress:".concat(e)),r._perfSuccess(i,c(e)))}}),null===(a=r._cache)||void 0===a||a.put(_(p,o),f.clone()),f}catch(t){throw r._perfError(i),r._eventbus.removeAllListeners("progress:".concat(e)),t}})()}fetchWithCache(e,t){var{onProgress:r,removeAfterDone:a=!0,returnType:i="arraybuffer"}=null!=t?t:{};r&&this._eventbus.on("progress:".concat(e),r);var n="".concat(e,"_").concat(i),s=this._task.get(n);if(s)return s;var o="arraybuffer"===i?this._fetchArrayBuffer(e,t):this._fetchResponse(e,t);return this._task.set(n,o),a&&o.finally(()=>this._task.delete(n)),o}deleteTask(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"arraybuffer",r="".concat(e,"_").concat(t);this._task.delete(r)}deleteCache(e,t){var r=this;return(0,a._)(function*(){var a;yield r._cacheInitPromise,yield null===(a=r._cache)||void 0===a?void 0:a.delete(e,t)})()}_initCachedList(){var e=this;return(0,a._)(function*(){if(!e._cachedList.length){yield e._cacheInitPromise;var t,r,a=null!==(r=yield null===(t=e._cache)||void 0===t?void 0:t.keys())&&void 0!==r?r:[];e._cachedList=a.map(e=>{var{url:t}=e,{searchParams:r}=new URL(t),a={};for(var[n,s]of r.entries())a[n]=s;return(0,i._)({url:t},a)})}})()}getCachedKeysByGroup(e,t){var r=this;return(0,a._)(function*(){yield r._cacheKeysPromise;var a=r._cachedList.filter(t=>t.group===e);if(!!a.length){var i=new Set(a[0].names.split("~")),n=a.reduce((e,t)=>t.version&&t.name?(!(t.version in e)&&(e[t.version]=[]),e[t.version].push(t),e):e,{});for(var s in n)!function(e){var t=new Set(n[e].map(e=>e.name));!(t.size===i.size&&[...i].every(e=>t.has(e)))&&delete n[e]}(s);if(!t)return n;for(var o of t)if(n[o])return n[o]}})()}clearCacheByGroup(e,t){var r=this;return(0,a._)(function*(){try{if(navigator.storage&&navigator.storage.estimate){var a=yield navigator.storage.estimate();if(!a.quota||!a.usage)return;var i=a.usage/a.quota*100,n=a.quota-a.usage;if(console.log("clearCacheByGroup info ====>",{remaining:n,percentageUsed:i,quota:a}),a.quota>1e10&&i<30)return;if(n/1e6>100)return}for(var s of(yield r._cacheKeysPromise,r._cachedList.filter(t=>{var r,a;return t.group===e||(null===(r=(a=t.url).includes)||void 0===r?void 0:r.call(a,e))})))!t.includes(s.version)&&r.deleteCache(s.url)}catch(e){console.error("clearCacheByGroup error",e)}})()}constructor(){this._eventbus=new n.Z,this._cache=null,this._task=new Map,this._cachedList=[],this._cacheInitPromise=caches.open("cache_manager").then(e=>this._cache=e).catch(e=>console.error("CacheManager error: ",e)),this._cacheKeysPromise=this._initCachedList()}}},816262:function(e,t,r){r.d(t,{V:()=>i});var a=r("342875");function i(e){var t,r,i=[];if(e===BigInt(Number.MAX_SAFE_INTEGER))return i;for(var n=(r=(t=a.pMA.div(e,1e3))>=72e6?t/36e5:t>=36e6?2e4:t>=18e6?1e4:t>=36e5?5e3:t>=18e5?3e3:t>=6e5?2e3:t>=6e4?1e3:t>=1e4?500:t>=5e3?125:100)/10,s=a.pMA.div(e,1e3*n),o=0;o<s;++o)i.push(Math.floor(1e3*Math.pow(Math.random(),.25))/1e3);return i}},31494:function(e,t,r){r.d(t,{F:()=>o});var a={ERR_SIGN:"1014",ERR_LOGIN:"1015",ERR_PARAM:"1016",ERR_NO_PERMISSION:"1017",ERR_DRAFT_PARSE_ERROR:"2002",ERR_GET_DRAFT_TEMPLATE_FILE_ERROR:"2003",ERR_GET_DRAFT_VERSION_LIST_ERROR:"2004",ERR_DRAFT_NOT_FOUND:"2005",ERR_SAVE_DRAFT:"2001",ERR_DRAFT_VERSION_CONFLICT:"2006",ERR_DRAFT_TYPE_ERROR:"2007",ERR_DRAFT_BROKEN:"2008",ERR_DRAFT_NOT_COMPLETE:"2009",ERR_DRAFT_DUPLICATE_CREATION:"2013",ERR_MUTATION_CHECK:"2014"},i={BELOW_VERSION:40008,INSUFFICIENT_SPACE:20113,DELETED_PACKAGE:40004,DELETED_MATERIAL:1e4};a.ERR_DRAFT_VERSION_CONFLICT,i.BELOW_VERSION,a.ERR_DRAFT_NOT_FOUND,i.DELETED_PACKAGE,a.ERR_DRAFT_NOT_COMPLETE,i.DELETED_MATERIAL;var n=r("951729"),s=r("953501"),o=e=>{switch(e){case String(i.INSUFFICIENT_SPACE):case String(s.f.USER_SPACE_NOT_ENOUGH):return n.W.CAPACITY_INSUFFICIENT;case String(i.DELETED_PACKAGE):return n.W.DELETED_PACKAGE;case a.ERR_DRAFT_NOT_FOUND:return n.W.DRAFT_NOT_FOUND;case a.ERR_DRAFT_TYPE_ERROR:return n.W.DRAFT_TYPE_ERROR;case String(i.BELOW_VERSION):case a.ERR_DRAFT_VERSION_CONFLICT:return n.W.DRAFT_VERSION_CONFLICT;case a.ERR_NO_PERMISSION:return n.W.NOT_PERMISSION;case a.ERR_DRAFT_DUPLICATE_CREATION:return n.W.DRAFT_DUPLICATE_CREATION;case a.ERR_DRAFT_NOT_COMPLETE:case a.ERR_DRAFT_BROKEN:case a.ERR_PARAM:case a.ERR_SIGN:return n.W.DATA_ERROR;case a.ERR_LOGIN:return n.W.ERR_LOGIN;case a.ERR_SAVE_DRAFT:case a.ERR_DRAFT_PARSE_ERROR:case a.ERR_GET_DRAFT_TEMPLATE_FILE_ERROR:case a.ERR_GET_DRAFT_VERSION_LIST_ERROR:case a.ERR_MUTATION_CHECK:return n.W.SERVER_ERROR;default:return n.W.NETWORK_ERROR}}},987663:function(e,t,r){r.d(t,{KO:function(){return n}});var a=r(85728),i=r(342875);function n(e){var{tracks:t,duration:r,progress:n}=e,s=[];return t.forEach(e=>{var t=e.segments.map(e=>{var t,r,i,n,s,o;return{id:e.id,type:e.__segment_struct_type,start:null!==(s=null===(t=e.targetTimerange)||void 0===t?void 0:t.start)&&void 0!==s?s:0n,duration:null!==(o=null===(r=e.targetTimerange)||void 0===r?void 0:r.duration)&&void 0!==o?o:0n,scale:(0,a._)({},null===(i=e.clip)||void 0===i?void 0:i.scale),transform:(0,a._)({},null===(n=e.clip)||void 0===n?void 0:n.transform),material:e.material,materialDraft:e.materialDraft}}).sort((e,t)=>i.pMA.minus(t.start,e.start,"number")),o=t.findIndex(e=>{var t=e.start+e.duration;return n>=BigInt(e.start)&&(n===r?n<=BigInt(t):n<BigInt(t))});if(o>=0){var d=t[o];s.push({id:d.id,type:d.type,__segment_struct_type:d.type,timestamp:Date.now(),scale:d.scale,transform:d.transform,material:d.material,start:d.start,duration:d.duration,materialDraft:d.materialDraft})}}),s}},398133:function(e,t,r){r.d(t,{Me:()=>f,Et:()=>_,vf:()=>p,LL:()=>h,iI:()=>c});var a=r("702095"),i=r("56935"),n=r("789786"),s=(0,r("971245").yh)("sync-report-to-slardar-service"),o=r("497973"),d=r("70529"),l=r("827422");class u{getEventParams(){var{action:e,unavailableDuration:t,isNeedQuickImportSegmentsLength:r,extra:a}=this._params,i={action:e,unavailable_duration:t,extra:a};return r&&(i.quick_import_segments_length=this._mainDraftService.dataSdk.draftView.getQuickImportSegments().length),i}constructor(e,t){this._params=e,this._mainDraftService=t,this.eventName="quick_import_dev"}}u=(0,n.gn)([(0,n.fM)(1,l.n),(0,n.w6)("design:type",Function),(0,n.w6)("design:paramtypes",["undefined"==typeof IQuickImportDev?Object:IQuickImportDev,void 0===l.n?Object:l.n])],u);var c=e=>void 0!==e&&e.startsWith("blob:"),h=e=>void 0!==e&&e.startsWith("/.quick-import/"),p=e=>"incomplete_path_map_".concat(e);function _(e,t,r){if(r.sourceType!==a.ov.EverCloud)return()=>{};var n,s=p(e),o=r,d=null===(n=r.onModelUpdate)||void 0===n?void 0:n.call(r,e=>{o=e}),l=()=>{var e,t=null!==(e=window.localStorage.getItem(s))&&void 0!==e?e:"";if(null!==t)try{return JSON.parse(t)}catch(e){}},u=()=>{(0,i.ZB)(o.sourceType===a.ov.EverCloud);var e,{assetId:r,md5:n}=o,d=null!==(e=l())&&void 0!==e?e:{};d[t]={asset_id:r,md5:n},localStorage.setItem(s,JSON.stringify(d))};return r.uploading.onSuccess(()=>{u()}),()=>{var e,r,a=null!==(r=l())&&void 0!==r?r:{};delete a[t],Object.keys(a).length?localStorage.setItem(s,JSON.stringify(a)):window.localStorage.removeItem(s),null==d||null===(e=d.dispose)||void 0===e||e.call(d)}}function f(e,t){var r=e,a=()=>{r&&(!function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];!function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;!function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0,i=e.createInstance(new o.M(t,r)),n=i.getEventParams();e.invokeFunction(e=>{e.get(d.m).reportBusinessEvent(i.eventName,n,a)}),e.invokeFunction(e=>{e.get(s).reportBySlardar(i.eventName,n)})}(e,t,r,a)}(e,u,[t],{immediately:r})}(t,{action:"quit",unavailableDuration:Date.now()-r,isNeedQuickImportSegmentsLength:!0},!0),r=0)};return window.addEventListener("unload",a),()=>{window.removeEventListener("unload",a)}}},232096:function(e,t,r){r.d(t,{S:()=>e_});var a,i,n,s,o,d=r("586026"),l=r("876826"),u=r("85728"),c=r("929753"),h=r("789786"),p="timelineStore",_="resourceStore",f=r("146359"),v=r("843698"),g=r("705309"),m=r("56935"),y=r("936884"),S=r("827422"),M=r("116447"),T=r("184564"),k=r("77922"),I=r("434712"),w=r("474956"),P=r("793656"),b=r("342875"),R=r("80012"),E=r("457435");function D(e,t){var r=b.pMA.times(E.H6,1e3,"bigint");switch(e){case R.r.UserPhoto:case R.r.UserVideo:case R.r.DigitalHuman:case R.r.Photo:case R.r.Video:case R.r.VideoTemplate:case R.r.Gif:r=e===R.r.Video?b.pMA.times(t.duration_ms,1e3,"bigint"):e===R.r.DigitalHuman?b.pMA.times(t.duration,1e6,"bigint"):e===R.r.UserVideo||e===R.r.Gif?b.pMA.times(t.duration,1e6,"bigint"):R.r.VideoTemplate===e?b.pMA.times(t.duration,1e6,"bigint"):b.pMA.times(E.H6,1e3,"bigint");break;case R.r.UserAudio:case R.r.Audio:r=b.pMA.times(t.duration,1e6,"bigint");break;case R.r.Transition:r=b.pMA.times(E.u$,1e3,"bigint");break;case R.r.BasicText:case R.r.TextPreset:case R.r.TextTemplate:case R.r.BrandText:r=b.pMA.times(E.B7,1e3,"bigint");break;case R.r.Sticker:r=b.pMA.times(E.rk,1e3,"bigint");break;case R.r.Effects:r=b.pMA.times(E.zx,1e3,"bigint");break;case R.r.Filter:case R.r.AdjustmentPreset:r=b.pMA.times(E.Ru,1e3,"bigint")}return r}var A=0,F=()=>"placeholder-segment-".concat(A++),C={[w._g.Photo]:"video",[w._g.UserPhoto]:"video",[w._g.UserVideo]:"video",[w._g.Video]:"video",[w._g.Gif]:"video",[w._g.DigitalHuman]:"video",[R.r.UserDigitalHuman]:"video",[w._g.Audio]:"audio",[w._g.UserAudio]:"audio",[w._g.Filter]:"filter",[w._g.Effects]:"effect",[w._g.FaceProp]:"effect",[w._g.Sticker]:"sticker",[R.r.BasicText]:"text",[R.r.BrandText]:"text",[w._g.TextPreset]:"text",[w._g.TextTemplate]:"textTemplate",[w._g.Transition]:"transition",[w._g.VideoTemplate]:"combination",[w._g.AdjustmentPreset]:"pictureAdjust",[w._g.DreaminaUserAiVideo]:"video",[w._g.PhotoDreamina]:"video",[w._g.VideoDreamina]:"video"},U={[w._g.Photo]:b.cVg.MetaTypePhoto,[w._g.UserPhoto]:b.cVg.MetaTypePhoto,[w._g.UserVideo]:b.cVg.MetaTypeVideo,[w._g.DigitalHuman]:b.cVg.MetaTypeDigitalHuman,[R.r.UserDigitalHuman]:b.cVg.MetaTypeDigitalHuman,[w._g.Video]:b.cVg.MetaTypeVideo,[w._g.Gif]:b.cVg.MetaTypeGif,[w._g.Audio]:b.cVg.MetaTypeMusic,[w._g.UserAudio]:b.cVg.MetaTypeMusic,[w._g.Filter]:b.cVg.MetaTypeFilter,[w._g.Effects]:b.cVg.MetaTypeVideoEffect,[w._g.FaceProp]:b.cVg.MetaTypeFaceEffect,[w._g.Sticker]:b.cVg.MetaTypeSticker,[R.r.BasicText]:b.cVg.MetaTypeText,[R.r.BrandText]:b.cVg.MetaTypeText,[w._g.TextPreset]:b.cVg.MetaTypeText,[w._g.TextTemplate]:b.cVg.MetaTypeTextTemplate,[w._g.Transition]:b.cVg.MetaTypeTransition,[w._g.VideoTemplate]:b.cVg.MetaTypeCombination,[w._g.AdjustmentPreset]:b.cVg.MetaTypeAdjust,[w._g.VideoDreamina]:b.cVg.MetaTypeVideo,[w._g.DreaminaUserAiVideo]:b.cVg.MetaTypeVideo,[w._g.PhotoDreamina]:b.cVg.MetaTypePhoto},B=(e,t,r,a)=>{if(!a.length)return[];var i=a.length,n=Math.round(b.pMA.div(e,r)*i),s=Math.round(b.pMA.div(e+t,r)*i);return a.slice(n,s>n?s:n+1)},L=r("243936"),O=r("434487"),W=r("970766");function x(){return(x=(0,l._)(function*(e,t,r,a){var i=(0,O.nQ)(a,w._g.Transition,e),n=(0,W.do)(i.value),s=t.ensureEffect({key:i.value.key,resource:i.value},n,{needUnzip:!0});return yield s.waitForResourceValueReady(),r.resourceRecords.getRecordBySegmentPath(n)})).apply(this,arguments)}var V=r("53291");var N=((a={})[a.Video=0]="Video",a[a.Combination=1]="Combination",a[a.MutablePoly=2]="MutablePoly",a[a.Mutable=3]="Mutable",a),H=(0,r("971245").yh)("lifecycle");class G{get groupMap(){return this._groupMap}build(e){var{action:t,segment:r,templateResourceKey:a}=e,i="add"===t?this._addRelation.bind(this):this._removeRelation.bind(this),n=["audio","mutableAudio"].includes(r.type)?"waves":"thumbnails",s="add"===t?e=>{var t;return null===(t=this._groupMap.get(n))||void 0===t?void 0:t.add(e)}:e=>{var t;return null===(t=this._groupMap.get(n))||void 0===t?void 0:t.delete(e)};if("combination"===r.type){var o,l=(0,M.Bc)(null!==(o=r.templateId)&&void 0!==o?o:"");l&&i(l,r.id)}if(["video","audio","combination"].includes(r.type))i((0,d.$Q)(r,this._draftPathStore),r.id),s(r.id);else if(["mutable","mutablePoly","mutableAudio"].includes(r.type)){if("end-limit"===r.id)return;i((0,d.$Q)(r,this._draftPathStore),r.id),s(r.id),(0,P.gG)(r.mutable)&&i(r.mutable.mutableId,r.id),a&&i(a,r.id),(0,P.rE)(r.mutable)&&(i(r.id,r.id),r.mutable.children.forEach(e=>{i((0,d.$Q)(e,this._draftPathStore),r.id),(0,P.gG)(e.mutable)&&i(e.mutable.mutableId,r.id)})),(0,P._n)(r.mutable)&&i(r.id,r.id)}}reset(){this._resourceKey2SegmentIds.clear(),this._groupMap.set("thumbnails",new Set),this._groupMap.set("waves",new Set)}getSegmentIdByResourceKey(e){return this._resourceKey2SegmentIds.get(e)}_addRelation(e,t){if(!!e)this._resourceKey2SegmentIds.has(e)?this._resourceKey2SegmentIds.get(e).add(t):this._resourceKey2SegmentIds.set(e,new Set([t]))}_removeRelation(e,t){var r=this._resourceKey2SegmentIds.get(e);r&&(r.delete(t),0===r.size&&this._resourceKey2SegmentIds.delete(e))}constructor(e){this._draftPathStore=e,this._groupMap=new Map,this._resourceKey2SegmentIds=new Map,this._groupMap.set("thumbnails",new Set),this._groupMap.set("waves",new Set)}}var Q=r("650248"),j=r("874800");var z=((i={}).BATCH="BATCH",i.IMMEDIATELY="IMMEDIATELY",i);var Y=((n={}).Pending="Pending",n.Ready="Ready",n.Empty="Empty",n.Error="Error",n.Timeout="Timeout",n.Complete="Complete",n);var K=((s={}).Photo="Photo",s.Video="Video",s),q=r("867713"),Z=r("677761"),J=r("914415"),X=r("772218"),$={id:Symbol.for("__parse_get_resource_sprites__"),CONCURRENCY_INIT:10,CONCURRENCY_AFTER_FIRST_FRAME:100},ee={id:Symbol.for("__parse_split__"),CONCURRENCY_INIT:0,CONCURRENCY_AFTER_FIRST_FRAME:100};class et{get onReady(){return this._onReady.event}addTask(e,t){var r,a,i=t.value.key;!this._resourceStatusMap[i]&&(this._resourceStatusMap[i]={});var n=[],s=()=>this._onReady.fire({resourceKey:i});return(e===K.Photo?this._resourceStatusMap[i].sprites=Y.Empty:e===K.Video&&!this._resourceStatusMap[i].sprites&&(t.value.type===w._g.UserVideo&&(null===(r=t.value.thumb)||void 0===r?void 0:r.isFromFallback)?this._resourceStatusMap[i].sprites=Y.Error:n.push(this._parseSprites(t,i).then(s))),!this._resourceStatusMap[i].cover&&(t.value.type!==w._g.UserVideo||!(null===(a=t.value.cover)||void 0===a?void 0:a.isFromFallback))&&n.push(this._parseCover(t,i).then(s)),n.length)?n[0]:Promise.resolve()}_parseCover(e,t){var r=this;return(0,l._)(function*(){var a=setTimeout(()=>{r._resourceStatusMap[t].cover=Y.Timeout},0);try{r._resourceStatusMap[t].cover=Y.Pending;var i=yield e_(e);r._store[_].setCover(t,i),r._resourceStatusMap[t].cover=Y.Ready}catch(e){r._resourceStatusMap[t].cover=Y.Error}finally{clearTimeout(a)}})()}_parseSprites(e,t){var r=this;return(0,l._)(function*(){var a,i=setTimeout(()=>{r._resourceStatusMap[t].sprites=Y.Timeout},0);return r._resourceStatusMap[t].sprites=Y.Pending,new Promise((a=(0,l._)(function*(a){yield r._graphicToolkitServiceBarrier.wait();var{getResourceSpritesTask:n,splitSpritesTask:s}=(0,J.wX)(e,r._graphicToolkitService),o=yield new Promise(e=>{r._schedulerService.postTask(()=>{e(n())},{groupId:$.id,priorityLevel:q.q.IdlePriority})});r._schedulerService.postTask((0,l._)(function*(){try{var e=yield s(o);r._store[_].setSprites(t,e),r._resourceStatusMap[t].sprites=Y.Ready}catch(e){r._resourceStatusMap[t].sprites=Y.Error}finally{clearTimeout(i)}a()}),{groupId:ee.id,priorityLevel:q.q.IdlePriority})}),function(e){return a.apply(this,arguments)}))})()}afterFirstFrame(){this._schedulerService.updateGroup($.id,{groupId:$.id,concurrency:$.CONCURRENCY_AFTER_FIRST_FRAME}),this._schedulerService.updateGroup(ee.id,{groupId:ee.id,concurrency:ee.CONCURRENCY_AFTER_FIRST_FRAME})}constructor(e,t,r,a,i){this._store=e,this._resourceStatusMap=t,this._schedulerService=r,this._teaAdapterService=i,this._onReady=new v.Q,this._graphicToolkitServiceBarrier=new g.U,this._schedulerService.registerGroup({groupId:$.id,concurrency:$.CONCURRENCY_INIT}),this._schedulerService.registerGroup({groupId:ee.id,concurrency:ee.CONCURRENCY_INIT}),a.getInstance().then(e=>{this._graphicToolkitService=e,this._graphicToolkitServiceBarrier.open()}),this._teaAdapterService.getABTestVar("ccweb_new_snapshot_thumb",{enable:!1}).then(e=>{var{enable:t=!1}=e;b.k92.getInstance().setIncrThumbDensity(t)})}}et=(0,h.gn)([(0,h.fM)(2,X.B),(0,h.fM)(3,L.r),(0,h.fM)(4,Z.w),(0,h.w6)("design:type",Function),(0,h.w6)("design:paramtypes",["undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof ResourceStatusMap?Object:ResourceStatusMap,void 0===X.B?Object:X.B,void 0===L.r?Object:L.r,void 0===Z.w?Object:Z.w])],et);class er{get onReady(){return this._onReady.event}addTask(e){var{resourceKey:t,sprites:r}=e;!this._resourceStatusMap[t]&&(this._resourceStatusMap[t]={}),this._setSpritesByTimestamp({resourceKey:t,sprites:r}),this._onReady.fire({resourceKey:t})}_calculateSpritesBySpeed(e,t){var r;return e.speed.mode===b.yY$.SpeedModeNormal?t.map(t=>(0,c._)((0,u._)({},t),{timestamp:BigInt(Math.floor(b.pMA.div(t.sourceTimestamp,e.speed.speed)))})):(null===(r=e.speed.curveSpeed)||void 0===r?void 0:r.speedPoints.length)?t.map(t=>(0,c._)((0,u._)({},t),{timestamp:BigInt(new b.Cd0().mapTrimDeltaToSeqDelta(t.sourceTimestamp,e.targetTimerange.duration,e.speed.curveSpeed.speedPoints))})):t}_updateSpritesBySpeed(e,t){var r=this._mainDraftService.dataSdk.draftView.getSegmentById(e);return r&&(0,b.duj)(r)&&(r.speed.mode!==b.yY$.SpeedModeNormal||1!==r.speed.speed)?(r.materialDraft.draft.getAllSegments().filter(b.hey).forEach(e=>{var t;this._store[_].setSprites(e.material.id,this._calculateSpritesBySpeed(e,[...null!==(t=this._store[_].sprites[e.material.id])&&void 0!==t?t:[]]))}),this._calculateSpritesBySpeed(r,t)):t}_setSpritesByTimestamp(e){var t,r=function(e){var t=n.findIndex(t=>t.timestamp===e.timestamp);t>-1?n[t]=e:(n.push(e),i.sort((e,t)=>b.pMA.minus(e.timestamp,t.timestamp)))},{resourceKey:a,sprites:i}=e;this._resourceStatusMap[a].sprites=Y.Pending;var n=[...null!==(t=this._store[_].sprites[a])&&void 0!==t?t:[]];for(var s of i)r(s);this._store[_].setSprites(a,this._updateSpritesBySpeed(a,n)),this._resourceStatusMap[a].sprites=Y.Ready}constructor(e,t,r){this._store=e,this._resourceStatusMap=t,this._mainDraftService=r,this._onReady=new v.Q}}er=(0,h.gn)([(0,h.fM)(2,S.n),(0,h.w6)("design:type",Function),(0,h.w6)("design:paramtypes",["undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof ResourceStatusMap?Object:ResourceStatusMap,void 0===S.n?Object:S.n])],er);var ea=r("816262");class ei{get onReady(){return this._onReady.event}addTask(e,t){!this._resourceStatusMap[t]&&(this._resourceStatusMap[t]={}),!this._resourceStatusMap[t].waves&&(this._genWaves(e,t),this._onReady.fire({resourceKey:t}))}_genWaves(e,t){this._resourceStatusMap[t].waves=Y.Pending;var r=(0,ea.V)(e).map(e=>({timestamp:0n,strength:e}));this._store[_].setWaves(t,r),this._resourceStatusMap[t].waves=Y.Ready}constructor(e,t){this._store=e,this._resourceStatusMap=t,this._onReady=new v.Q}}class en{get onReady(){return this._onReady.event}addTask(e,t){var{resourceKey:r}=t;return(!this._resourceStatusMap[r]&&(this._resourceStatusMap[r]={}),this._resourceStatusMap[r].sprites)?Promise.resolve():this._parseSlotSprites(e,t).then(()=>{this._onReady.fire({resourceKey:r})})}_parseSlotSprites(e,t){var r=this;return(0,l._)(function*(){var{resourceKey:a,templateSprites:i}=t;r._resourceStatusMap[a].sprites=Y.Pending;try{var{start:n,duration:s}=t,o=yield(0,d.$8)(e);if(r._store[_].sprites[a])throw r._resourceStatusMap[a].sprites=Y.Ready,Error("template slot sprites already exists");var l=i.length,u=Math.round(b.pMA.div(n,o)*l),c=Math.round(b.pMA.div(n+s,o)*l),h=i.slice(u,c>u?c:u+1);r._store[_].setSprites(a,h),r._resourceStatusMap[a].sprites=Y.Ready}catch(e){r._resourceStatusMap[a].sprites=Y.Error}})()}constructor(e,t){this._store=e,this._resourceStatusMap=t,this._onReady=new v.Q}}var es=((o={}).TOTAL_SPEND="total_spend",o.GENERATE_COLLECTION_MAP="generate_collection_map",o.SYNC_FROM_DATA_SDK="sync_from_data_sdk",o.SYNC_FROM_TRANSIENT_DATA="sync_from_transient_data",o.RENDERER_UPDATE="renderer_update",o.COORDINATE_UPDATE="coordinate_update",o.RESOURCE_UPDATE="resource_update",o),eo=new Map,ed=new Map;window&&(window.printResourceRenderCount=()=>{var e;console.log("\u300CprintResourceRenderCount\u300D: ",null!==(e=ed.get("resource_update"))&&void 0!==e?e:0)});class el extends j.JT{get onResourceReady(){return this._onResourceReady.event}get _immediately(){return this._mode===z.IMMEDIATELY}stopBatchMode(){this._mode=z.IMMEDIATELY,this._broadcastIfNeed()}isResourcePending(e){var t=this._resourceStatusMap[e];return!!t&&(t.sprites!==Y.Ready&&t.sprites!==Y.Complete&&t.cover===Y.Pending||t.cover!==Y.Ready&&t.cover!==Y.Complete&&t.sprites===Y.Pending)}parsePhoto(e){return this._parseTask.addTask(K.Photo,e)}parseVideo(e){return this._parseTask.addTask(K.Video,e)}parseSlotSprites(e,t){return this._templateSlotTask.addTask(e,t)}setSprites(e){return this._captureTask.addTask(e)}genWaves(e,t){return this._genWaveTask.addTask(e,t)}_calcBatchUpdateCount(){var{isTemplate:e}=this._timelineManagerStore[p],t=(e?this._timelineManagerStore[p].tracksMutable:this._timelineManagerStore[p].tracks).flatMap(e=>{var[t]=e;return t.segments.filter(d._k)}).length;t>200?this._batchUpdateCount=Math.floor(.2*t):t>150?this._batchUpdateCount=40:t>70?this._batchUpdateCount=30:this._batchUpdateCount=Math.min(t,20)}_broadcastIfNeed(){this._rafId&&window.cancelAnimationFrame(this._rafId),this._rafId=window.requestAnimationFrame(()=>{this._rafId=void 0;var e=this._collect();this._immediately||e.length>=this._batchUpdateCount?this._broadcast(e):this._throttleBroadcast()})}_collect(){return Array.from(Array.from(Object.keys(this._resourceStatusMap)).filter(e=>{var t=this._resourceStatusMap[e];return t.waves===Y.Ready||t.sprites===Y.Ready||t.cover===Y.Ready&&(t.sprites===Y.Empty||t.sprites===Y.Error||t.sprites===Y.Timeout)}).reduce((e,t)=>{var r;return null===(r=this._relation.getSegmentIdByResourceKey(t))||void 0===r||r.forEach(t=>e.add(t)),e},new Set))}_broadcast(e){t=es.RESOURCE_UPDATE,eo.set(t,Date.now()),this._throttleBroadcast.cancel();var t,r,a,i,n,s,o=null!=e?e:this._collect();if(o.length>0){;r=es.RESOURCE_UPDATE,i=null!==(a=ed.get(r))&&void 0!==a?a:0,ed.set(r,i+1),this._onResourceReady.fire({segmentIds:o}),Object.values(this._resourceStatusMap).forEach(e=>{e.waves===Y.Ready&&(e.waves=Y.Complete),e.cover===Y.Ready&&(e.cover=Y.Complete),e.sprites===Y.Ready&&(e.sprites=Y.Complete)}),n=es.RESOURCE_UPDATE,s=eo.get(n),eo.delete(n),s&&console.log("\u300Ctimeline-performance\u300D: ".concat(n),Date.now()-s)}}afterFirstFrame(){this._parseTask.afterFirstFrame()}constructor(e,t,r,a,i,n){super(),this._timelineManagerStore=e,this._relation=t,this._dataSdk=r,this._segmentSelection=a,this._draftDataSynchronizer=i,this._containerService=n,this._onResourceReady=new v.Q,this._resourceStatusMap={},this._mode=z.BATCH,this._batchUpdateCount=20,this._throttleBroadcast=(0,Q.default)(this._broadcast.bind(this),3e3,{leading:!1}),this._parseTask=this._containerService.createInstance(et,this._timelineManagerStore,this._resourceStatusMap),this._captureTask=this._containerService.createInstance(er,this._timelineManagerStore,this._resourceStatusMap),this._genWaveTask=this._containerService.createInstance(ei,this._timelineManagerStore,this._resourceStatusMap),this._templateSlotTask=this._containerService.createInstance(en,this._timelineManagerStore,this._resourceStatusMap),this._register(this._parseTask.onReady(this._broadcastIfNeed.bind(this))),this._register(this._captureTask.onReady(this._broadcastIfNeed.bind(this))),this._register(this._genWaveTask.onReady(this._broadcastIfNeed.bind(this))),this._register(this._templateSlotTask.onReady(this._broadcastIfNeed.bind(this))),this._timelineManagerStore[p].isTemplate?this._register(this._draftDataSynchronizer.onFullTracksMutableChange(this._calcBatchUpdateCount.bind(this))):this._register(this._draftDataSynchronizer.onFullTracksChange(this._calcBatchUpdateCount.bind(this))),this._register(this._dataSdk.onChangeDiff(e=>{if(e.actionOperateType!==b.aWQ.History&&!e.isRecovery)(e[b.u4I.SEGMENT].length||e[b.u4I.TRACK].length)&&this.stopBatchMode()})),this._register(this._segmentSelection.onExpandedSegmentIdChange(e=>{e&&this._mode===z.BATCH&&this.stopBatchMode()}))}}el=(0,h.gn)([(0,h.fM)(5,I.t),(0,h.w6)("design:type",Function),(0,h.w6)("design:paramtypes",["undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof IResourceRelation?Object:IResourceRelation,"undefined"==typeof IDataSdk?Object:IDataSdk,"undefined"==typeof SegmentSelection?Object:SegmentSelection,"undefined"==typeof IDraftDataSynchronizer?Object:IDraftDataSynchronizer,void 0===I.t?Object:I.t])],el);class eu{get templateResourceKey(){var e,t=(0,y.JY)(this._environmentService)?this._environmentService.currentTemplateId:null,r=null!==(e=this._store.timelineSelectionStore.subDraftTemplateId)&&void 0!==e?e:t;return r&&(0,M.Bc)(r)}get templateIdToInfo(){return this._store[_].templateIdToInfo}get onRestored(){return this._lifeCycleService.onRestored}get resourceErrorManager(){return this._resourceErrorManager}get _templateDuration(){if(!this.templateResourceKey)return 0n;var e=this._resourceService.get(this.templateResourceKey,w._g.VideoTemplate);return e&&(0,T.R)(e.value)?f.h.secondToUs(e.value.duration):0n}setRenderManager(e){this._renderManager=e,e.onFirstFrameRender(()=>{this._screenshotManager.restore(N.MutablePoly,N.Mutable,N.Combination),this._resourceScheduler.afterFirstFrame()})}preload(e){var t={[R.r.Video]:w._g.Video,[R.r.UserVideo]:w._g.UserVideo,[R.r.Photo]:w._g.Photo,[R.r.UserPhoto]:w._g.UserPhoto,[R.r.Gif]:w._g.Gif},{type:r,value:a}=e,i=t[r],n=function(e,t){var r=C[e],a=U[e];switch(e){case R.r.UserPhoto:case R.r.UserVideo:case R.r.DigitalHuman:case R.r.Photo:case R.r.Video:case R.r.VideoTemplate:case R.r.Gif:var i,n,s=D(e,t),o=null!==(n=null!==(i=t.title)&&void 0!==i?i:t.filename)&&void 0!==n?n:"video clip";return{commonKeyframes:[],duration:s,id:F(),keyframesMap:new Map,metaType:a,start:0n,slots:[],title:o,type:r,prolong:{duration:s,start:0n,total:s},sourceTimeRange:{start:0n,duration:s},originalTargetStart:0n,originalTargetDuration:s};case R.r.UserAudio:case R.r.Audio:var d,l,u=null!==(l=null!==(d=t.filename)&&void 0!==d?d:t.title)&&void 0!==l?l:"",c=D(e,t);return{commonKeyframes:[],duration:c,id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:u,type:r,prolong:{duration:c,start:0n,total:c},sourceTimeRange:{start:0n,duration:c},originalTargetStart:0n,originalTargetDuration:c};case R.r.BasicText:case R.r.BrandText:case R.r.TextPreset:case R.r.TextTemplate:var h=t.name,p=D(e,t);return{commonKeyframes:[],duration:p,id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:h,type:r,prolong:{duration:0n,start:0n,total:BigInt(Number.MAX_SAFE_INTEGER)},sourceTimeRange:{start:0n,duration:0n},originalTargetStart:0n,originalTargetDuration:p};case R.r.Filter:var _=t.name,f=D(e,t);return{commonKeyframes:[],duration:f,id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:_,type:r,prolong:{duration:0n,start:0n,total:BigInt(Number.MAX_SAFE_INTEGER)},sourceTimeRange:{start:0n,duration:0n},originalTargetStart:0n,originalTargetDuration:f};case R.r.AdjustmentPreset:var{title:v}=t;return{commonKeyframes:[],duration:D(e,t),id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:v,type:r,prolong:{duration:0n,start:0n,total:BigInt(Number.MAX_SAFE_INTEGER)},sourceTimeRange:{start:0n,duration:0n},originalTargetStart:0n,originalTargetDuration:D(e,t)};case R.r.Sticker:var g=t.name,m=D(e,t);return{commonKeyframes:[],duration:m,id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:g,type:r,prolong:{duration:0n,start:0n,total:BigInt(Number.MAX_SAFE_INTEGER)},sourceTimeRange:{start:0n,duration:0n},originalTargetStart:0n,originalTargetDuration:m};case R.r.Effects:var{name:y}=t,S=D(e,t);return{commonKeyframes:[],duration:S,id:F(),keyframesMap:new Map,metaType:a,slots:[],start:0n,title:y,type:r,prolong:{duration:0n,start:0n,total:BigInt(Number.MAX_SAFE_INTEGER)},sourceTimeRange:{start:0n,duration:0n},originalTargetStart:0n,originalTargetDuration:S};case R.r.Transition:var{name:M}=t;return{id:F(),type:C[w._g.Transition],duration:D(e,t),title:M,isOverlap:!1,segmentId:""};default:throw Error("".concat(e," transfer to UITimelineSegment is not implement"))}}(e.type,e.value);if(!!i&&!!(0,P.IM)(n)){var s=(0,O.nQ)(this._resourceService,i,a);this._observeResource(n,s.value.key,i)}}observe(e){var{segment:t,templateResourceKey:r}=e;this._relation.build({action:"add",segment:t,templateResourceKey:r}),(0,P.rE)(t.mutable)?t.mutable.children.forEach(e=>{this._parseSlotResource({segment:e,templateResourceKey:r}),this._observeResource(e)}):(0,P.gG)(t.mutable)&&this._parseSlotResource(e),this._observeResource(t)}disconnect(e){var{segment:t,templateResourceKey:r}=e;this._relation.build({action:"remove",segment:t,templateResourceKey:r})}getMutableDefaultCover(e){var t,r="",{covers:a,defaultCover:i}=this._store[_];if((0,P.gG)(e.mutable)){var n,s=e.mutable.coverPath;!a[r=null!==(n=this._draftPathStore.getResourceKeyFromDraftPath(null!=s?s:""))&&void 0!==n?n:""]&&s&&(r=s)}var{templateResourceKey:o}=this,d=o?a[o]:i;return r?null!==(t=a[r])&&void 0!==t?t:d:i}getCover(e){var{covers:t,defaultCover:r}=this._store[_];switch(e.type){case"video":var a=(0,d.$Q)(e,this._draftPathStore);return a?t[a]:void 0;case"mutable":var i,n,s,{templateResourceKey:o}=this;if(!o)return r;var{locked:l}=null==e?void 0:e.mutable;if(l)return null!==(i=t[o])&&void 0!==i?i:r;return null!==(s=null!==(n=t[(0,d.$Q)(e,this._draftPathStore)])&&void 0!==n?n:t[o])&&void 0!==s?s:r;case"mutablePoly":var u,c,h,{templateResourceKey:p}=this;if(!p)return r;var{children:f=[]}=e.mutable,v=f.find(e=>{var t;return null===(t=e.mutable)||void 0===t?void 0:t.filled});if(!v)return null!==(u=t[p])&&void 0!==u?u:r;return null!==(h=null!==(c=t[(0,d.$Q)(v,this._draftPathStore)])&&void 0!==c?c:t[p])&&void 0!==h?h:r;default:return}}getSpritesByKey(e){return this._store[_].sprites[e]}getSprites(e){var{sprites:t}=this._store[_];switch(e.type){case"video":var r=(0,d.$Q)(e,this._draftPathStore);return r?t[r]:void 0;case"mutable":var{templateResourceKey:a}=this;if(!a)return;var{start:i,duration:n}=e,{locked:s}=null==e?void 0:e.mutable;if(s){var o,l=this._templateDuration;if(t[e.id])return t[e.id];return(null===(o=t[a])||void 0===o?void 0:o.length)?B(i,n,l,t[a]):void 0}(0,d.$Q)(e,this._draftPathStore);var{mutableId:u,filled:c}=null==e?void 0:e.mutable;return t[u];case"mutablePoly":var{children:h=[]}=e.mutable,p=h.find(e=>{var t;return null===(t=e.mutable)||void 0===t?void 0:t.filled});if(p){var f,v=(0,d.$Q)(p,this._draftPathStore);return null!==(f=t[e.id])&&void 0!==f?f:t[v]}if(t[e.id])return t[e.id];return h.map(e=>{var r;return t[null===(r=e.mutable)||void 0===r?void 0:r.mutableId]}).reduce((e,t)=>[...e,...t||[]],[]);case"combination":var g,m=(0,d.$Q)(e,this._draftPathStore);if(t[m])return t[m];var y=(0,M.Bc)(null!==(g=e.templateId)&&void 0!==g?g:"");if(y&&t[y])return t[y];var{defaultSprite:S}=this._store[_];if(S)return[S];return;default:return}}clearSprites(e){if(!!e)delete this._store[_].sprites[e]}resetSpritesByKey(e){var t;(null===(t=this._store[_].sprites[e])||void 0===t?void 0:t.length)&&this._store[_].setSprites(e,[])}setSpritesByTimestamp(e){this._resourceScheduler.setSprites(e)}getScreenshots(e){var t=this.getSprites(e);if(null==t?void 0:t.length)return t;var r=this.getCover(e);if(r){if("mutable"===e.type){var a,i=null===(a=e.mutable)||void 0===a?void 0:a.filled,n=(0,d.$Q)(e,this._draftPathStore);if(i&&this._resourceScheduler.isResourcePending(n))return}return[(0,c._)((0,u._)({},r),{timestamp:0n})]}}getSourceWaves(e){var{type:t}=e,r=(0,d.$Q)(e,this._draftPathStore);if(!!r&&("audio"===t||"mutableAudio"===t))return this._store[_].waves[r]}getTemplateInfo(e){var t=this;return(0,l._)(function*(){(0,m.Y2)(t._bootstrapBarrier.isOpen(),"get template should called after bootstrap");var r=yield t._mainDraftService.draftTemplateManager.getTemplate(e);return t._store[_].setTemplateInfo(e,r),r})()}setTemplateInfo(e,t){this._store[_].setTemplateInfo(e,t)}bootstrap(){var e=this;return(0,l._)(function*(){yield e._initDefaultResource(),e._bootstrapBarrier.open()})()}reset(){this._relation.reset(),this._bootstrapBarrier=new g.U,this._templateSpritesBarrier=new g.U}checkTransitionResource(e){var t=this;return(0,l._)(function*(){return!!(yield function(e,t,r,a){return x.apply(this,arguments)}(e,t._ensureManager,t._renderManager,t._resourceService))})()}getResourceKeyByPath(e){return this._mainDraftService.draftPathStore.getResourceKeyFromDraftPath(e)}updateFailSegments(e){var t=Object.entries(e).reduce((e,t)=>{var[r,a]=t;return a===V._3&&e.add(r),e},new Set);this._store[_].setFailSegments(t)}_barrierExecute(e,t){e.isOpen()?t():e.wait().then(()=>t())}setDefaultSprite(e){this._store[_].setDefaultSprite({image:e,x:0,y:0,width:e.width,height:e.height,timestamp:0n,sourceTimestamp:0n}),this._store[_].setDefaultCover({image:e,width:e.width,height:e.height,timestamp:0n,sourceTimestamp:0n})}getDefaultCover(){return this._store[_].defaultCover}_initDefaultResource(){var e=this;return(0,l._)(function*(){var{subDraftSegments:t}=e._store.timelineSelectionStore,r=(0,y.JY)(e._environmentService)?[e.templateResourceKey]:t.map(e=>(0,M.Bc)(e.templateId));yield Promise.all(r.map(t=>e._parseTemplateCoverAndSprites(t))),e._templateSpritesBarrier.open()})()}_parseTemplateCoverAndSprites(e){var t=this;return(0,l._)(function*(){var r=t._resourceService.get(e,w._g.VideoTemplate);if(!!r){var{resourceStore:a}=t._store;(!a.covers[e]||!a.sprites[e])&&(yield t._resourceScheduler.parseVideo(r))}})()}_parseSlotSprites(e){var{segment:t,templateResourceKey:r}=e,{resourceStore:a}=this._store;if("mutable"!==t.type||!(0,P.gG)(t.mutable)||a.sprites[t.mutable.mutableId]||!r)return;var i=a.sprites[r],n=this._resourceService.get(r,w._g.VideoTemplate);if(!!i&&!!n)this._resourceScheduler.parseSlotSprites(n,{resourceKey:t.mutable.mutableId,start:t.start,duration:t.duration,templateSprites:i})}_parseSlotCover(e){if("mutable"!==e.type||!(0,P.gG)(e.mutable)||!e.mutable.coverPath)return;var{coverPath:t}=e.mutable,r=this._draftPathStore.getResourceKeyFromDraftPath(t);if(!!r&&!this._store[_].covers[r]){var a=this._resourceService.get(r,w._g.UserPhoto);a&&this._observePhotoResource(a)}}_parseSlotResource(e){this._barrierExecute(this._bootstrapBarrier,()=>this._parseSlotCover(e.segment)),this._barrierExecute(this._templateSpritesBarrier,()=>this._parseSlotSprites(e))}_observeVideoTemplateResource(e){var{resource:t,resourceKey:r,templateResourceKey:a}=e,{resourceStore:i}=this._store;if(!!t){var n=i.sprites[a],s=i.covers[a],o=i.sprites[r];(!n||!o||!s)&&this._resourceScheduler.parseVideo(t)}}_observeVideoResource(e){var t=e.value.key,r=this._store[_].sprites[t],a=this._store[_].covers[t];(!r||!a)&&this._resourceScheduler.parseVideo(e)}_observePhotoResource(e){var t=e.value.key;!this._store[_].covers[t]&&this._resourceScheduler.parsePhoto(e)}_observeAudioResource(e,t){var r;if(null===(r=this._store[_].waves[t])||void 0===r?!void 0:!r.length)this._resourceScheduler.genWaves(e.duration,t)}_parsePreviewDigitalHuman(e,t){if(t===w._g.DigitalHuman)return function(e,t,r,a){var i=e.draftView.getSegmentById(a);if(!i||!(0,b.ot2)(i))return;var[n]=function(e){if(!(0,b.ot2)(e)||!e.materialDraft)return[];var t,r,a=e.materialDraft.draft.getSegmentsByTrackType(b.pNd.TrackTypeVideo);if(!a.length)return[];var i=null===(r=e.materialDraft.draft.getMainTrack())||void 0===r?void 0:null===(t=r.segments)||void 0===t?void 0:t[0];return a.sort((e,t)=>e.id===(null==i?void 0:i.id)?-1:t.id===(null==i?void 0:i.id)?1:e.targetTimerange.duration-t.targetTimerange.duration>0n?-1:1),a}(i);if(!!n){var s=r(n.material.path);if(s)return t.get(s,w._g.Video)}}(this._dataSdk,this._resourceService,this._draftPathStore.getResourceKeyFromDraftPath.bind(this._draftPathStore),e)}_observeResource(e,t,r){var a=this;return(0,l._)(function*(){var i=null!=t?t:(0,d.$Q)(e,a._draftPathStore),n=null!=r?r:(0,d.Q5)(e.id,a._dataSdk);switch(n){case w._g.DigitalHuman:case w._g.Video:case w._g.UserVideo:var s=i?a._resourceService.get(i,n):void 0;!s&&(s=a._parsePreviewDigitalHuman(e.id,n)),s&&a._observeVideoResource(s);break;case w._g.Gif:var o=i?a._resourceService.get(i,n):void 0;o&&a._observePhotoResource(o);break;case w._g.Photo:case w._g.UserPhoto:var l=i?a._resourceService.get(i,n):void 0;l&&a._observePhotoResource(l);break;case w._g.Audio:case w._g.UserAudio:a._observeAudioResource(e,i);break;case w._g.VideoTemplate:yield a._bootstrapBarrier.wait();var{templateId:u}=e;if(u){var c=(0,M.Bc)(u),h=a._resourceService.get(c,n);a._observeVideoTemplateResource({segment:e,resource:h,resourceKey:i,templateResourceKey:c})}}})()}constructor(e,t,r,a,i,n,s,o,d,l,u,c,h,p,_){this._dataSdk=e,this._renderManager=t,this._draftPathStore=r,this._store=a,this._screenshotManager=i,this._ensureManager=n,this._resourceErrorManager=s,this._segmentSelection=o,this._draftDataSynchronizer=d,this._resourceService=l,this._environmentService=u,this._mainDraftService=h,this._lifeCycleService=p,this._containerService=_,this._onThumbnailsChange=new v.Q,this._onWavesChange=new v.Q,this._bootstrapBarrier=new g.U,this._templateSpritesBarrier=new g.U,this.getResourceByKey=this._resourceService.get.bind(this),this.onThumbnailsChange=this._onThumbnailsChange.event,this.onWavesChange=this._onWavesChange.event,this._relation=this._containerService.createInstance(G,this._draftPathStore),this._resourceScheduler=this._containerService.createInstance(el,this._store,this._relation,this._dataSdk,this._segmentSelection,this._draftDataSynchronizer),this._resourceScheduler.onResourceReady(e=>{var{segmentIds:t}=e,r=this._relation.groupMap.get("thumbnails"),a=this._relation.groupMap.get("waves"),i=[],n=[];t.forEach(e=>{(null==r?void 0:r.has(e))&&i.push(e),(null==a?void 0:a.has(e))&&n.push(e)}),i.length>0&&this._onThumbnailsChange.fire({segmentIds:i}),n.length>0&&this._onWavesChange.fire({segmentIds:n})})}}eu=(0,h.gn)([(0,h.fM)(9,k.c),(0,h.fM)(10,y.rO),(0,h.fM)(11,L.r),(0,h.fM)(12,S.n),(0,h.fM)(13,H),(0,h.fM)(14,I.t),(0,h.w6)("design:type",Function),(0,h.w6)("design:paramtypes",["undefined"==typeof IDataSdk?Object:IDataSdk,"undefined"==typeof RenderManager?Object:RenderManager,"undefined"==typeof DraftPathStore?Object:DraftPathStore,"undefined"==typeof TimelineManagerStore?Object:TimelineManagerStore,"undefined"==typeof IScreenshotManager?Object:IScreenshotManager,"undefined"==typeof IEnsureManager?Object:IEnsureManager,"undefined"==typeof ResourceErrorManager?Object:ResourceErrorManager,"undefined"==typeof SegmentSelection?Object:SegmentSelection,"undefined"==typeof IDraftDataSynchronizer?Object:IDraftDataSynchronizer,void 0===k.c?Object:k.c,void 0===y.rO?Object:y.rO,void 0===L.r?Object:L.r,void 0===S.n?Object:S.n,void 0===H?Object:H,void 0===I.t?Object:I.t])],eu);var ec=r("61556"),eh=r("2910");function ep(){return(ep=(0,l._)(function*(e,t,r){var{attrs:a}=t,{compress:i}=r;return function(e,t){var r,a,i,n,{compress:s}=t;if("number"==typeof(null==(r=s)?void 0:r.width)&&r.width>0)n=(i=s.width)*e.naturalHeight/e.naturalWidth;else{;if("number"==typeof(null==(a=s)?void 0:a.height)&&a.height>0)i=(n=s.height)*e.naturalWidth/e.naturalHeight;else i=e.naturalWidth,n=e.naturalHeight}return createImageBitmap(e,{resizeWidth:i,resizeHeight:n})}((yield function(e){var{attrs:t={}}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((r,a)=>{var i=new Image;for(var[n,s]of Object.entries(t))i[n]=s;i.onload=()=>r(i),i.onerror=(e,t,r,i,n)=>{a(n)},i.src=(0,eh.C)(e,null,{logType:"js.href/src",reportOnly:"false",blackConfig:"{}",configMode:"merge",isCloseSSRReport:!1,bid:"cc_dreamina",region:"cn",urlLimit:"-1",htmlLimit:"-1",isSaveValidUrl:!1,isRuntimeLog:!1,isDOMParser:!1,escapeRule:"escape-report"})})}(e,{attrs:a})),{compress:i})})).apply(this,arguments)}function e_(e){var t=e.getCoverResourceToken();return t.startImmediately(),new Promise((e,r)=>{(0,ec.x)(t).then(t=>{if(!t.ok)throw Error(t.msg);var{value:r}=t;if(r.buffer){var a=(0,d.Aw)(r.buffer);(function(e,t,r){return ep.apply(this,arguments)})(a,{attrs:{crossOrigin:"anonymous"}},{compress:{height:102}}).then(t=>{e({image:t,width:t.width,height:t.height,coverUrl:a,timestamp:0n,sourceTimestamp:0n})})}})})}},914415:function(e,t,r){r.d(t,{wX:()=>p,AB:()=>c});var a,i=r("876826"),n=r("61556"),s=r("243936"),o=r("56935");var d=(a=(0,i._)(function*(e,t,r){var a=[],i=[],n=new Map;for(var d of e){var l=function(e){i.push(createImageBitmap(e.graphic).then(t=>(n.set(e,t),t)))},{buffer:u,mimeType:c,frameCount:h,imageWidth:p,imageHeight:_,singleFrameHeight:f,singleFrameWidth:v}=d,g=yield t.converter.bufferToImage(u,c);(!g.ok||!g.value)&&(0,o.ss)("[TimelineResource] split sprites error"),g.value.width===p&&g.value.height!==_&&(g.value.height=_);var m=t.sprite.split({graphic:g.value,xCount:p/v,yCount:_/f,totalCount:h,compress:{height:null!=r?r:100}},s.O.Canvas);for(var y of m)l(y);a.push(...m)}try{yield Promise.all(i)}catch(e){}return a.map(e=>{var t;return{image:null!==(t=n.get(e))&&void 0!==t?t:e.graphic,x:e.x,y:e.y,width:e.width,height:e.height,timestamp:0n,sourceTimestamp:0n}})}),function(e,t,r){return a.apply(this,arguments)});function l(e){return u.apply(this,arguments)}function u(){return(u=(0,i._)(function*(e){var t=yield e.getThumbResourceTokens();try{yield Promise.all(t.map(e=>(0,n.x)(e)))}catch(e){throw e}var r=[];for(var a of t){(0,o.ZB)(a.value);var{buffer:i,contentType:s,frameCount:d,imageHeight:l,imageWidth:u,singleFrameHeight:c,singleFrameWidth:h}=a.value;r.push({buffer:i,mimeType:s,frameCount:d,imageHeight:l,imageWidth:u,singleFrameHeight:c,singleFrameWidth:h})}return r})).apply(this,arguments)}function c(e,t,r){return h.apply(this,arguments)}function h(){return(h=(0,i._)(function*(e,t,r){return d((yield l(e)),t,r)})).apply(this,arguments)}function p(e,t){return{getResourceSpritesTask:()=>l(e),splitSpritesTask:e=>d(e,t)}}},520191:function(e,t,r){r.d(t,{M:function(){return i}});var a=r(876826);function i(e){return n.apply(this,arguments)}function n(){return(n=(0,a._)(function*(e){var t=new Headers;t.append("Referer",""),t.append("range","bytes=0-2047");try{return yield fetch(e,{method:"GET",headers:t,redirect:"follow"}),!0}catch(e){return!1}})).apply(this,arguments)}},112150:function(e,t,r){function a(e,t){return String(e).padStart(t,"0")}r.d(t,{ci:function(){return n}});var i=RegExp("(?<h>\\??h+)?((?<dm>.)(?<m>\\??m+))?((?<ds>.)(?<s>\\??s+))?((?<dms>.)(?<ms>(ms)+))?((?<df>.)(?<f>(f)+))?");function n(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"?hh:mm:ss",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],{h:d,m:l,dm:u="",s:c,ds:h="",ms:p,dms:_="",f,df:v=""}=null!==(r=null===(t=i.exec(n))||void 0===t?void 0:t.groups)&&void 0!==r?r:{},g=e,m="";if(f){var y=Math.round(g%1e3/1e3*s);m="".concat(a(y,f.replace(/^\?/,"").length))}if(p&&(m="".concat(a(g%1e3,p.replace(/^\?/,"").length/2)).concat(v).concat(m)),g=Math.floor(g/1e3),c){var S=g%60;(S||!c.startsWith("?"))&&(m="".concat(a(S,c.replace(/^\?/,"").length)).concat(_||v).concat(m))}if(g=Math.floor(g/60),l){var M=g%60;if(o&&(M=g>9999?"9999+":g),(M||!l.startsWith("?"))&&(m="".concat(a(M,l.replace(/^\?/,"").length)).concat(h).concat(m)),o)return m}if(g=Math.floor(g/60),d){var T=g;(T||!d.startsWith("?"))&&(m="".concat(a(T,d.replace(/^\?/,"").length)).concat(u).concat(m))}return m}},158941:function(e,t,r){r.d(t,{ty:function(){return u}});var a=r(85728),i=r(929753),n=r(342875),s=r(150615),o=r(457435),d=r(836413),l=(e,t,r)=>t.map(e=>{var{track:t,index:n}=e;return[(0,i._)((0,a._)({},t),{segments:t.segments.filter(e=>!r.has(e.id))}),n]}).filter(t=>{var[r]=t;return e.draftView.isMainTrack(r)||r.segments.length}),u=(e,t)=>{var r=t.filter(e=>{var{type:t}=e;return"combination"===t||"video"===t||"audio"===t});if(!r.length)return(0,d.ly)();var u=e.draftView.getAllTracks().map((e,t)=>({track:e,index:t})),c=u.filter((e,t)=>t>0&&e.track.type!==n.pNd.TrackTypeAudio),h=u.filter(t=>e.draftView.isMainTrack(t.track)),p=u.filter(e=>e.track.type===n.pNd.TrackTypeAudio),_=new Set(r.map(e=>{var{id:t=""}=e;return t})),f=l(e,c,_),v=l(e,h,_),g=l(e,p,_),m=r.filter(e=>{var{type:t,newTrack:r}=e;return("video"===t||"combination"===t)&&r}),y=[...v,...f.filter(e=>{var[t]=e;return"video"===t.type})],S=e.draftView.getAllTracks().filter(e=>e.type===n.pNd.TrackTypeVideo).length;if(m.length+y.length>Math.max(o.cp,S))return(0,d.wf)(-1,s.oc.t("web_multi_track_text_cannot_add",{},"Couldn\u2019t add. There is no space for more tracks."));var M=r.filter(e=>{var{type:t,newTrack:r}=e;return"audio"===t&&r}),T=g.filter(e=>{var[t]=e;return"audio"===t.type}),k=e.draftView.getAllTracks().filter(e=>e.type===n.pNd.TrackTypeAudio).length;if(M.length+T.length>Math.max(o.Fb,k))return(0,d.wf)(-1,s.oc.t("web_multi_track_text_audio_limits",{},"Couldn\u2019t add. There is no space for more tracks."));var I=r.filter(e=>{var{type:t}=e;return"combination"===t}).map(t=>{var{trackIndex:r,targetStart:n,newTrack:s}=t,o=n,d=e.draftView.getTrackByIndex(r);if(d&&e.draftView.getDraftProperty().maintrackAdsorb&&e.draftView.isMainTrack(d)&&!s){var l=d.segments,u=l[l.length-1],c=u?u.targetTimerange.start+u.targetTimerange.duration:0n;n>c&&(o=c)}return(0,i._)((0,a._)({},t),{targetStart:o})}),w=0n,P=y.flatMap(t=>{var[r,a]=t;return r.segments.map(t=>{var i=t.targetTimerange.clone();return e.draftView.getDraftProperty().maintrackAdsorb&&e.draftView.isMainTrack(r)&&(i.start=w,w=i.start+i.duration),[{targetTimerange:i,originalSegment:t},a]}).filter(e=>{var[t]=e;return(0,n.hey)(t.originalSegment)&&n.bZh.isCombinationVideo(t.originalSegment)})}),b=e.draftView.getAllSegments();return I.some(e=>{var{id:t}=e;return!b.find(e=>e.id===t)})&&P.length+I.length>o.HW?(0,d.wf)(-1,s.oc.t("web_multi_track_text_up_to_three",{},"You can add up to 3 templates in a project")):I.some(e=>{var{targetStart:t,duration:r,trackIndex:a,newTrack:i}=e;return!P.filter(e=>{var[,t]=e;return i||t!==a}).every(e=>{var[a]=e;return t+r-33333n<=a.targetTimerange.start||t+33333n>=a.targetTimerange.start+a.targetTimerange.duration})})?(0,d.wf)(-1,s.oc.t("web_multi_track_text_can_not_added",{},"Can\u2019t add template here. Another template has already been added to this timestamp.")):(0,d.ly)()}},603968:function(e,t,r){r.d(t,{Me:function(){return o},d0:function(){return l}});var a=r(294202),i=r(529227),n=r(342875),s=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=(0,i.Gt)(e);return["video","audio","image"].includes(t)?t:"other"},o=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";switch(s(e)){case"video":return a.C3.MetaTypeVideo;case"audio":return a.C3.MetaTypeMusic;case"image":return a.C3.MetaTypePhoto;default:return a.C3.MetaTypeNone}},d=e=>{var t,r,a=[];return null===(r=e.material)||void 0===r||null===(t=r.textInfoResources)||void 0===t||t.forEach(e=>{var t,r;null==e||null===(r=e.textAnimateMaterial)||void 0===r||null===(t=r.animations)||void 0===t||t.forEach(e=>{(null==e?void 0:e.resourceId)&&a.push(e.resourceId)})}),a};function l(e){var t,r,a,i,s,o,l,u,c,h,p,_,f,v,g,m,y,S,M,T,k,I,w,P,b,R,E,D=[],A=e=>e&&D.push(e),F=e=>e.forEach(e=>A(e));return(0,n.hey)(e)&&F([null===(t=e.material)||void 0===t?void 0:t.materialId,null===(r=e.background)||void 0===r?void 0:r.imageId,null===(a=e.transition)||void 0===a?void 0:a.resourceId,e.templateId,...null!==(u=null===(s=e.animations)||void 0===s?void 0:null===(i=s.animations)||void 0===i?void 0:i.map(e=>e.resourceId))&&void 0!==u?u:[],...null!==(c=null===(o=e.videoEffects)||void 0===o?void 0:o.map(e=>e.resourceId))&&void 0!==c?c:[],...null!==(h=null===(l=e.figures)||void 0===l?void 0:l.map(e=>e.resourceId))&&void 0!==h?h:[]]),(0,n.Y9Q)(e)&&(F([null===(p=e.material)||void 0===p?void 0:p.musicId,null===(_=e.material)||void 0===_?void 0:_.effectId,null===(f=e.material)||void 0===f?void 0:f.videoId,null===(v=e.material)||void 0===v?void 0:v.textId,null===(g=e.material)||void 0===g?void 0:g.resourceId]),null===(m=e.voiceChange)||void 0===m||m.forEach(e=>{A(e.resourceId)})),(0,n.Ftn)(e)&&F([null===(y=e.material)||void 0===y?void 0:y.fontResourceId,null===(S=e.material)||void 0===S?void 0:S.fontId,e.material.captionTemplateInfo.resourceId,null===(M=e.effect)||void 0===M?void 0:M.resourceId,null===(T=e.shape)||void 0===T?void 0:T.resourceId,...BigInt(e.material.checkFlag)&n.PbZ.LightFlag?[null===(k=e.bloom)||void 0===k?void 0:k.resourceId]:[],...(null!==(w=null===(I=e.animations)||void 0===I?void 0:I.animations)&&void 0!==w?w:[]).map(e=>null==e?void 0:e.resourceId),...(null!==(P=e.effects)&&void 0!==P?P:[]).map(e=>null==e?void 0:e.resourceId)]),(0,n.Q2R)(e)&&F([e.material.resourceId,...e.material.resources.map(e=>e.resourceId),...d(e)]),(0,n.P2T)(e)&&F([null===(b=e.material)||void 0===b?void 0:b.resourceId]),(0,n.SiN)(e)&&F([null===(R=e.material)||void 0===R?void 0:R.resourceId]),(0,n.w5o)(e)&&F([null===(E=e.material)||void 0===E?void 0:E.resourceId]),D}},925658:function(e,t,r){function a(e){var{width:t,height:r}=e;if(854===t&&480===r)return{width:864,height:486};if(480===t&&854===r)return{width:486,height:864};if(486===t&&364===r)return{width:492,height:369};else if(364===t&&486===r)return{width:369,height:492};else return{width:t,height:r}}function i(e,t){var r,a,i=!1;t.width>t.height?(r=t.height,a=t.width,i=!0):(r=t.width,a=t.height);var n=Math.floor(e*a/r);return i?{width:n,height:e}:{width:e,height:n}}r.d(t,{qK:function(){return i},xn:function(){return a}})},673295:function(e,t,r){r.d(t,{H:function(){return a}});class a{getResourceKeyFromDraftPath(e){return this.draftPathResourceKeyRecord[e]?this.draftPathResourceKeyRecord[e]:null}getDraftPathFromResourceKey(e){return this.resourceKeyDraftPathRecord[e]?this.resourceKeyDraftPathRecord[e]:null}recordDraftPathToResourceKey(e,t){this.draftPathResourceKeyRecord[e]=t}recordResourceKeyToDraftPath(e,t){if(this.resourceKeyDraftPathRecord[e]){var r=this.resourceKeyDraftPathRecord[e];r!==t&&console.warn("A existed resource key has been updated from: ",r,"to: ",t)}this.resourceKeyDraftPathRecord[e]=t}constructor(){this.draftPathResourceKeyRecord={},this.resourceKeyDraftPathRecord={}}}},112843:function(e,t,r){r.d(t,{N:function(){return s}});var a=r(342875),i=r(874800),n=r(56935);class s extends i.JT{getReferenceCount(e){var t,r;return null!==(r=null===(t=this.getReferenceSegmentIds(e))||void 0===t?void 0:t.size)&&void 0!==r?r:-1}getReferenceSegmentIds(e){return this._materialsCounter.get(e)}acquire(e,t){!this._materialsCounter.has(e)&&this._materialsCounter.set(e,new Set),this._materialsCounter.get(e).add(t)}release(e,t){(0,n.Y2)(this._materialsCounter.has(e)),this._materialsCounter.get(e).delete(t)}_refreshWatcherCache(){var e=this._dataSdk.draftView.getAllSegments();for(var t of this._watchers)t.refreshCache(e);for(var r of this._customWatchers)r.refresh(this._dataSdk)}_afterChangeDiff(e){for(var t of this._watchers)t.afterChangeDiff(e,this._dataSdk);for(var r of this._customWatchers)r.afterChangeDiff(e,this._dataSdk)}constructor(e){super(),this._dataSdk=e,this._materialsCounter=new Map,this._watchers=[],this._customWatchers=[],this._register(this._dataSdk.onChangeDiff(e=>{if(e.actionOperateType===a.aWQ.History){this._materialsCounter.clear(),this._refreshWatcherCache();return}this._afterChangeDiff(e)}))}}},912013:function(e,t,r){r.d(t,{f:function(){return n}});var a=r(56935),i=r(342875);class n{refresh(e){var t=e=>{var t=this._findPath(e);t.length&&(this._cache.set(e.segmentId,t),t.forEach(t=>this._acquireByPath(e.segmentId,t)))};for(var r of e.draftView.getAiStoryAllAlternativeMaterials().values())t(r)}afterChangeDiff(e,t){if(0!==e[i.u4I.ATTACHMENT].length)for(var r of e[i.u4I.ATTACHMENT]){var{type:n}=r;if(r.item.attachmentKey===i.d3H.AiStoryAlternativeMaterial)switch(n){case i.C8.ADD:var s,{value:o}=r.item;this._whenInsertOrUpdateAttachment(null!==(s=o.material)&&void 0!==s?s:o);break;case i.C8.UPDATE:var d=t.draftView.getAiStoryAlternativeMaterialBySegmentId(r.item.key);this._whenInsertOrUpdateAttachment(d);break;case i.C8.DELETE:this._whenDeleteAttachment(r.item.key);break;default:(0,a.bP)(n)}}}_acquireByPath(e,t){this._referenceCountManager.acquire(t,"story_alternative_".concat(e))}_releaseByPath(e,t){this._referenceCountManager.release(t,"story_alternative_".concat(e))}_whenInsertOrUpdateAttachment(e){var t=this._cache.get(e.segmentId),r=this._findPath(e);if(!function(e,t){if(!e&&t||e&&!t)return!1;if(!e&&!t)return!0;if(e.length!==t.length)return!1;for(var r=[...e].sort(),a=[...t].sort(),i=0;i<r.length;++i)if(r[i]!==a[i])return!1;return!0}(t,r)){var{added:a,deleted:i}=function(e,t){var r=[],a=[];if(!e&&t)r.push(...t);else if(e&&!t)a.push(...e);else if(e&&t){for(var i=new Set(e),n=[...t],s=0;s<n.length;)i.has(n[s])?(i.delete(n[s]),n.splice(s,1)):++s;r.push(...n),a.push(...Array.from(i))}return{added:r,deleted:a}}(t,r);this._cache.set(e.segmentId,r),i.length&&i.forEach(t=>this._releaseByPath(e.segmentId,t)),a.length&&a.forEach(t=>this._acquireByPath(e.segmentId,t))}}_whenDeleteAttachment(e){var t=this._cache.get(e);if(!!t)this._cache.delete(e),t.forEach(t=>this._releaseByPath(e,t))}constructor(e){this._referenceCountManager=e,this._cache=new Map}}},394279:function(e,t,r){r.d(t,{M:function(){return n}});var a=r(56935),i=r(342875);class n{refreshCache(e){var t=e=>{var t=this._findPath(e);t&&(this._cache.set(e.id,t),this._acquireByPath(e.id,t))};for(var r of e)t(r),this._iterateSubDraftSegment(r,t)}afterChangeDiff(e,t){if(0!==e[i.u4I.SEGMENT].length)for(var r of e[i.u4I.SEGMENT]){var{type:n}=r;switch(n){case i.C8.ADD:var s=r.item.segment;this._whenInsertOrUpdateSegment(s),this._iterateSubDraftSegment(s,this._whenInsertOrUpdateSegment.bind(this));break;case i.C8.UPDATE:var o=t.draftView.getSegmentById(r.item.id);this._whenInsertOrUpdateSegment(o);break;case i.C8.DELETE:this._whenDeleteSegment(r.item.id),this._iterateSubDraftSegment(r.item.segment,e=>this._whenDeleteSegment(e.id));break;case i.C8.MOVE:break;default:(0,a.bP)(n)}}}_acquireByPath(e,t){this._referenceCountManager.acquire(t,e)}_releaseByPath(e,t){this._referenceCountManager.release(t,e)}_whenInsertOrUpdateSegment(e){var t=this._cache.get(e.id),r=this._findPath(e);if(t!==r)this._cache.set(e.id,r),t&&this._releaseByPath(e.id,t),r&&this._acquireByPath(e.id,r)}_whenDeleteSegment(e){var t=this._cache.get(e);if(!!t)this._cache.delete(e),this._releaseByPath(e,t)}_iterateSubDraftSegment(e,t){((0,i.duj)(e)||(0,i.itF)(e))&&e.materialDraft.draft.getAllSegments().forEach(e=>{t(e)})}constructor(e){this._referenceCountManager=e,this._cache=new Map}}},310592:function(e,t,r){r.d(t,{U:function(){return n}});var a=r(342875),i=r(394279);class n extends i.M{_findPath(e){if(!(0,a.Y9Q)(e))return"";var{material:t}=e,{type:r}=t;return!(null==t?void 0:t.musicId)||(null==t?void 0:t.musicId)&&r!==a.cVg.MetaTypeVideoOriginalSound?t.path:""}}},72937:function(e,t,r){r.d(t,{P:function(){return n}});var a=r(342875),i=r(394279);class n extends i.M{_findPath(e){return(0,a.hey)(e)?e.material.sourcePlatform===a.cvu.MaterialPlatformDefault?e.material.path:"":""}}},850819:function(e,t,r){r.d(t,{V:()=>p});var a=r("85728"),i=r("929753"),n=r("2046"),s="LVVE_FILL_JSON",o="LVVE_DESERIALIZE_JSON",d="LVVE_FIX_JSON",l="LVVE_UPGRADE";var u=r("342875"),c=r("460029"),h=r("457435");function p(e,t,r,p,_,f){(0,c.Ie)(o);var v=u.HHr.parse(t);(0,c.oe)(o),(0,c.Ie)(d),v=(0,u.bbM)(v,r),(0,c.oe)(d),(0,c.Ie)(l),v=(0,u.MoK)(v),(0,c.oe)(l),(0,c.Ie)(s);var g=e.getMaterialPathMap(),m=(0,i._)((0,a._)({},e.getEffectPathMap()),{[n.rH]:u.P4R.ensureRootPath(n.rv.dir),[n.aO.resourceId]:n.aO.path,[n.aO.resourceIdOnHeycan]:n.aO.path});p&&(v.id=p),"string"==typeof _&&(v.name=_),r&&Object.entries(r.oldResourceIdToNewResourceIdMap).forEach(e=>{var[t,r]=e;m[r]&&(m[t]=m[r])});var y=(0,u.Y_K)(v),S=[],M=(0,u.sU5)(v,!1,m,S),T=(0,u.GEr)(v,"texts"),k=(0,u.GEr)(v,"effects");return(0,u.SyO)(v,g),r&&(0,u.fGK)(r.rawPreloadMaterialsMap,g,y),(0,u.rts)(M,m,g,f,S),(0,u.UIg)(T,k,m),(0,u.Cg6)(v,T,k),!function(e){var t=null==e?void 0:e.canvas_config;if(!!t&&!!(null==t?void 0:t.dom_width)&&!!(null==t?void 0:t.dom_height)){var r=function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[h.fQ.width,h.fQ.height],[a,i]=e;if(!(a>0)||!(i>0))return r;var[n,s]=r;return[(t=a/i<n/s?s/i:n/a)*a,t*i]}([t.dom_width,t.dom_height]);e.canvas_config.dom_width=r[0],e.canvas_config.dom_height=r[1]}}(v),(0,c.oe)(s),v}},292574:function(e,t,r){r.d(t,{t:function(){return o}});var a=r(897727),i=r(294202),n=r(342875),s={third_resource_tuchong_deposit:i.n9.MaterialPlatformTuchongDeposit,third_resource_tuchong_adobe:i.n9.MaterialPlatformTuchongAdobe,third_resource_tuchong_pond5:i.n9.MaterialPlatformTuchongPond5},o={toHeycanEffectType:function(e){switch(e){case n.cVg.MetaTypeTextEffect:return a.g.WordArt;case n.cVg.MetaTypeSticker:return a.g.Sticker;case n.cVg.MetaTypeSound:return a.g.AudioEffect;case n.cVg.MetaTypeMusic:return a.g.Song;case n.cVg.MetaTypeVideo:return a.g.Video;case n.cVg.MetaTypeTextTemplate:return a.g.TextTemplate;case n.cVg.MetaTypeVideoEffect:return a.g.SpecialEffect;case n.cVg.MetaTypeFaceEffect:return a.g.FaceTool;case n.cVg.MetaTypePhoto:return a.g.Image;case n.cVg.MetaTypeFilter:return a.g.Filter;default:throw Error("unknown meta type ".concat(e))}},toMetaType:function(e){switch(e){case a.g.WordArt:return n.cVg.MetaTypeTextEffect;case a.g.Sticker:return n.cVg.MetaTypeSticker;case a.g.AudioEffect:return n.cVg.MetaTypeSound;case a.g.Song:return n.cVg.MetaTypeMusic;case a.g.Video:return n.cVg.MetaTypeVideo;case a.g.TextTemplate:return n.cVg.MetaTypeTextTemplate;case a.g.SpecialEffect:return n.cVg.MetaTypeVideoEffect;case a.g.FaceTool:return n.cVg.MetaTypeFaceEffect;case a.g.Image:return n.cVg.MetaTypePhoto;case a.g.Filter:return n.cVg.MetaTypeFilter;default:return n.cVg.MetaTypeNone}},toSourcePlatform:(e,t)=>{var r;switch(e){case i.Hw.HEYCAN:return n.nj7.EffectPlatformArtist;case i.Hw.LOKI:return n.nj7.EffectPlatformLoki;case i.Hw.MUSIC:return n.QZ3.AudioPlatformLibrary;case i.Hw.TUCHONG:if(r=t&&s[t])return r;case i.Hw.BRAND:return n.cvu.MaterialPlatformBrand;default:return n.nj7.EffectPlatformArtist}},formatEffectSourcePlatform:e=>{switch(e){case i.Hw.HEYCAN:return n.nj7.EffectPlatformArtist;case i.Hw.BRAND:return n.nj7.EffectPlatformBrand;case i.Hw.LOKI:default:return n.nj7.EffectPlatformLoki}},transformPersistLVVEEffectSourcePlatformToSourcePlatform:e=>{switch(e){case n.nj7.EffectPlatformArtist:return i.Hw.HEYCAN;case n.nj7.EffectPlatformBrand:return i.Hw.BRAND;case n.nj7.EffectPlatformLoki:default:return i.Hw.LOKI}}}},2046:function(e,t,r){r.d(t,{Bd:function(){return a},Rw:function(){return n},aO:function(){return o},rH:function(){return i},rv:function(){return s}});var a="6776502040345448973",i="__REALTIME_DENOISE__",n={panel:"integration",resourceId:a,effectId:"485795",md5:"b07e8afaad96368f7a5056a9dc3ab1f2",url:new URL(r(984337),r.b).href,en:{url:new URL(r(182982),r.b).href},ja:{url:new URL(r(816762),r.b).href},ko:{url:new URL(r(500492),r.b).href},th:{url:new URL(r(172053),r.b).href},"zh-hans":{url:new URL(r(882398),r.b).href},"zh-hant":{url:new URL(r(517295),r.b).href},minorityLang:{url:new URL(r(140059),r.b).href}};new URL(r(984321),r.b).href,new URL(r(307926),r.b).href,new URL(r(980329),r.b).href,new URL(r(322568),r.b).href;var s={url:new URL(r(491466),r.b).href,path:"/integration/audio/rnnoise/rnnoise_v2.0.model",dir:"/integration/audio"};new URL(r(848094),r.b).href;var o={name:"makeup-root",resourceId:"7280056145232794113",resourceIdOnHeycan:"7406275420099824901",md5:"0196e5c1dc9d5498f4fa44dd090c49dd",url:new URL(r(994800),r.b).href,path:"/editor/effect/0196e5c1dc9d5498f4fa44dd090c49dd",dir:"/editor/effect"};new URL(r(994800),r.b).href},970766:function(e,t,r){r.d(t,{do:function(){return d}});var a=r(342875),i=r(627454),n=r(474956),s=e=>n.is.has(e.type)&&e.md5?a.P4R.ensureRootPath("".concat((0,i.gM)()).concat(e.md5)):a.P4R.ensureRootPath((0,i.uL)(e)),o=new Set([n._g.TextTemplate,n._g.Font,n._g.TextPreset,n._g.TextMotion,n._g.SubtitleTemplate,n._g.TextGlow]),d=e=>o.has(e.type)?s(e):(0,i.uL)(e)},501289:function(e,t,r){r.d(t,{X:()=>y});var a=r("457435"),i=r("997021"),n=r("843698"),s=r("874800"),o=r("231157"),d=r("56935"),l=Object.freeze(function(e){return{dispose(){}}});class u{active(){(0,d.ss)()}unactive(){(0,d.ss)()}seek(e){this._showWarning()}seekAndPause(e){this._showWarning()}seekWithSpeed(e,t,r){this._showWarning()}flushSeekCmd(){this._showWarning()}play(){this._showWarning()}pause(){this._showWarning()}rangePlay(e,t){this._showWarning()}setFullscreenContainer(e){this._showWarning()}requestFullscreen(){this._showWarning()}exitFullscreen(){this._showWarning()}retryStreamAsset(e){return Promise.resolve(-1)}reset(){return Promise.resolve()}get onPlay(){return l}get onRangePlay(){return l}get onPause(){return l}get onProgress(){return l}get onSeeked(){return l}get onEnd(){return l}get onError(){return l}get onFullscreenChange(){return l}_showWarning(){console.warn("should not call dummy player !!!\nplease check occasion.")}constructor(){this.hasLoaded=!1}}var c=r("342875");class h{get isPlaying(){return 1===this._status}get isRangePlaying(){return 2===this._status}get progress(){return this._progress}get speed(){return this._speed}get isFullscreen(){return this._isFullscreen}play(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._status=1,this._speed=e}rangePlay(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._status=2,this._speed=e}pause(){this._status=0}seek(e,t){t===c.Hqf.seekDone&&(this._status=0)}setSpeed(e){this._speed=e}setProgress(e){this._progress=e}setIsFullscreen(e){this._isFullscreen=e}constructor(){this._status=0,this._speed=1,this._progress=0n,this._isFullscreen=!1}}var p=r("806663"),_=r("836413");class f extends s.JT{get hasLoaded(){return this._hasLoaded}active(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0n;if(!this._activing)this._bindEvents(),this._hasLoaded&&this._source.seek(e),this._activing=!0}unactive(){this._unbindEvents(),this._activing=!1}seek(e,t,r){this._source.seek(e,t,r)}seekAndPause(e){this._source.seekAndPause(e)}seekWithSpeed(e,t,r){this._source.seekWithSpeed(e,t,r)}flushSeekCmd(){this._source.flushSeekCmd()}play(){if(!!this._hasLoaded)this._source.play()}pause(){this._pause()}rangePlay(e,t){this._source.rangePlay(e,t)}reset(e){return(0,d.ZB)(e),this._source.reset(e)}setFullscreenContainer(e){this._source.setFullscreenContainer(e)}requestFullscreen(e){this._source.requestFullscreen(e)}exitFullscreen(e){this._source.exitFullscreen(e)}retryStreamAsset(e){return this._source.retryStreamAsset(e)}_pause(){this._source.pause()}_bindEvents(){this._register(this._source.onProgressChange(e=>{var{progress:t,isSeek:r}=e;this._progress=t,this._onProgress.fire(t,r)})),this._register(this._source.onError(e=>{this._onError.fire((0,_.wf)(-1,JSON.stringify(e)))})),this._register(this._source.onPlay(()=>this._onPlay.fire())),this._register(this._source.onRangePlay(()=>this._onRangePlay.fire())),this._register(this._source.onPause(()=>this._onPause.fire())),this._register(this._source.onEnd(()=>this._onEnd.fire())),this._register(this._source.onSeeked(()=>this._onSeeked.fire())),this._register(this._source.onStreamStart(e=>this._onStreamStart.fire(e))),this._register(this._source.onStreamStop(e=>this._onStreamStop.fire(e))),this._register(this._source.onStreamFail(e=>{var{assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i}=e;return this._onStreamFail.fire({assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i})})),this._register(this._source.onFullscreenChange((e,t)=>this._onFullscreenChange.fire(e,t)))}_unbindEvents(){this._store.clear()}constructor(e,t){super(),this._source=e,this._onPlay=new n.Q,this._onRangePlay=new n.Q,this._onPause=new n.Q,this._onProgress=new n.Q,this._onSeeked=new n.Q,this._onStreamStart=new n.Q,this._onStreamStop=new n.Q,this._onStreamFail=new n.Q,this._onEnd=new n.Q,this._onError=new n.Q,this._onFullscreenChange=new n.Q,this._progress=0n,this._activing=!1,this._hasLoaded=!1,this.onPlay=this._onPlay.event,this.onRangePlay=this._onRangePlay.event,this.onPause=this._onPause.event,this.onProgress=this._onProgress.event,this.onSeeked=this._onSeeked.event,this.onStreamStart=this._onStreamStart.event,this.onStreamStop=this._onStreamStop.event,this.onStreamFail=this._onStreamFail.event,this.onEnd=this._onEnd.event,this.onError=this._onError.event,this.onFullscreenChange=this._onFullscreenChange.event,(0,p.V)(()=>{var e=t.onFirstFrameRender(()=>{this._hasLoaded=!0});return{dispose:()=>{null==e||e.dispose()}}})(()=>{})}}var v=r("146359"),g=r("588718");class m extends s.JT{get hasLoaded(){return this._hasLoaded}active(){if(!this._activing)this._bindEvents(),this._activing=!0}unactive(){this._unbindEvents(),this._activing=!1}seek(e){this._source.seek(v.h.usToSecond(e),g.j.Auto),Promise.resolve().then(()=>this._updateProgress(!0))}seekAndPause(e){this._source.seek(v.h.usToSecond(e),g.j.Pause)}seekWithSpeed(e,t,r){this._source.seek(v.h.usToSecond(e),g.j.Auto)}flushSeekCmd(){}play(){this._endTime=0n,this._source.play()}pause(){this._pause()}rangePlay(e,t){this._endTime=t,this._source.seek(v.h.usToSecond(e),g.j.Pause),this._source.play()}reset(){this._source.seek(0,g.j.Pause),this._source.reset()}setFullscreenContainer(e){}requestFullscreen(){this._source.getFullscreen()}exitFullscreen(){this._source.exitFullscreen()}retryStreamAsset(e){return Promise.resolve(-1)}_pause(){this._endTime=0n,this._source.pause()}_updateProgress(e){var t=v.h.secondToUs(this._source.currentTime);this._progress=t,this._onProgress.fire(t,e)}_startProgressListener(){var e=()=>{this._updateProgress(!1),this._raf=requestAnimationFrame(e)};this._raf=requestAnimationFrame(e)}_stopProgressListener(){this._raf&&(cancelAnimationFrame(this._raf),this._raf=null)}_bindEvents(){this._register(this._onProgress.event(e=>{if(0n!==this._endTime&&e>=this._endTime){var t=this._endTime;(0,p.V)(this._source.onPause)(()=>{this.seek(t)}),this.pause()}})),this._register(this._source.onPlay(()=>{0n!==this._endTime?this._onRangePlay.fire():this._onPlay.fire(),this._startProgressListener()})),this._register(this._source.onPause(()=>{this._onPause.fire(),this._stopProgressListener()})),this._register(this._source.onEnded(()=>{this._onEnd.fire(),this._stopProgressListener()})),this._register(this._source.onSeeked(()=>{this._onSeeked.fire(),this._updateProgress(!0)})),this._register(this._source.onError(e=>this._onError.fire((0,_.wf)(-1,JSON.stringify(e))))),this._register(this._source.onFullscreenChange(e=>this._onFullscreenChange.fire(e,void 0))),this._register(this._source.onLoaded(()=>{this._hasLoaded=!0}))}_unbindEvents(){this._store.clear(),this._stopProgressListener()}constructor(e){super(),this._source=e,this._onPlay=new n.Q,this._onRangePlay=new n.Q,this._onPause=new n.Q,this._onProgress=new n.Q,this._onSeeked=new n.Q,this._onEnd=new n.Q,this._onError=new n.Q,this._onFullscreenChange=new n.Q,this._endTime=0n,this._progress=0n,this._activing=!1,this._hasLoaded=!1,this._raf=null,this.onPlay=this._onPlay.event,this.onRangePlay=this._onRangePlay.event,this.onPause=this._onPause.event,this.onProgress=this._onProgress.event,this.onSeeked=this._onSeeked.event,this.onEnd=this._onEnd.event,this.onError=this._onError.event,this.onFullscreenChange=this._onFullscreenChange.event}}class y extends s.JT{get status(){return this._playerStatus}get hasLoaded(){return this._playerAdapter.hasLoaded}seek(e,t,r){this._playerStatus.seek(e,t),this._playerAdapter.seek(e,t,r)}seekToStartIfNotInRange(e,t,r){var{progress:a}=this._playerStatus,[i,n]=e;return(!(a>=i)||!(a<n))&&(this.seek(i,t,r),!0)}seekPrevFrame(){var e;(e=this._playerStatus.progress<a.CZ?0n:(0,i.i1)(this._playerStatus.progress-a.CZ))>=0&&this._playerAdapter.seek(e)}seekNextFrame(){var e=(0,i.i1)(this._playerStatus.progress+a.CZ),t=this._getDuration();e>t&&(e=t),this._playerAdapter.seek(e)}seekAndPause(e){this._playerAdapter.seekAndPause(e)}seekWithSpeed(e,t,r){this._playerAdapter.seekWithSpeed(e,t,r)}flushSeekCmd(){this._playerAdapter.flushSeekCmd()}play(){this._playerAdapter.play()}pause(){this._playerAdapter.pause()}rangePlay(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=r?t:(0,i.i1)(t);if(!(e>=a))this._playerAdapter.rangePlay(e,a)}setFullscreenContainer(e){this._playerAdapter.setFullscreenContainer(e)}requestFullscreen(e){this._playerAdapter.requestFullscreen(e)}exitFullscreen(e){this._playerAdapter.exitFullscreen(e)}reset(){(0,d.ZB)(this._renderManager);var e=this._renderManager.reset();return this._playerAdapter.reset(e),e}setDefaultPlayer(e,t){this._defaultPlayerSource=e,this._renderManager=t,this._defaultPlayerAdapter=this._register(new f(e,t))}activeDefaultPlayer(){if((0,d.ZB)(this._defaultPlayerAdapter),this._playerAdapter!==this._defaultPlayerAdapter)this._defaultPlayerAdapter.active(this._playerStatus.progress),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onPlay(()=>{this._playerStatus.play(),this._onPlay.fire()})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onRangePlay(()=>{this._playerStatus.rangePlay(),this._onPlay.fire(),this._onRangePlay.fire()})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onPause(()=>{this._playerStatus.pause(),this._onPause.fire()})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onProgress((e,t)=>{this._playerStatus.setProgress(e),this._onProgress.fire(e,t)})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onSeeked(()=>{this._onSeeked.fire()})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onStreamStart(e=>{this._onStreamStart.fire(e)})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onStreamStop(e=>{this._onStreamStop.fire(e)})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onStreamFail(e=>{var{assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i}=e;this._onStreamFail.fire({assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i})})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onEnd(()=>{this._playerStatus.pause(),this._onEnd.fire()})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onError(e=>{this._onError.fire(e)})),this._defaultPlayerEvents.add(this._defaultPlayerAdapter.onFullscreenChange((e,t)=>{this._playerStatus.setIsFullscreen(e),this._onFullscreenChange.fire(e,t)})),this._previewPlayerAdapter&&(this._previewPlayerAdapter.unactive(),this._previewPlayerEvents.clear()),this._playerAdapter=this._defaultPlayerAdapter}setPreviewPlayer(e,t){this._previewPlayerSource=e,this._renderManager=t,this._previewPlayerAdapter=new m(e)}activePreviewPlayer(){if((0,d.ZB)(this._previewPlayerAdapter),this._playerAdapter!==this._previewPlayerAdapter)this._previewPlayerAdapter.active(),this._previewPlayerEvents.add(this._previewPlayerAdapter.onPlay(()=>{this._playerStatus.play(),this._onPlay.fire()})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onRangePlay(()=>{this._playerStatus.rangePlay(),this._onPlay.fire(),this._onRangePlay.fire()})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onPause(()=>{this._playerStatus.pause(),this._onPause.fire()})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onProgress((e,t)=>{this._playerStatus.setProgress(e),this._onProgress.fire(e,t)})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onSeeked(()=>{this._onSeeked.fire()})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onEnd(()=>{this._playerStatus.pause(),this._onEnd.fire()})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onError(e=>{this._onError.fire(e)})),this._previewPlayerEvents.add(this._previewPlayerAdapter.onFullscreenChange((e,t)=>{this._playerStatus.setIsFullscreen(e),this._onFullscreenChange.fire(e,t)})),this._defaultPlayerAdapter&&(this._defaultPlayerAdapter.unactive(),this._defaultPlayerEvents.clear()),this._playerAdapter=this._previewPlayerAdapter}retryStreamAsset(e){return this._playerAdapter.retryStreamAsset(e)}constructor(e){super(),this._getDuration=e,this._onPlay=this._register(new n.Q),this._onRangePlay=this._register(new n.Q),this._onPause=this._register(new n.Q),this._onProgress=this._register(new n.Q),this._onSeeked=this._register(new n.Q),this._onStreamStart=new n.Q,this._onStreamStop=new n.Q,this._onStreamFail=new n.Q,this._onEnd=this._register(new n.Q),this._onError=this._register(new n.Q),this._onFullscreenChange=this._register(new n.Q),this._defaultPlayerEvents=this._register(new o.S),this._previewPlayerEvents=this._register(new o.S),this._dummyPlayerAdapter=new u,this._playerAdapter=this._dummyPlayerAdapter,this._playerStatus=new h,this.onPlay=this._onPlay.event,this.onRangePlay=this._onRangePlay.event,this.onPause=this._onPause.event,this.onProgress=this._onProgress.event,this.onSeeked=this._onSeeked.event,this.onStreamStart=this._onStreamStart.event,this.onStreamStop=this._onStreamStop.event,this.onStreamFail=this._onStreamFail.event,this.onEnd=this._onEnd.event,this.onError=this._onError.event,this.onFullscreenChange=this._onFullscreenChange.event}}},241548:function(e,t,r){r.d(t,{hF:()=>m});var a,i,n=r("876826"),s=r("789786"),o=r("806663"),d=r("843698"),l=r("874800"),u=r("56935"),c=r("342875");var h=((a=h||{})[a.debug=0]="debug",a[a.info=1]="info",a[a.warn=2]="warn",a[a.error=3]="error",a[a.fatal=4]="fatal",a[a.none=6]="none",a),p=new class e{debug(e){this._log(0,e)}info(e){this._log(1,e)}warn(e){this._log(2,e)}error(e){this._log(3,e)}fatal(e){this._log(4,e)}_log(e,t){if(!(e<this.minLogLevel)){var r="[".concat(new Date().toISOString(),"] [").concat(h[e],"] [").concat("PlayerManager","] - ").concat(t);switch(e){case 4:case 3:console.error(r);break;case 2:console.warn(r);break;case 0:console.trace(r);break;default:console.log(r)}}}constructor(){if(this.minLogLevel=6,"undefined"==typeof window)return;var e,{searchParams:t}=new URL(window.location.href),r=null!==(e=t.get("player_log_level"))&&void 0!==e?e:"";this.minLogLevel=r&&Number.isFinite(parseInt(r,10))?parseInt(r,10):6}};function _(e){return function(t,r,a){var i=a.value;return a.value=function(){for(var t,a=arguments.length,n=Array(a),s=0;s<a;s++)n[s]=arguments[s];return t=n[0]?"".concat(r,"(").concat(n.join(", "),")"):"".concat(r,"()"),p[e](t),i.apply(this,n)},a}}_("debug");var f=_("info");_("warn"),_("error"),_("fatal");var v=((i={}).Auto="auto",i.Play="play",i.Pause="pause",i);class g extends l.JT{seek(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c.Hqf.normal,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"auto",a=this;return(0,n._)(function*(){var i="play"===r||"auto"===r&&a._isPlaying,n=t;a._veState===c.jey.PLAY_EOF&&[c.Hqf.normal,c.Hqf.onGoing].includes(t)?n=c.Hqf.seekDone:i&&(n=c.Hqf.seekDone),yield a._renderManager.seekTime(e,n),i?a.play():a.pause()})()}seekAndPause(e){this.seek(e,c.Hqf.seekDone,"pause")}rangePlay(e,t){var r=this;return(0,n._)(function*(){yield r._renderManager.setTimeRange(0n,t),yield r._renderManager.seekTime(e,c.Hqf.seekDone),r._rangePlayEndtime=t,r._renderManager.play()})()}reset(e){e.then(()=>{this._onRenderManagerReset()})}exitRangePlay(){if(this._rangePlayEndtime!==-1n)this._rangePlayEndtime=-1n,this._renderManager.setTimeRange(0n,-1n)}seekWithSpeed(e,t,r){return this._renderManager.seekWithSpeed(e,c.Hqf.onGoing,t,r)}flushSeekCmd(){this._renderManager.flushSeekCmd()}play(){return this.exitRangePlay(),this._renderManager.play()}pause(){return this.exitRangePlay(),this._renderManager.pause()}get isPlaying(){return this._veState===c.jey.PLAYING}get _veState(){return this._renderManager.state}_onRenderManagerError(e){this._onError.fire(e)}_onRenderManagerProgressChange(e){p.debug("_onRenderManagerProgressChange({ progress: ".concat(e.progress,", isSeek: ").concat(e.isSeek," })")),this._onProgressChange.fire(e)}_onRenderManagerFrameRender(e){if(this._isWaitPlayingStart&&(this._isWaitPlayingStart=!1,this._isPlaying=!0,this._rangePlayEndtime!==-1n?this._onRangePlay.fire():this._onPlay.fire()),this.isPlaying&&this._rangePlayEndtime!==-1n&&e.progress>=this._rangePlayEndtime){p.info("rangePlay end");var t=this._rangePlayEndtime;(0,o.V)(this.onPause)(()=>{this._renderManager.seekTime(t,c.Hqf.seekDone)}),this.exitRangePlay(),this._renderManager.pause()}}_onRenderManagerReset(){(0,o.V)(e=>{var t=this._renderManager.onFrameRender(()=>{e()});return null!=t?t:{dispose:()=>null}})(()=>{this._onProgressChange.fire({progress:this._renderManager.progress,isSeek:!1}),this._renderManager.state===c.jey.PAUSED&&this._onPause.fire()})}_onRenderManagerSeekDonePlay(){this._renderManager.play()}_onRenderManagerStateChange(e){switch(p.info("_onRenderManagerStateChange(".concat(c.jey[e],")")),e){case c.jey.PLAYING:this._isWaitPlayingStart=!0;break;case c.jey.PAUSED:this._isPlaying=!1,this._isWaitPlayingStart=!1,this._onPause.fire();break;case c.jey.PLAY_EOF:this._isPlaying=!1,this._isWaitPlayingStart=!1,this._onEnd.fire();break;case c.jey.SEEK_DONE:this._onSeeked.fire()}}setFullscreenContainer(e){if(this._fullscreenContainer=e,this._fullscreenContainer){var t;null===(t=this._fullscreenContainer)||void 0===t||t.removeEventListener("fullscreenchange",this.fullscreenchangeHandler)}this._fullscreenContainer.addEventListener("fullscreenchange",this.fullscreenchangeHandler),this._register({dispose:()=>{var e;null===(e=this._fullscreenContainer)||void 0===e||e.removeEventListener("fullscreenchange",this.fullscreenchangeHandler)}})}requestFullscreen(e){(0,u.Y2)(this._fullscreenContainer,"fullscreenContainer is undefined"),(0,u.Y2)(this._fullscreenContainer.requestFullscreen||this._fullscreenContainer.webkitRequestFullscreen,"requestFullscreen not support"),this._fullScreenSourceFrom=e,this._fullscreenContainer.requestFullscreen?this._fullscreenContainer.requestFullscreen():this._fullscreenContainer.webkitRequestFullscreen&&this._fullscreenContainer.webkitRequestFullscreen()}exitFullscreen(e){(0,u.Y2)(document.exitFullscreen||document.webkitExitFullscreen,"exitFullscreen not support"),this._fullScreenSourceFrom=e,document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}retryStreamAsset(e){return Promise.resolve(this._renderManager.retryStreamAsset(e))}constructor(e){super(),this._isPlaying=!1,this._isWaitPlayingStart=!1,this._rangePlayEndtime=-1n,this._onEnd=this._register(new d.Q),this._onError=this._register(new d.Q),this._onFullscreenChange=this._register(new d.Q),this._onPause=this._register(new d.Q),this._onPlay=this._register(new d.Q),this._onRangePlay=this._register(new d.Q),this._onProgressChange=this._register(new d.Q),this._onFrameRender=this._register(new d.Q),this._onSeeked=this._register(new d.Q),this._onStreamStart=this._register(new d.Q),this._onStreamStop=this._register(new d.Q),this._onStreamFail=this._register(new d.Q),this.fullscreenchangeHandler=()=>{(0,u.Y2)(document,"document not support");var e,t=!!(null===(e=document)||void 0===e?void 0:e.fullscreenElement);this._onFullscreenChange.fire(t,this._fullScreenSourceFrom),this._fullScreenSourceFrom=void 0},this._renderManager=e.renderManager,this.onEnd=this._onEnd.event,this.onError=this._onError.event,this.onFullscreenChange=this._onFullscreenChange.event,this.onPause=this._onPause.event,this.onPlay=this._onPlay.event,this.onRangePlay=this._onRangePlay.event,this.onProgressChange=this._onProgressChange.event,this.onFrameRender=this._onFrameRender.event,this.onSeeked=this._onSeeked.event,this.onStreamStart=this._onStreamStart.event,this.onStreamStop=this._onStreamStop.event,this.onStreamFail=this._onStreamFail.event,this._fullScreenSourceFrom=void 0;var t=this._renderManager.onError(this._onRenderManagerError.bind(this));t&&this._register(t),(t=this._renderManager.onProgressChange(this._onRenderManagerProgressChange.bind(this)))&&this._register(t),(t=this._renderManager.onFrameRender(this._onRenderManagerFrameRender.bind(this)))&&this._register(t),(t=this._renderManager.onSeekDonePlay(this._onRenderManagerSeekDonePlay.bind(this)))&&this._register(t),(t=this._renderManager.onStateChange(this._onRenderManagerStateChange.bind(this)))&&this._register(t),(t=this._renderManager.onStreamStart(e=>{var{asset_id:t}=e;return this._onStreamStart.fire(t)}))&&this._register(t),(t=this._renderManager.onStreamStop(e=>{var{asset_id:t}=e;return this._onStreamStop.fire(t)}))&&this._register(t),(t=this._renderManager.onStreamFail(e=>{var{assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i}=e;return this._onStreamFail.fire({assetId:t,httpStatus:r,isBlock:a,isGetMediaInfo:i})}))&&this._register(t)}}(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof BigInt?Object:BigInt,void 0===c.Hqf?Object:c.Hqf,void 0===v?Object:v]),(0,s.w6)("design:returntype",Promise)],g.prototype,"seek",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof BigInt?Object:BigInt,"undefined"==typeof BigInt?Object:BigInt]),(0,s.w6)("design:returntype",Promise)],g.prototype,"rangePlay",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof Promise?Object:Promise]),(0,s.w6)("design:returntype",void 0)],g.prototype,"reset",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"exitRangePlay",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof BigInt?Object:BigInt,Number,Number]),(0,s.w6)("design:returntype",void 0)],g.prototype,"seekWithSpeed",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"flushSeekCmd",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"play",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"pause",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",["undefined"==typeof IVeVideoPlayerError?Object:IVeVideoPlayerError]),(0,s.w6)("design:returntype",void 0)],g.prototype,"_onRenderManagerError",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"_onRenderManagerReset",null),(0,s.gn)([f,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],g.prototype,"_onRenderManagerSeekDonePlay",null);var m=e=>((0,u.Y2)(e,"video player must sdk."),new g({renderManager:e}))},573670:function(e,t,r){r.d(t,{Y:function(){return i}});var a,i=((a={})[a.FigureBeauty=0]="FigureBeauty",a[a.SmartCrop=1]="SmartCrop",a)},493268:function(e,t,r){r.d(t,{f:function(){return a}});var a=e=>{var t=/(.*):\/\/(.*)/.exec(e),r=t[1].toLowerCase(),a=t[2].split("/");return{platform:r,id:1===a.length?a[0]:a.slice(1).join("/"),panel:1===a.length?null:a[0]}}},177984:function(e,t,r){r.d(t,{u:()=>l});var a=()=>{var e=!0;return new URL(location.href).searchParams.get("disable_layer_render")&&(e=!1),e},i=e=>{var t=a();return(!e||e.hasSubDraft)&&(t=!1),t},n=r("2046"),s=r("474956"),o=r("24353"),d=new Set([s._g.Mask,s._g.StickerMotion,s._g.Effects,s._g.FaceProp,s._g.ManualFigure,s._g.SkeletonBody,s._g.AISkeletonBody,s._g.AutoBeautyBody,s._g.Beauty,s._g.AutoBeautyShape,s._g.AutoBeautyFace,s._g.AutoBeautyMakeup,s._g.TextTemplate,s._g.SubtitleTemplate,s._g.TextMotion,s._g.TextPreset,s._g.Sticker,s._g.Tone,s._g.Filter,s._g.VideoBackground,s._g.Transition,s._g.Mix,s._g.CurveSpeed,s._g.Integration,s._g.CurveHSL,s._g.VoiceChange]),l=function(e,t,r){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],u=!a&&i(r),c=[],h=[],p=[];t.forEach(t=>{var a,i,_,f=null===(i=t.resource)||void 0===i?void 0:null===(a=i.resourceId)||void 0===a?void 0:a.toString();if(!!f&&f!==n.Rw.resourceId){var v=!!(null==r?void 0:null===(_=r.invalidMaterialResources)||void 0===_?void 0:_[f]),g=t.resource.type===s._g.Font,m=t.resource.type===s._g.VideoBackground,y=d.has(t.resource.type),S=1===t.materialIds.length&&""===t.materialIds[0],M=u&&y&&!(v||g)&&!(l&&m&&S),{waitForResourceValueReady:T,waitForResourceMetaReady:k}=e.ensureEffect(t,void 0,{needUnzip:!0,disableAutoEnsureResourceValue:M,shouldPreload:g});h.push((0,o.b)(k())),M?(console.log("[progressive] adding a resource to progressive loading",t.key),p.push(t)):(console.log("[progressive] download a resource without progressive loading",t.key),c.push((0,o.b)(T())))}});var _=()=>Promise.all(h);return p.length&&c.push(_().then(()=>e.progressivelyEnsureEffects(r,p,e.getEffectPathMap()))),{waitForEffectsEnsured:()=>Promise.all(c),waitForEffectMetasReady:_,shouldProgressivelyLoadResources:u}}},601176:function(e,t,r){r.d(t,{of:()=>M});var a,i=r("85728"),n=r("929753"),s=r("573670"),o=r("434487"),d=r("702095"),l=r("819277"),u=r("926838"),c=r("474956");var h=((a={})[a.ForceGenerateNew=0]="ForceGenerateNew",a[a.Default=1]="Default",a[a.ForceKeepOrigin=2]="ForceKeepOrigin",a),p=r("857373"),_=r("24353");r("342875");var f=(e,t)=>{var r=[],a=[],i=[];for(var n of t){var{online:s,pathInDraft:o,preloadMaterial:d}=n;i.push(s);var l=e.ensureMaterial(s,o,{draftPathStrategy:n.useMaskVideo?h.ForceKeepOrigin:h.ForceGenerateNew,overrideSupportStream:d.support_stream,keepFsPathEqualToDraftPath:n.useMaskVideo,metaTimeout:void 0,isFirstFrameStreamMaterial:d.is_first_frame_stream_material,shouldPreloadStreamAsset:!0,useMaskVideo:n.useMaskVideo});r.push((0,_.b)(l.waitForResourceMetaReady())),a.push((0,_.b)(l.waitForResourceValueReady()))}return{waitForOnlineMaterialMetasReady:()=>Promise.all(r),waitForOnlineMaterialValuesReady:()=>Promise.all(a),onlineMaterialList:i}},v={[d.YB.Video]:c._g.UserVideo,[d.YB.Image]:c._g.UserPhoto,[d.YB.File]:c._g.UserFile,[d.YB.Audio]:c._g.UserAudio},g=(e,t)=>t?h.ForceKeepOrigin:e.isVideoAlgorithmProduct||"number"==typeof e.algorithmType&&[s.Y.FigureBeauty,s.Y.SmartCrop].includes(e.algorithmType)?h.ForceKeepOrigin:h.ForceGenerateNew,m=(e,t)=>!!t||"number"==typeof e.algorithmType&&[s.Y.FigureBeauty,s.Y.SmartCrop].includes(e.algorithmType),y=e=>{var t;return(null===(t=e.preloadMaterial)||void 0===t?void 0:t.support_stream)&&["video","image","audio"].includes(e.asset.material.groupType)&&e.asset.material.fileStatus===p.X.Online},S=(e,t,r,a,s,d)=>{var p=[],f=[],S=[],M=new Map,T=new Set;for(var k of(d.forEach(e=>{M.set(e.md5,e),T.add(e.md5)}),[...a,...s].forEach(r=>{var a,i,n,s,d=M.get(r.asset.md5);if(T.delete(r.asset.md5),!d){console.error("[startup] cannot find a lifecycle for EverCloud material",r);return}var l=d.getModel();if(!!(null===(a=l.draftDelta)||void 0===a?void 0:a.sourcePath)){var u=(0,o.fA)(d.getModel()),h=t.isAutoTest?u?void 0:1e4:u?void 0:6e4,k=(0,o.GL)(l,v[l.fileType],t.isAutoTest);S.push(k);var I=k.resource.type===c._g.UserFile&&!!(null===(n=k.resource)||void 0===n?void 0:null===(i=n.sourcePath)||void 0===i?void 0:i.includes("matting")),w=e.ensureMaterial(k,r.pathInDraft,{metaTimeout:h,isZippedUserFile:I,draftPathStrategy:g(r,I),overrideSupportStream:y(r),keepFsPathEqualToDraftPath:m(r,I),isFirstFrameStreamMaterial:null==r?void 0:null===(s=r.preloadMaterial)||void 0===s?void 0:s.is_first_frame_stream_material,shouldDownloadOriginalMaterial:t.isAutoTest&&!u,shouldPreloadStreamAsset:!0});p.push((0,_.b)(w.waitForResourceMetaReady())),f.push((0,_.b)(w.waitForResourceValueReady()))}}),T)){var I,w,P,b,R=M.get(k),E=R.getModel();if((null===(w=E.draftDelta)||void 0===w?void 0:null===(I=w.meta)||void 0===I?void 0:I.group)==="graphic"||!(null===(P=E.draftDelta)||void 0===P?void 0:P.sourcePath))continue;if(["attachment_video_algorithm.json","async_task_service.json"].includes(E.draftDelta.sourcePath)){r.recordResourceKeyToDraftPath(E.key,E.draftDelta.sourcePath),r.recordDraftPathToResourceKey(E.draftDelta.sourcePath,E.key);continue}if((null===(b=E.draftDelta)||void 0===b?!void 0:!b.meta)||!!E.draftDelta.meta.visible)e.ensureMaterial((0,l.l)(v[E.fileType],(0,n._)((0,i._)({},E),{onProgress:R.onModelUpdate,onReady:R.onDidDone}),R.status===u.a.Success),E.draftDelta.sourcePath,{draftPathStrategy:h.ForceGenerateNew,shouldPreloadStreamAsset:!0})}return{waitForCloudMaterialMetasReady:()=>Promise.all(p),waitForCloudMaterialValuesReady:()=>Promise.all(f),everCloudMaterialList:S}},M=(e,t,r,a,i,n,s)=>{var o=f(e,a),d=o.waitForOnlineMaterialValuesReady(),l=S(e,t,r,i,n,s),u=l.waitForCloudMaterialValuesReady();return{waitForMaterialsEnsured:()=>Promise.all([d,u]),pOnlineMaterials:d,pCloudMaterials:u,waitForOnlineMaterialMetasReady:o.waitForOnlineMaterialMetasReady,waitForCloudMaterialMetasReady:l.waitForCloudMaterialMetasReady,onlineMaterialList:o.onlineMaterialList,everCloudMaterialList:l.everCloudMaterialList}}},24353:function(e,t,r){r.d(t,{b:function(){return a}});var a=e=>e.catch(t=>(console.log("failed to load resource",e),!1))},569760:function(e,t,r){r.d(t,{xz:function(){return v}});var a=r(876826),i=r(85728),n=r(929753),s=r(936884),o=r(827422),d=r(216342),l=r(146359),u=r(342875),c=r(598879),h=r(471605),p=r(143608),_=r(693895),f=()=>{var e=c.m4.create(r.g.location.href).getAllQueryParameterValues(),t="Product"===e.utm_medium,a="draftshare"===e.utm_source,i="email"===e.utm_campaign;return t&&a&&i};(0,d.Tx)("preload-package-data",(e,t,r,n)=>{var d;return t.invokeFunction((d=(0,a._)(function*(t){var a,d,l=t.get(p.j),u=t.get(s.rO),c=t.get(h.S),v=t.get(_.W),g=t.get(o.n),m=null!==(a=u.workspaceIdFromUrl)&&void 0!==a?a:g.draftWorkspaceManager.workspaceId,y=f(),S=yield l.getPackageInfo(e,(0,i._)({packageKey:r,spaceId:null!==(d=u.spaceIdFromUrl)&&void 0!==d?d:v.getWorkspace(m).space_id,workspaceId:m,lang:c.currentLocale||"en",fromEmail:y},n));return console.log("[startup] package data",S),S}),function(e){return d.apply(this,arguments)}))},"fetchPackageInfo");var v=e=>{var t,r=function(e){var t=d.find(t=>{var{md5:r}=t;return r===e.md5});if(null==t?void 0:t.meta)try{e.package_meta=JSON.parse(t.meta)}catch(e){}(!e.package_meta||"object"!=typeof e.package_meta)&&(e.package_meta={})},a={},s=[],o=[],d=[],c=null,h={},p="",_={};try{var f=u.HHr.parse(e.package_meta);a=u.HHr.parse(f.meta),d=f.assets||[],p=String(null==f?void 0:f.id)}catch(e){}try{s=u.HHr.parse(e.filer_asset_list)}catch(e){}for(var v of s)r(v);try{o=u.HHr.parse(e.material_list)}catch(e){}try{if(null==e?void 0:e.frame_info){var g,m=JSON.parse(null!==(g=e.draft)&&void 0!==g?g:null);c=(0,n._)((0,i._)({},null==e?void 0:e.frame_info),{draft_info:{canvas_config:null==m?void 0:m.canvas_config,duration:Math.floor(l.h.usToMs(null==m?void 0:m.duration))}})}}catch(e){}try{h=u.HHr.parse(e.package_preload_config)}catch(e){}try{_=null!==(t=e.attachment_info)&&void 0!==t?t:{}}catch(e){}var y=u.HHr.parse(e.preload);return{meta:a,syncId:p,packageAssets:d,template:e.draft,preloadResources:{materials:y.avs,effects:y.effects},resourceInfos:{onlineResourceList:o,everCloudResourceList:s,errorList:e.error_list},firstFrameInfo:c,preloadConfig:h,attachments:_}}},560099:function(e,t,r){r.d(t,{kL:()=>p});var a=r("85728"),i=r("929753"),n=r("493268"),s=r("2046"),o=r("342875"),d=r("487059"),l=r("474956"),u=r("294202");o.cVg.MetaTypeFade,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeLightSensation,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeBrightness,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeContrast,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeParticle,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeSaturation,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeHighlight,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeShadow,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeSharpen,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeHue,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeTemperature,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeVignetting,l._g.Integration,u.Hw.LOKI,o.cVg.MetaTypeHsl,l._g.Integration,u.Hw.LOKI;var c={md5:"cb01a183fae704b7f5b68f47d8b549bf",url:"https://lf16-effectcdn.byteeffecttos-g.com/obj/ies.fe.effect.alisg/cb01a183fae704b7f5b68f47d8b549bf",resourceId:"7199840404223562241",effectId:"13174263",regionKey:"default",metaType:80,requirements:["blit"],modelNames:[],persistType:o.cVg.MetaTypeColorCurves,name:"colorCurve",key:"/integration/cb01a183fae704b7f5b68f47d8b549bf",type:l._g.Integration,package:{uri:"cb01a183fae704b7f5b68f47d8b549bf",urlList:["https://lf16-effectcdn.byteeffecttos-g.com/obj/ies.fe.effect.alisg/cb01a183fae704b7f5b68f47d8b549bf"]},isVip:!1,source:u.Hw.LOKI,isPrefab:!1,isBusiness:!1,icon:{uri:"",urlList:[]},sdkVersion:"9.5.0"},h=(e,t)=>!!(e===d.U_.SystemFonts||[...Array.from(o.NG_),s.Bd,"-1"].includes(t)||[d.U_.Bubble2,d.U_.Flower2].includes(e))||!1,p=(e,t,r,s)=>{var d=Object.values(null!=e?e:{}),l=[],u=[],p={},_=(e,t)=>{var a="canvas"===e&&t,i=!e&&t;return a||i?r.includes(t):h(e,t)};for(var f of d){var{schema:v,material_ids:g=[]}=f,{id:m,panel:y}=(0,n.f)(v),S=t[v];if(S){var M,T,k=function(e,t){if(e.resource.resourceId===o.$UK.resourceId||e.resource.resourceId===o.zLw.resourceId||e.resource.resourceId===o.Rcq.resourceId){var r=e.resource.resourceId===o.Rcq.resourceId?"v2":"",{resourceId:a,package:i}=(0,o.CrL)(t,r);e.resource.resourceId=a,e.resource.package=i}return e}(S,null!==(T=null==s?void 0:null===(M=s.platform)||void 0===M?void 0:M.os)&&void 0!==T?T:"");p[m]=k.resource.resourceId,l.push((0,i._)((0,a._)({},k),{materialIds:g}))}else{if("7206147814030578178"===f.resource_id){var I="".concat(c.type,"_").concat(c.resourceId,"_").concat(c.effectId);l.push({key:I,resource:(0,i._)((0,a._)({},c),{key:I,previewUrl:""}),materialIds:g});continue}if(_(y,m))continue;u.push(v)}}return{effects:l,unresolvedEffects:u,oldResourceIdToNewResourceIdMap:p}}},201943:function(e,t,r){r.d(t,{P:()=>M});var a=r("85728"),i=r("929753"),n=r("573670"),s=r("474956"),o=r("603968"),d=r("857373"),l=r("529227"),u=(e,t)=>{var r;return{md5:t.md5,meta:null!==(r=t.package_meta)&&void 0!==r?r:{},path:t.source_path,size:t.size,material:function(e,t){var r,i,n,s,u,c,h,p,_,f,v,g,m,y=["cover.jpg","template.json"].includes(null==(r=t)?void 0:r.source_path)?"other":(0,l.Gt)(r.mime),S=d.X.Online,M={},T=e.isAutoTest?t.preview_url.bucket_key_720p||t.preview_url.bucket_key_1080p||t.preview_url.bucket_key_480p||t.preview_url.bucket_key_360p:t.preview_url.bucket_key_360p||t.preview_url.bucket_key_480p||t.preview_url.bucket_key_720p||t.preview_url.bucket_key_1080p,{player_480p:k,player_360p:I,player_720p:w,audio_128kb:P}=t.play_info,b=k.primary_url?{url:k.primary_url,key:k.url_key}:I.primary_url?{url:I.primary_url,key:I.url_key}:w.primary_url?{url:w.primary_url,key:w.url_key}:void 0,R=P.primary_url?{url:P.primary_url,key:P.url_key}:void 0;switch(y){case"video":if(c=b,T&&(h={url:T,key:t.preview_key}),t.meta)try{if("string"!=typeof t.meta)({meta:M}=t);else{var E,D,A=JSON.parse(t.meta);M=(0,a._)({},M,A)}}catch(e){}if(void 0!==t.transcode_status&&3!==t.transcode_status);else{;if(null!==(D=null==(E=M)?void 0:E.is_matting)&&void 0!==D?D:null==E?void 0:E.is_reverse)S=d.X.Online;else!b&&(S=d.X.Transcoding)}if((null===(_=t.sprite_frame)||void 0===_?void 0:_.detail_infos)&&(null===(f=t.sprite_frame)||void 0===f?void 0:f.common_info)){var{single_frame_width:F,single_frame_height:C}=t.sprite_frame.common_info;p=t.sprite_frame.detail_infos.map(e=>({url:e.url,key:e.encrypted_key,count:e.frame_count,width:e.width,height:e.height,x:e.width/F,y:e.height/C,ratio:F/C}))}break;case"image":if(t.meta)try{if("string"!=typeof t.meta)({meta:M}=t);else{var U=JSON.parse(t.meta);M=(0,a._)({},M,U)}}catch(e){}T?h={url:T,key:t.preview_key}:S=d.X.Transcoding;break;case"audio":c=R,void 0!==t.transcode_status||!R&&(S=d.X.Transcoding)}return!(null===(n=t.tags)||void 0===n?void 0:null===(i=n.includes)||void 0===i?void 0:i.call(n,7001))&&(S=d.X.Online),{assetId:String(t.asset_id),name:t.filename,md5:t.md5,type:null!==(v=t.mime)&&void 0!==v?v:"",metaType:(0,o.Me)(t.mime),groupType:y,size:t.size,ext:t.sub_type,duration:t.duration,width:null!==(g=t.width)&&void 0!==g?g:0,height:null!==(m=t.height)&&void 0!==m?m:0,encryptedCover:h,encryptedSprites:p,progressDownload:0,progressTranscode:S===d.X.Online?1:0,fileStatus:S,updatedAt:t.updated_at,meta:M,playInfo:c,downloadUrl:t.origin_download_link,spaceId:2===t.owner_type?t.owner:"0",hasMaterialTag:null===(u=t.tags)||void 0===u?void 0:null===(s=u.includes)||void 0===s?void 0:s.call(u,7001)}}(e,t)}},c=r("342875"),h=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t={},r={},a=(e,r)=>{!t[e]&&(t[e]=new Set),t[e]&&t[e].add(r)};return e.forEach(e=>{var{md5:t,path:r}=e;a(t,r)}),Object.keys(t).forEach(e=>{var a=t[e];if(a.size>1){var i=Array.from(a),n=i[0];i.forEach(e=>{r[e]=n})}}),r},p=r("234075"),_=r.n(p);c.cVg.MetaTypeMusic,c.cVg.MetaTypeSound,c.cVg.MetaTypeTextToAudio,c.cVg.MetaTypeRecord,c.cVg.MetaTypeExtractMusic,c.cVg.MetaTypeVideoOriginalSound,c.cVg.MetaTypeVideo,c.cVg.MetaTypePhoto,c.cVg.MetaTypeImage,c.cVg.MetaTypeGif,c.C3w.MetaTypeMusic,c.C3w.MetaTypeSound,c.C3w.MetaTypeTextToAudio,c.C3w.MetaTypeRecord,c.C3w.MetaTypeExtractMusic,c.C3w.MetaTypeVideoOriginalSound;var f=[c.C3w.MetaTypeVideo],v=[c.C3w.MetaTypePhoto,c.C3w.MetaTypeImage,c.C3w.MetaTypeGif];[...f,...v];var g=r("572669"),m=e=>{var t,r,a=[];return(null!==(r=null===(t=e.tracks)||void 0===t?void 0:t.map(e=>{var t;return null==e?void 0:null===(t=e.segments)||void 0===t?void 0:t[0]}))&&void 0!==r?r:[]).filter(e=>{var t;return e&&(null==e?void 0:null===(t=e.target_timerange)||void 0===t?void 0:t.start)===0}).forEach(e=>{(null==e?void 0:e.material_id)&&a.push(null==e?void 0:e.material_id)}),a},y=e=>{var t,r,a,i,n=(null!==(i=null===(t=e.tracks)||void 0===t?void 0:t.filter(e=>(null==e?void 0:e.type)===c.pNd.TrackTypeSticker&&Array.isArray(e.segments)).map(e=>null==e?void 0:e.segments).flat())&&void 0!==i?i:[]).reduce((e,t)=>{if((null==t?void 0:t.extra_material_refs)&&Array.isArray(null==t?void 0:t.extra_material_refs))for(var r of t.extra_material_refs)"string"==typeof r&&e.push(r);return(null==t?void 0:t.material_id)&&e.push(t.material_id),e},[]);return(null===(a=e.materials)||void 0===a?void 0:null===(r=a.drafts)||void 0===r?void 0:r.length)&&e.materials.drafts.forEach(e=>{e.draft&&n.push(...y(e.draft))}),n},S=e=>e.startsWith("/")?e:"/".concat(e),M=(e,t,r,o,d)=>{var l,p=function(e){var{path:t,reverse_path:a,ai_matting_path:i,beats_path:n,melody_path:o,production_path:d,video_algorithm_path:l,trackers:u,schema:h,canvas_image_path:p,vocal_beautify_production_path:_,vocal_separation_production_path:f}=e;if(R.includes(e.id)&&v.includes(e.meta_type)&&(e.is_first_frame_stream_material=!0),E.includes(e.id)&&v.includes(e.meta_type)&&(e.support_stream=!1),V(n,e),V(o,e),V(d,e),null==i||null===(y=i.split(";"))||void 0===y||y.forEach(t=>{V(t,e,!0)}),l?V(l,e,!0):V(a,e),u)for(var g of u)V(g.data_path,e,!0);V(p,e),V(_,e),V(f,e),c.hPV.isPathIncompleteQuickImport(t)&&L.push({fsPath:c.hPV.toAbsolutePath(t),pathInDraft:t,preloadMaterial:e});var m=I.find(e=>c.hPV.isPathEqual(e.path,t));if(m)D.push({builtIn:m,fsPath:c.hPV.toAbsolutePath(t),pathInDraft:t,preloadMaterial:e});else if(h){var y,S,M={pathInDraft:t,fsPath:c.hPV.toAbsolutePath(t),preloadMaterial:e,online:r[h]};(null===(S=M.online)||void 0===S?void 0:S.resource)&&M.online.resource.type===s._g.Video&&"maskVideo"in M.online.resource&&M.online.resource.maskVideo&&i&&F.push({pathInDraft:i,fsPath:c.hPV.toAbsolutePath(i),preloadMaterial:e,online:r[h],useMaskVideo:!0}),r[h]?F.push(M):H(e.path)?V(t,e):C.push(M)}else V(t,e)},f=function(e){!D.find(t=>c.hPV.isPathEqual(t.builtIn.path,e.path))&&A.push({builtIn:e})},{preloadResources:M,resourceInfos:T}=t,{materials:k}=M,{builtInResourceList:I=[]}=T,{everCloudResourceList:w=[]}=T,P=(w=(0,g.Z)(d)?d(w):w).map(t=>u(e,t)),b=Object.values(null!=k?k:{}),R=m(o),E=y(o),D=[],A=[],F=[],C=[],U=[],B=[],L=[],O=[],W=[],x=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e)return;var a=[];if(r){var i=c.hPV.toLocalPath(e,{transform:"absolute"});P.forEach(e=>{c.hPV.toLocalPath(e.path,{transform:"absolute"}).startsWith(i)&&a.push(e)})}else{var n=P.find(t=>c.hPV.isPathEqual(t.path,e));n&&a.push(n)}if(!!a.length)a.forEach(a=>{O.push({asset:a,pathInDraft:r?a.path:e,fsPath:c.hPV.toAbsolutePath(e),algorithmType:t})}),r&&W.push(e)},V=(e,t,r)=>{if(!!e){var n={pathInDraft:r?_().join("/",e):e,fsPath:c.hPV.toAbsolutePath(e),preloadMaterial:t},s=P.find(t=>c.hPV.isPathEqual(S(t.path),S(e)));if(s){var o=(0,i._)((0,a._)({},n),{asset:s,isVideoAlgorithmProduct:r});U.push(o)}else B.push(n)}},N=[...P.map(e=>e.path),...null!==(l=null==I?void 0:I.map(e=>e.path))&&void 0!==l?l:[]],H=e=>N.find(t=>c.hPV.isPathEqual(t,e));for(var G of b)p(G);for(var Q of I)f(Q);var j=0,z=function(e){var t,r,a,i,s,d,l,u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(j=Math.max(j,u),!(u>=100)){(null==e?void 0:null===(t=e.materials)||void 0===t?void 0:t.effects)&&Array.isArray(null==e?void 0:null===(r=e.materials)||void 0===r?void 0:r.effects)&&e.materials.effects.forEach(e=>{(null==e?void 0:e.type)==="figure"&&e.algorithm_artifact_path&&x(e.algorithm_artifact_path,n.Y.FigureBeauty,!0)}),(null==e?void 0:null===(a=e.materials)||void 0===a?void 0:a.smart_crops)&&Array.isArray(null==e?void 0:null===(i=e.materials)||void 0===i?void 0:i.smart_crops)&&e.materials.smart_crops.forEach(e=>{(null==e?void 0:e.cache_path)&&x(e.cache_path,n.Y.SmartCrop,!0)});var h=null==o?void 0:null===(s=o.mutable_config)||void 0===s?void 0:s.mutable_materials;h&&Array.isArray(h)&&h.forEach(e=>{(null==e?void 0:e.cover_path)&&V(e.cover_path,{id:"",schema:"",path:e.cover_path,meta_type:c.C3w.MetaTypePhoto,support_stream:!0,source_platform:0,app_id:0,material_id:"",source:0,intensifies_audio_path:"",video_algorithm_path:"",matrix_path:"",reverse_intensifies_path:"",reverse_path:"",ai_matting_path:""})}),(null==e?void 0:null===(d=e.materials)||void 0===d?void 0:d.drafts)&&Array.isArray(null==e?void 0:null===(l=e.materials)||void 0===l?void 0:l.drafts)&&e.materials.drafts.forEach(e=>{(null==e?void 0:e.draft)&&z(e.draft,u+1)})}};return z(o),{builtInMaterials:D,remainingBuiltInResources:A,onlineMaterials:F,unresolvedOnlineMaterials:C,everCloudMaterials:U,unresolvedEverCloudMaterials:B,quickImportMaterials:L,packageAssets:P,duplicatedBuiltinResourceMap:h(I),algorithmProductMaterials:O,folders:W,maxSubDraftDepth:j}}},577347:function(e,t,r){r.d(t,{M:()=>_});var a=r("85728"),i=r("929753"),n=r("196929"),s=r("882860"),o=r("427123"),d=r("954767"),l=r("657312"),u=r("2046"),c=r("474956"),h=r("487059"),p={[c._g.CurveHSL]:h.U_.CurveHSL,[c._g.Integration]:h.U_.Integration,[c._g.CurvePreset]:h.U_.CurveAdjustPreset,[c._g.VoiceChange]:h.U_.VoiceChange,[c._g.AISkeletonBody]:h.U_.Beauty2,[c._g.SkeletonBody]:h.U_.SkeletonBody,[c._g.TextTemplate]:h.U_.TextTemplate,[c._g.ShootProp]:h.U_.ShootProp,[c._g.Play]:h.U_.Play,[c._g.Beauty]:h.U_.Beauty,[c._g.AutoBeautyBody]:h.U_.AutoBeautyBody,[c._g.AutoBeautyShape]:h.U_.AutoBeautyShape,[c._g.AutoBeautyFace]:h.U_.AutoBeauty,[c._g.AutoBeautyMakeup]:h.U_.AutoBeautyMakeup,[c._g.Sticker]:h.U_.Default,[c._g.Effects]:h.U_.Effects,[c._g.FaceProp]:h.U_.FaceProp,[c._g.Tone]:h.U_.Tone,[c._g.Filter]:h.U_.Filter,[c._g.VideoBackground]:h.U_.Canvas,[c._g.TextPreset]:h.U_.Flower,[c._g.VideoMotion]:h.U_.Video,[c._g.TextMotion]:h.U_.Text,[c._g.StickerMotion]:h.U_.Sticker,[c._g.Transition]:h.U_.Transitions,[c._g.Mix]:h.U_.Mix,[c._g.Bubble]:h.U_.Bubble,[c._g.Font]:h.U_.Fonts,[c._g.SystemFonts]:h.U_.SystemFonts,[c._g.Mask]:h.U_.Videomask,[c._g.CurveSpeed]:h.U_.Curvespeed,[c._g.ShapeAnimation]:h.U_.ShapeAnimation,[c._g.Graffiti]:h.U_.Graffiti,[c._g.PathAnimation]:h.U_.PathAnimation,[c._g.AiAvatarMask]:h.U_.AiavatarMask,[c._g.Emoji]:h.U_.Emoji,[c._g.SmartColorAdjust]:h.U_.SmartColorAdjust,[c._g.TextGlow]:h.U_.TextGlow,[c._g.ObjectLock]:h.U_.ObjectLock,[c._g.MattingStroke]:h.U_.MattingStroke},_=(e,t)=>{if(null==e?void 0:e.heycan_item)return(0,n.L)((0,i._)((0,a._)({},null==e?void 0:e.heycan_item),{scheme:e.schema}),t);if(null==e?void 0:e.song_item)return(0,s.x)(e.song_item);if(null==e?void 0:e.giphy_item)return(0,o.T)(e.giphy_item);else if(null==e?void 0:e.loki_item)return e.loki_item.ResourceId.toString()===u.Rw.resourceId||"system-fonts"===e.loki_item.Panel?null:(0,d.$)(p,e.loki_item,t);else if(null==e?void 0:e.tuchong_item){var{effect_item:r}=e.tuchong_item;return(0,n.L)(r,t)}else if(null==e?void 0:e.brand_resource)return(0,l.f)(e.brand_resource);return null}},201544:function(e,t,r){r.d(t,{X:function(){return d}});var a=r(789786),i=r(567559),n=r(843698),s=r(874800),o=r(342875);class d extends s.JT{get onResourceErrorChange(){return this._onResourceErrorChange.event}hasInvalidUserMaterial(e){var t=this._draftPathStore.getResourceKeyFromDraftPath(e);return!t||!this._draftMaterialService.isMaterialExistByKey(t)}hasInvalidOnlineResources(e){return e.some(e=>this._errorResourceIdSet.has(e))}addErrorSegmentIds(e){for(var t of e)this._errorSegmentIdSet.add(t);this.triggerResourceErrorChange()}addErrorResourceIds(e){for(var t of e)this._errorResourceIdSet.add(t);this.triggerResourceErrorChange()}addErrorAssetId(e){if(!this._errorAssetIdSet.has(e))this._errorAssetIdSet.add(e),this.triggerResourceErrorChange()}isInvalidAsset(e){return this._errorAssetIdSet.has(e)}isInvalidStreamSegmentPath(e){var t=o.k92.getInstance().pathRecords.get(e);return!!o.k92.getInstance().streamRecords.get(t)&&this.isInvalidAsset(t)}removeErrorSegmentIds(e){for(var t of e)this._errorSegmentIdSet.delete(t);this.triggerResourceErrorChange()}triggerResourceErrorChange(){this._onResourceErrorChange.fire()}constructor(e,t){super(),this._draftPathStore=e,this._draftMaterialService=t,this._errorSegmentIdSet=new Set,this._errorResourceIdSet=new Set,this._errorAssetIdSet=new Set,this._onResourceErrorChange=this._store.add(new n.Q),this._store.add(t.onDidMaterialRemove(()=>{this.triggerResourceErrorChange()})),this._store.add(t.onDidMaterialReplace(()=>{this.triggerResourceErrorChange()}))}}d=(0,a.gn)([(0,a.fM)(1,i.D),(0,a.w6)("design:type",Function),(0,a.w6)("design:paramtypes",["undefined"==typeof DraftPathStore?Object:DraftPathStore,void 0===i.D?Object:i.D])],d)},586026:function(e,t,r){r.d(t,{Q5:()=>h,$8:()=>_,_k:()=>v,Aw:()=>u,yN:()=>c,$Q:()=>p});var a=r("876826"),i=r("793656"),n=r("146359"),s=r("342875"),o=r("665000"),d=r("474956"),l=r("361619");function u(e){var t=new Blob([e]);return URL.createObjectURL(t)}function c(e){return(0,s.hey)(e)?e.material.sourcePlatform===s.cvu.MaterialPlatformDefault:!!(0,s.Y9Q)(e)&&!e.material.musicId&&!e.material.effectId}function h(e,t){var r=d._g.Video,a=t.draftView.getSegmentById(e);if(!a)return r;var i=c(a);return(0,s.hey)(a)?r=(0,s.oP0)(a)?d._g.DigitalHuman:(0,s.ot2)(a)?d._g.UserPhoto:(0,s.duj)(a)&&a.materialDraft?d._g.VideoTemplate:a.material.type===s.cVg.MetaTypeGif?i?d._g.UserPhoto:d._g.Gif:a.material.type===s.cVg.MetaTypePhoto||a.material.type===s.cVg.MetaTypeImage?i?d._g.UserPhoto:d._g.Photo:i?d._g.UserVideo:d._g.Video:(0,s.Y9Q)(a)&&(r=i?d._g.UserAudio:d._g.Audio),r}function p(e,t){if("combination"===e.type||"mutablePoly"===e.type)return e.id;if((null===(r=e.materialDraft)||void 0===r?void 0:r.draft)&&"audio"===e.type)return function(e){var{draft:t}=e;if(!(null==t?void 0:t.tracks))return"";var r="",a=t.tracks.filter(e=>e.type===s.pNd.TrackTypeAudio);return(0,l.Z)(a,e=>!e.segments||e.segments.every(e=>!(r.length>1e3)&&((0,s.Y9Q)(e)&&(r+=e.material.path),!0))),r}(e.materialDraft);if("audio"===e.type||"mutableAudio"===e.type)return null!==(o=e.path)&&void 0!==o?o:"";var r,a,n,o,d,u,c=e.path;(0,i.gG)(e.mutable)?c=e.mutable.filled&&e.path?e.path:e.mutable.coverPath:(null===(n=e.digitalHuman)||void 0===n?void 0:null===(a=n.videoMeta)||void 0===a?void 0:a.path)&&e.materialDraft&&(c=null===(u=e.digitalHuman)||void 0===u?void 0:null===(d=u.videoMeta)||void 0===d?void 0:d.path);var h=t.getResourceKeyFromDraftPath(null!=c?c:"");return null!=h?h:""}function _(e){return f.apply(this,arguments)}function f(){return(f=(0,a._)(function*(e){if(!e)return 0n;var t=yield(0,o.Z)(e);return t.ok?n.h.secondToUs(t.value.duration):0n})).apply(this,arguments)}function v(e){return["video","audio","mutable","mutablePoly","mutableAudio","combination"].includes(e.type)&&!e.id.startsWith("empty-mutable-audio")&&"end-limit"!==e.id}},655281:function(e,t,r){r.d(t,{TF:function(){return n}});var a=r(457435),i=r(342875);function n(e,t){return i.pMA.times(e*t/a.zD,1e3,"bigint","round")}},708489:function(e,t,r){r.d(t,{o:function(){return a}});function a(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r}},109672:function(e,t,r){r.d(t,{OX:()=>c,r8:()=>d,E_:()=>o,Gk:()=>l});var a=r("85728"),i=r("929753"),n=r("708489");r("342875");var s=BigInt(Number.MAX_SAFE_INTEGER);function o(e){if(!e)return{width:0,height:1};if("imageData"in e){var{width:t,height:r}=e.imageData;return{width:t,height:r}}var{width:a=0,height:i=1}=e;return{width:a,height:i}}function d(e,t,r,a){if(r+a<e[t[0]].timestamp)return t[0];for(var i=s,n=t[0],o=t[0];o<t[1];o++){var d=r>=e[o].timestamp?r-e[o].timestamp:e[o].timestamp-r;if(d>i)break;r+a>e[o].timestamp&&(i=d,n=o)}return n}function l(e,t,r){return Math.min(Math.abs(r)/t*e.length,e.length-1)}function u(e,t){var{dx:r,dWidth:a,repeatCount:i}=e;return Math.min(Math.max(0,Math.floor((t-r)/a)),i-1)}function c(e,t,r,s,o,d,l,c,h,p,_,f){var v=l||(0,n.o)(t,r),g=v.getContext("2d");if(!g)return v;if(g.clearRect(0,0,t,r),o<0||d<o||0===t||0===r)return v;for(var m=[],y=o;y<=d;y++){var{source:S}=e[y];if(!!S){var M=e[y];if(y===o){var T=u(e[o],s);M=(0,i._)((0,a._)({},M),{startIndex:T})}else if(y===d){var k=u(e[d],s+t);M=(0,i._)((0,a._)({},M),{endIndex:k})}var I=y+1;I>=e.length&&(I=e.length-1);for(var w=function(e,t,r,a,i){for(var{source:n,dx:s,dy:o=0,dWidth:d,dHeight:l,repeatCount:u,startIndex:c=0,endIndex:h=u-1}=e,p=[],_=BigInt(h)-BigInt(c)+1n,f=(t-n.timestamp)/(_<=0n?1n:_),v=0n,g=c;g<=h;g++)if("imageData"in n)a.putImageData(n.imageData,s+Math.floor(d)*g-r,0,0,0,d,l);else if("image"in n){var{image:m,x:y=0,y:S=0,width:M,height:T}=n;if(a.drawImage(m,y,S,M,T,s+Math.floor(d)*g-r,o,d,l),g>c){var k=n.timestamp+f*v,I=Number(k)/1e6,w=null;if(i){for(var P of i.cache.keys())if(.1>=Math.abs(I-P)){w=i.get(P);break}}null!=w&&(a.fillStyle="#000000",a.fillRect(s+Math.floor(d)*g-r,o,d,l),a.drawImage(w.snapshot,s+Math.floor(d)*g-r,o)),null==w&&p.push(k)}v++}return p}(M,e[I].source.timestamp,s,g,h),P=0;P<w.length;P++)m.push(w[P])}}if(_&&p&&f&&c){if((m=[...new Set(m)]).length>0){for(var b=[],R=0;R<m.length;R++){var E=Number(m[R])/1e6;b.push(E)}c.genSnapshotFrame(_,p,m[0],m[m.length-1],b,!1,[e[0].dWidth,e[0].dHeight])}}return v}},936884:function(e,t,r){r.d(t,{JY:function(){return n},rO:function(){return s}});var a=r(971245),i=r(280166);function n(e){return 1===e.appSubType}var s=(0,a.LO)(i.Y)},827422:function(e,t,r){r.d(t,{n:function(){return n}});var a=r(971245),i=r(110850),n=(0,a.LO)(i.v)},53291:function(e,t,r){r.d(t,{_3:function(){return a}});var a=1},772218:function(e,t,r){r.d(t,{B:function(){return a}});var a=(0,r(971245).yh)("scheduler-service")},275863:function(e,t,r){r.d(t,{G:function(){return l}});var a=r(876826),i=r(85728),n=r(929753),s=r(700645),o=r(867713),d=r(874800);class l extends d.JT{_schedule(e){var t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],{cb:i,options:n}=e,d=this;(0,s.n)((t=(0,a._)(function*(e,t,r){yield Promise.resolve(i()),e.execute(()=>d._doNext(n.groupId,!1))}),function(e,r,a){return t.apply(this,arguments)}),{priorityLevel:r?o.q.ImmediatePriority:n.priorityLevel})}_doNext(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this._callbackQueueMap.get(e),a=this._groups.get(e);if(r&&a){var i=r.shift();if(!i||a.currentConcurrency>a.concurrency){a.currentConcurrency--;return}this._schedule(i,t)}}registerGroup(e){this._groups.set(e.groupId,(0,n._)((0,i._)({},e),{currentConcurrency:0}))}updateGroup(e,t){var r=this._groups.get(e);if(!!r){r=(0,n._)((0,i._)({},t),{currentConcurrency:r.currentConcurrency}),this._groups.set(e,r);var a=this._callbackQueueMap.get(e);if(a&&0!==a.length)for(;r.currentConcurrency<r.concurrency;){var s=a.shift();if(!s)break;this._schedule(s),r.currentConcurrency++}}}postTask(e,t){var r=this._groups.get(t.groupId);if(r){var a={cb:e,options:t};r.currentConcurrency<r.concurrency&&(this._schedule(a),r.currentConcurrency++);var i=this._callbackQueueMap.get(r.groupId);this._callbackQueueMap.set(r.groupId,[...null!=i?i:[],a])}}constructor(...e){super(...e),this._callbackQueueMap=new Map,this._groups=new Map}}}}]);